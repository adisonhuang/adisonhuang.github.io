
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="网站描述">
      
      
        <meta name="author" content="Adison">
      
      
        <link rel="canonical" href="https://adisonhuang.github.io/perf-opt/Android/bitmap/bitmap-from-birth-to-death/">
      
      
        <link rel="prev" href="../imge-format/">
      
      
        <link rel="next" href="../bitmap-memory/">
      
      <link rel="icon" href="../../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>Bitmap从出生到死亡 - Adison's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      
  
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');}</style>


    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-112420326-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");ga("send","event","feedback","click",t,e),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){ga("send","pageview",e.pathname)})});var e=document.createElement("script");e.async=!0,e.src="https://www.google-analytics.com/analytics.js",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bitmap" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="Adison&#39;s Blog" class="md-header__button md-logo" aria-label="Adison's Blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Adison's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Bitmap从出生到死亡
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="black"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../front-end/" class="md-tabs__link">
        大前端
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../" class="md-tabs__link md-tabs__link--active">
        Android性能优化
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../native/" class="md-tabs__link">
        Native
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../design/" class="md-tabs__link">
        设计&架构
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../interview/" class="md-tabs__link">
        面试
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../basic/" class="md-tabs__link">
        计算机基础
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tools/" class="md-tabs__link">
        开发工具
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../back-end/" class="md-tabs__link">
        后端&运维
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../game/" class="md-tabs__link">
        游戏开发
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../read/" class="md-tabs__link">
        读书笔记
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Adison&#39;s Blog" class="md-nav__button md-logo" aria-label="Adison's Blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    Adison's Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
          大前端
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          大前端
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/" class="md-nav__link">
        大前端
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
          Android
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2">
          <span class="md-nav__icon md-icon"></span>
          Android
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_1" id="__nav_1_2_1_label" tabindex="0">
          必知必会
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_1">
          <span class="md-nav__icon md-icon"></span>
          必知必会
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/Android_animation/" class="md-nav__link">
        Android 动画原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/handler/" class="md-nav__link">
        Android消息机制-Handler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/binder/" class="md-nav__link">
        解析Binder框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/dialog_token/" class="md-nav__link">
        Dialog 对应的 Context 必须是 Activity吗？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/apk_analyze/" class="md-nav__link">
        APK文件分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/bootloader/" class="md-nav__link">
        Android 开机流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/android-transform/" class="md-nav__link">
        Android Transform
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/asm-basic/" class="md-nav__link">
        ASM 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/ASM-Core-Api/" class="md-nav__link">
        ASM Core Api 详解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_2" id="__nav_1_2_2_label" tabindex="0">
          Kotlin
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_2">
          <span class="md-nav__icon md-icon"></span>
          Kotlin
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/koltin/Kotlin_nline%2C%20noinline%2C%20crossinline/" class="md-nav__link">
        Kotlin中inline, noinline, crossinline的区别
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/koltin/Kotlin-takeIf-or-takeUnless/" class="md-nav__link">
        使用Kotlin takeIf（或takeUnless）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/koltin/Mastering%20Kotlin%20standard%20functions/" class="md-nav__link">
        掌握Kotlin标准函数：run, with, let, also and apply
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_3" id="__nav_1_2_3_label" tabindex="0">
          并发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_3">
          <span class="md-nav__icon md-icon"></span>
          并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/thread-lifecycle/" class="md-nav__link">
        线程的生命周期，真的没那么简单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/process%20and%20thread/" class="md-nav__link">
        进程与线程的一个简单解释
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/basic/" class="md-nav__link">
        并发基础总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/thread-pool/" class="md-nav__link">
        线程池总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_4" id="__nav_1_2_4_label" tabindex="0">
          JVM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_4">
          <span class="md-nav__icon md-icon"></span>
          JVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/jvm/memory-area/" class="md-nav__link">
        Java 内存区域详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/jvm/jvm-garbage-collection/" class="md-nav__link">
        JVM 垃圾回收详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/Android_classloader/" class="md-nav__link">
        Android ClassLoader机制
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_5" id="__nav_1_2_5_label" tabindex="0">
          杂记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_5">
          <span class="md-nav__icon md-icon"></span>
          杂记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/flask_android_8/" class="md-nav__link">
        Mac10.14编译Android 8.1源码及刷入nexus 6p
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
      
      
      
        <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
          Flutter
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_3">
          <span class="md-nav__icon md-icon"></span>
          Flutter
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/flutter/tools/fvm/" class="md-nav__link">
        使用fvm管理多个版本flutter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/flutter/learn/Dart/" class="md-nav__link">
        Dart 简介
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Android性能优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Android性能优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        性能优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          内存优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          内存优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_memory_manager/" class="md-nav__link">
        Android内存管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_memory_tools/" class="md-nav__link">
        Android 内存分析工具(命令行)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_memory_tools_gc/" class="md-nav__link">
        Android 内存分析工具(查看GC)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/MAT-Startup/" class="md-nav__link">
        Android 内存分析工具(MAT入门)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/MAT-Advanced/" class="md-nav__link">
        Android 内存分析工具(MAT进阶)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_fd_leak/" class="md-nav__link">
        Android句柄泄漏分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/native-backtrace/" class="md-nav__link">
        Android Native 栈回溯
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/android-memory-gov/" class="md-nav__link">
        Android内存综合治理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          崩溃优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          崩溃优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/crash_op/" class="md-nav__link">
        Android 崩溃优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/native-catch/" class="md-nav__link">
        Android 平台 Native 代码的崩溃捕获机制及实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/native-crash-signal/" class="md-nav__link">
        native 崩溃信号介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/KillApplicationHandler/" class="md-nav__link">
        为啥Android子线程抛出异常主线程会崩溃
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          启动优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          启动优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../launch/Android-launch-opt/" class="md-nav__link">
        Android启动优化
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          包体积优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          包体积优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../size/Android-apk-size-opt/" class="md-nav__link">
        Android 包体积优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../size/douyin/" class="md-nav__link">
        从 Class 字节码入手精简 DEX 体积
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../size/Android-so-opt/" class="md-nav__link">
        Android对so体积优化的探索与实践
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
          卡顿优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          卡顿优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jank/jank-principle/" class="md-nav__link">
        Android卡顿掉帧问题分析之原理篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jank/jank-tool/" class="md-nav__link">
        Android卡顿掉帧问题分析之工具篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jank/jank-shizhan/" class="md-nav__link">
        Android卡顿掉帧问题分析之实战篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jank/jank-opt/" class="md-nav__link">
        Android卡顿优总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jank/cpu_use/" class="md-nav__link">
        Linux环境下进程的CPU占用率
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
          ANR优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          ANR优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/anr/" class="md-nav__link">
        ANR 原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/anr_monitor/" class="md-nav__link">
        ANR 监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/anr_trace/" class="md-nav__link">
        ANR 分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/sp/" class="md-nav__link">
        告别 SharedPreference 等待
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
          图片优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          图片优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        图片文件技术原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../imge-format/" class="md-nav__link">
        了解各种图形格式的编码方式
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Bitmap从出生到死亡
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Bitmap从出生到死亡
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 基本概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-bitmap" class="md-nav__link">
    2. Bitmap 总览
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-bitmap" class="md-nav__link">
    3. Bitmap 创建
  </a>
  
    <nav class="md-nav" aria-label="3. Bitmap 创建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    3.1. 资源转换
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    3.2. 内存分配
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    3.3. 图片解码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-java" class="md-nav__link">
    3.4. 创建Java对象
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4. 销毁
  </a>
  
    <nav class="md-nav" aria-label="4. 销毁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-recycle" class="md-nav__link">
    4.1. recycle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2. 自动释放
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5. 总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-80bitmap" class="md-nav__link">
    6. 8.0之前Bitmap内存分配原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    参考
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../bitmap-memory/" class="md-nav__link">
        Bitmap 内存占用分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../glide/" class="md-nav__link">
        Glide 核心知识
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
          网络优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          网络优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../net/net_opt/" class="md-nav__link">
        移动网络优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../net/okhttp/" class="md-nav__link">
        OKhttp 核心解析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
      
      
      
        <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
          基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Native-Hook/" class="md-nav__link">
        native-hook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../command/dumpsys/" class="md-nav__link">
        dumpsys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../command/top/" class="md-nav__link">
        top命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../net/log/" class="md-nav__link">
        线上疑难问题该如何排查和跟踪？
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Native
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Native
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/" class="md-nav__link">
        C&C++
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          C/C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          C/C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cbasic/" class="md-nav__link">
        C基础知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/C%2B%2Bbasic/" class="md-nav__link">
        C++基础知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/compilation-principle/" class="md-nav__link">
        编译原理基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/pointer%281%29/" class="md-nav__link">
        深度长文教你彻底掌握C++/C指针(一):基石
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/pointer%282%29/" class="md-nav__link">
        深度长文教你彻底掌握C++/C指针(二):指针和数组与字符串
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_auto/" class="md-nav__link">
        C++ auto类型推导完全攻略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_decltype/" class="md-nav__link">
        C++ decltype类型推导完全攻略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_nullptr/" class="md-nav__link">
        C++11 nullptr：初始化空指针
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_shared_ptr/" class="md-nav__link">
        C++11 shared_ptr智能指针
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
          JNI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          JNI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/JNI/JNI-op/" class="md-nav__link">
        JNI优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/JNI/Android-JNI/" class="md-nav__link">
        JNI使用总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          疑难问题
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          疑难问题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/__emutls_get_address/" class="md-nav__link">
        dlopen时找不到__emutls_get_address符号
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          设计&架构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          设计&架构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/" class="md-nav__link">
        设计 & 架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/framework%20design/" class="md-nav__link">
        架构设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/Design%20Principles/" class="md-nav__link">
        六大设计原则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/design-patterns/" class="md-nav__link">
        设计模式概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
          设计模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          设计模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_1" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_1" id="__nav_4_5_1_label" tabindex="0">
          创建型模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_1">
          <span class="md-nav__icon md-icon"></span>
          创建型模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/index_creational/" class="md-nav__link">
        概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/singleton/" class="md-nav__link">
        单例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/factory/" class="md-nav__link">
        工厂模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/prototype/" class="md-nav__link">
        原型模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/builder/" class="md-nav__link">
        建造者模式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_2" id="__nav_4_5_2_label" tabindex="0">
          结构型模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_2">
          <span class="md-nav__icon md-icon"></span>
          结构型模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/index_structural/" class="md-nav__link">
        概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/adapter/" class="md-nav__link">
        适配器模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/proxy/" class="md-nav__link">
        代理模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/facade/" class="md-nav__link">
        外观模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/wrapper/" class="md-nav__link">
        装饰模式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_3" id="__nav_4_5_3_label" tabindex="0">
          行为模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_3">
          <span class="md-nav__icon md-icon"></span>
          行为模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/index_behavioral/" class="md-nav__link">
        概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/strategy/" class="md-nav__link">
        策略模式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/summary/" class="md-nav__link">
        总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" >
      
      
      
        <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
          其他
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          其他
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/other/fail-fast%26fail-safe/" class="md-nav__link">
        fail-fast&fail-safe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/other/singleton_extra/" class="md-nav__link">
        各种单例写法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          面试
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          面试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/" class="md-nav__link">
        Android面试题题目
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
      
      
      
        <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
          Android
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Android
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_components/" class="md-nav__link">
        Android 四大组件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_screen/" class="md-nav__link">
        Android 屏幕适配
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_communication/" class="md-nav__link">
        Android 通信相关
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_view/" class="md-nav__link">
        Android 视图相关
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_event/" class="md-nav__link">
        Android 事件相关
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_sys/" class="md-nav__link">
        Android 系统原理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_basic/" class="md-nav__link">
        Java 基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_collection/" class="md-nav__link">
        Java 容器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_thread/" class="md-nav__link">
        Java 多线程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_jvm/" class="md-nav__link">
        Java JVM
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          计算机基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          计算机基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/" class="md-nav__link">
        计算机基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
          操作系统
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          操作系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/system/shell/" class="md-nav__link">
        shell核心语法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
          网络
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          网络
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/net/net/" class="md-nav__link">
        基础知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/net/5g/" class="md-nav__link">
        讲清楚5G
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
          数据结构与算法
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          数据结构与算法
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_1" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_1" id="__nav_6_4_1_label" tabindex="0">
          数组
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_1">
          <span class="md-nav__icon md-icon"></span>
          数组
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/array_algo_1/" class="md-nav__link">
        实现一个支持动态扩容的数组
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/array_algo_2/" class="md-nav__link">
        实现一个大小固定的有序数组，支持动态增删改操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/array_algo_3/" class="md-nav__link">
        合并两个有序数组
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_2" id="__nav_6_4_2_label" tabindex="0">
          链表
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_2">
          <span class="md-nav__icon md-icon"></span>
          链表
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/linklist_1/" class="md-nav__link">
        实现单链表、循环链表、双向链表，支持增删操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/linklist_lru/" class="md-nav__link">
        实现LRU缓存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/linklist_2/" class="md-nav__link">
        常见链表操作
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_3" id="__nav_6_4_3_label" tabindex="0">
          栈
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_3">
          <span class="md-nav__icon md-icon"></span>
          栈
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/stack_1/" class="md-nav__link">
        顺序栈、链式栈
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/stack_2/" class="md-nav__link">
        常见栈操作
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_4" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_4" id="__nav_6_4_4_label" tabindex="0">
          队列
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_4">
          <span class="md-nav__icon md-icon"></span>
          队列
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/queue/" class="md-nav__link">
        常见队列实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_5" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_5" id="__nav_6_4_5_label" tabindex="0">
          递归
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_5">
          <span class="md-nav__icon md-icon"></span>
          递归
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/recursive/" class="md-nav__link">
        常见递归算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_6" id="__nav_6_4_6_label" tabindex="0">
          排序与二分查找
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_6">
          <span class="md-nav__icon md-icon"></span>
          排序与二分查找
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/sort/" class="md-nav__link">
        常见排序算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/bsearch/" class="md-nav__link">
        二分查找算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_7" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_7" id="__nav_6_4_7_label" tabindex="0">
          散列表
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_7">
          <span class="md-nav__icon md-icon"></span>
          散列表
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/hashTable/" class="md-nav__link">
        常见散列表实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_8" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_8" id="__nav_6_4_8_label" tabindex="0">
          二叉树
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_8">
          <span class="md-nav__icon md-icon"></span>
          二叉树
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/tree/" class="md-nav__link">
        二叉查找树
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_9" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_9" id="__nav_6_4_9_label" tabindex="0">
          堆
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_9">
          <span class="md-nav__icon md-icon"></span>
          堆
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/heap/" class="md-nav__link">
        小顶堆、大顶堆、优先级队列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/heap_1/" class="md-nav__link">
        常见堆算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          开发工具
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          开发工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/" class="md-nav__link">
        开发工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
      
      
      
        <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
          GIT
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_2">
          <span class="md-nav__icon md-icon"></span>
          GIT
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/git/git_submodule/" class="md-nav__link">
        Git submodule 子模块的管理和使用
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
      
      
      
        <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
          VIM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_3">
          <span class="md-nav__icon md-icon"></span>
          VIM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/vim/vim-common/" class="md-nav__link">
        Vim常用命令
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          后端&运维
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          后端&运维
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/" class="md-nav__link">
        后端&运维
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
      
        <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/python_func_time/" class="md-nav__link">
        python函数执行时间分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/centos_flask/" class="md-nav__link">
        CentOS部署flask项目
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/pycharm_remote_debug/" class="md-nav__link">
        Pycharm远程调试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/PyCharm_root_debug/" class="md-nav__link">
        以Root权限运行/调试 PyCharm
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          游戏开发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          游戏开发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/" class="md-nav__link">
        游戏开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/perf/tools/" class="md-nav__link">
        Unity3D性能优化——工具篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/perf/cpu/" class="md-nav__link">
        Unity3D性能优化——CPU篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/perf/render/" class="md-nav__link">
        Unity3D性能优化——渲染篇
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          读书笔记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          读书笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/" class="md-nav__link">
        开卷有益
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/jvm/jvm/" class="md-nav__link">
        《深入理解java虚拟机》阅读笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_3" >
      
      
      
        <label class="md-nav__link" for="__nav_10_3" id="__nav_10_3_label" tabindex="0">
          《数据结构与算法之美》笔记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10_3">
          <span class="md-nav__icon md-icon"></span>
          《数据结构与算法之美》笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/Complexity%20Analysis/" class="md-nav__link">
        复杂度分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/array/" class="md-nav__link">
        数组
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/linked-list/" class="md-nav__link">
        链表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/stack/" class="md-nav__link">
        栈
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/queue/" class="md-nav__link">
        队列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/recursion/" class="md-nav__link">
        递归
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/basic_sort/" class="md-nav__link">
        基础排序算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/sort-advance/" class="md-nav__link">
        高级排序算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/sort-op/" class="md-nav__link">
        排序优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/bsearch/" class="md-nav__link">
        二分查找
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/skip-list/" class="md-nav__link">
        跳表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/hashmap/" class="md-nav__link">
        散列表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/hashalgo.md" class="md-nav__link">
        哈希算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/binary-tree/" class="md-nav__link">
        二叉树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/Red-Black-Tree/" class="md-nav__link">
        红黑树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/digui-tree/" class="md-nav__link">
        递归树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/heap/" class="md-nav__link">
        堆
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 基本概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-bitmap" class="md-nav__link">
    2. Bitmap 总览
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-bitmap" class="md-nav__link">
    3. Bitmap 创建
  </a>
  
    <nav class="md-nav" aria-label="3. Bitmap 创建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    3.1. 资源转换
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    3.2. 内存分配
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    3.3. 图片解码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-java" class="md-nav__link">
    3.4. 创建Java对象
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4. 销毁
  </a>
  
    <nav class="md-nav" aria-label="4. 销毁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-recycle" class="md-nav__link">
    4.1. recycle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2. 自动释放
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5. 总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-80bitmap" class="md-nav__link">
    6. 8.0之前Bitmap内存分配原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    参考
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="bitmap">Bitmap: 从出生到死亡<a class="headerlink" href="#bitmap" title="Permanent link">&para;</a></h1>
<h2 id="1">1. 基本概念<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>像素（<code>Pixel</code>）</strong>： 指可以表现亮度甚至色彩变化的一个点，是构成数字图像的最小单位。像素具有大小相同、明暗和颜色的变化。特点是有固定的位置和特定的颜色值。</p>
</li>
<li>
<p><strong><code>color depth</code>、<code>bit depth</code></strong>：每个像素RBG若各用8位表示，<code>bit depth</code>就是8bit，那么这个像素就用24位表示，<code>color depth</code>就是24bit。一个像素<code>color depth</code>越深，像素表达的颜色和亮度的位数越多，文件就越大。一个<code>color depth</code>中每个<code>channel</code>的深度就是<code>bit depth</code>。用32位表示一个像素的话，RBG占用24位，还有8位称为<code>alpha channel</code>。</p>
</li>
<li>
<p><strong><code>alpha composite</code>、<code>alpha blend</code>、<code>alpha channel</code></strong>： 渲染图片的时候，图片有时有很多图层，然后再将多个图层组合起来，这叫做<code>alpha composite</code>。在这个过程中，多个图层每个对应像素合成的过程叫做<code>alpha blend</code>。透过看到下一图层，就需要记录一些哪里透明、哪里不透明的信息，这些信息就被存在一个<code>alpha channel</code>中了。</p>
</li>
<li>
<p><strong>图片分辨率</strong>：计算机显示的图像是由像素点组成的，图片尺寸为640 x 480，代表图片水平有640个像素点，垂直有480像素点。</p>
</li>
</ul>
<blockquote>
<p>各种图片格式目的是在网络传输和存储的时候使用更少的字节，即起到压缩的作用，或者支持多张图片组合成一张动态图。在图片格式解码后，无论哪种图片的格式，图片数据都是像素数组。</p>
</blockquote>
<ul>
<li><strong>Bitmap</strong>：位图，又称为点阵图像、像素图或栅格图像，是由像素（图片元素）的单个点组成。这些点可以进行不同的排列和染色以构成图样。Bitmap的承载容器是<code>jpg</code>、<code>png</code>等格式的文件，是对bitmap的压缩。当jpg、png等文件需要展示在手机上的控件时，就会解析成Bitmap并绘制到view上。<blockquote>
<p>Bitmap同时也表示一种数据结构，用一个bit位来标记某个元素对应的Value， 而Key即是该元素。由于采用了Bit为单位来存储数据，因此在存储空间方面，可以大大节省。具体参见<a href="https://wizardforcel.gitbooks.io/the-art-of-programming-by-july/content/06.07.html">什么是Bit-map</a></p>
</blockquote>
</li>
</ul>
<h2 id="2-bitmap">2. Bitmap 总览<a class="headerlink" href="#2-bitmap" title="Permanent link">&para;</a></h2>
<p>App开发不可避免的要和图片打交道，由于其占用内存非常大，管理不当很容易导致内存不足，最后OOM，图片的背后其实是Bitmap，Bitmap 占内存多是因为其像素数据(pixels)大。Bitmap 像素数据的存储在不同 Android 版本之间有所不同，具体来说</p>
<table>
<thead>
<tr>
<th align="left">版本</th>
<th align="center">内存分布</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">~ Android 2.3.3(API 10)</td>
<td align="center">1. 位图的后备像素数据存储在 Native 堆中。Native 内存中的像素数据并不以可预测的方式释放，可能会导致应用短暂超出其内存限制并崩溃。 2. Android 2.2(API 8) 无并发垃圾回收功能, 当发生垃圾回收时，应用的线程会停止。这会导致延迟，从而降低性能。 3. Android 2.3 添加了并发垃圾回收功能，这意味着系统不再引用位图后，很快就会回收内存</td>
</tr>
<tr>
<td align="left">3.0（API 11）~ 7.1（API 25）</td>
<td align="center">像素数据会与关联的位图一起存储在 Dalvik/ART 堆上。</td>
</tr>
<tr>
<td align="left">8.0（API 26）~</td>
<td align="center">位图像素数据存储在 Native 堆中。配合 NativeAllocationRegistry 进行垃圾回收</td>
</tr>
</tbody>
</table>
<p><strong>没有特殊说明，下面涉及的内容都是基于8.0之后的版本。</strong></p>
<p>先从整体上看一下 Bitmap。
<a class="glightbox" href="../assets/68747470733a2f2f626c6f672d313235313638383530342e636f732e61702d7368616e676861692e6d7971636c6f75642e636f6d2f3230313930362f6269746d61702d6372656174696f6e2d617263682e706e67.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/68747470733a2f2f626c6f672d313235313638383530342e636f732e61702d7368616e676861692e6d7971636c6f75642e636f6d2f3230313930362f6269746d61702d6372656174696f6e2d617263682e706e67.png" /></a></p>
<ul>
<li>用户在手机屏幕上看到的是一张张图片</li>
<li>App 中这些图片实际上是 BitmapDrawable</li>
<li>BitmapDrawable 是对 Bitmap 的包装</li>
<li>Bitmap 是对 SkBitmap 的包装。具体说来， Bitmap 的具体实现包括 Java 层和 JNI 层，JNI 层依赖 <a href="https://github.com/google/skia">Skia</a>。</li>
<li>SkBitmap 本质上可简单理解为内存中的一个字节数组
  所以说 Bitmap 其实是一个字节数组, 本质上就是内存中的一块数据。所谓创建 Bitmap，不过是调用 malloc() 分配一块内存。而回收 Bitmap，不过是调用 free() 将之前的内存释放掉。</li>
</ul>
<p><strong>为什么 Android 2.3.3 中 Native 的内存释放不可预测？在 Java 对象的 finalize 被调用时直接释放的方案有何不妥?Android 8.0 的 NativeAllocationRegistry 的引入是为了解决什么问题?</strong></p>
<p>带着疑问，我们去了解下Bitmap其内存是如何被分配和销毁以及学习一下<code>NativeAllocationRegistry</code>的技术。</p>
<h2 id="3-bitmap">3. Bitmap 创建<a class="headerlink" href="#3-bitmap" title="Permanent link">&para;</a></h2>
<p>创建 Bitmap 的方式很多，</p>
<ul>
<li>可以通过 SDK 提供的 API 来创建 Bitmap</li>
<li>加载某些布局或资源时会创建 Bitmap</li>
<li><a href="https://github.com/bumptech/glide">Glide</a> 等第三方图片库会创建 Bitmap</li>
</ul>
<p>先说通过 API 创建 Bitmap。SDK 中创建 Bitmap 的 API 很多，分成三大类：</p>
<ul>
<li><strong>创建</strong> Bitmap - <code>Bitmap.createBitmap()</code> 方法在内存中从无到有地创建 Bitmap</li>
<li><strong>拷贝</strong> Bitmap - <code>Bitmap.copy()</code> 从已有的 Bitmap 拷贝出一个新的 Bitmap</li>
<li><strong>解码</strong> - 从文件或字节数组等资源解码得到 Bitmap，这是最常见的创建方式</li>
<li>BitmapFactory.decodeResource()</li>
<li><a href="https://developer.android.com/reference/android/graphics/ImageDecoder">ImageDecoder.decodeBitmap</a>。ImageDecoder 是 Android 9.0 新加的类</li>
</ul>
<p>假如 <code>resId</code> 对应的是一张图片。加载如下布局文件时会创建一个 Bitmap：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&lt;ImageView android:src=&quot;@drawable/resId&quot;&gt;
</code></pre></div>
<p>代码中加载资源也会创建出一个 Bitmap：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Drawable drawable = Resources.getDrawable(resId)
</code></pre></div>
<p>实际项目中往往不是直接调用 API 来创建 Bitmap，而是使用 <a href="https://github.com/bumptech/glide">Glide</a> 或 <a href="https://github.com/square/picasso">Picosso</a> 等第三方图片库。这些库成熟稳定，接口易用，开发中处理 Bitmap 变得轻松。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Glide.with(this).load(&quot;http://goo.gl/gEgYUd&quot;).into(imageView);
</code></pre></div>
<p>以 Glide 为例，只要一行代码可以很方便地从网络上加载一张图片。但另一方面，Glide 也让 Bitmap 的创建更加多样和复杂。</p>
<p>太多的创建 Bitmap 的方式，简直让人头大。但好在无论哪种创建方式，最终殊途同归。见下图：</p>
<p><a class="glightbox" href="../assets/bitmap-creation-overview.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/bitmap-creation-overview.png" /></a></p>
<p>Java 层的创建 Bitmap 的 <strong>所有 API</strong> 进入到 Native 层后，全都会走这四个步骤：</p>
<ul>
<li>资源转换 - 这一步将 Java 层传来的不同类型的资源转换成解码器可识别的数据类型</li>
<li>内存分配 - 这一步是分配内存，分配时会是否复用 Bitmap 等因素</li>
<li>图片解码 - 实际的解码工作由第三方库，解码结果填在上一步分配的内存中。注，<code>Bitmap.createBitmap()</code> 和 <code>Bitmap.copy()</code> 创建的 Bitmap 不需要进行图片解码</li>
<li>创建对象 - 这一步创建 Java 对象，将包含解码数据的内存块包装成 Java 层的 <code>android.graphics.Bitmap</code> 对象</li>
</ul>
<p>从上面可以 <a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/BitmapFactory.cpp#233">BitmapFactory.doDecode()</a> 函数是创建 Bitmap 的核心，它负责内存分配和图片解码，其关键步骤包括：</p>
<ol>
<li>Update with options supplied by the client.</li>
<li>Create the codec.</li>
<li>Handle sampleSize. (跟 BitmapFactory.Options.inSampleSize 参数相关)</li>
<li>Set the decode colorType.</li>
<li>Handle scale. (跟 BitmapFactory.Options.inScaled 参数相关)</li>
<li>Handle reuseBitmap (跟 BitmapFactory.Options.inBitmap 参数相关)</li>
<li>Choose decodeAllocator</li>
<li>Construct a color table</li>
<li>AllocPixels</li>
<li>Use SkAndroidCodec to perform the decode.</li>
<li>Create the java bitmap</li>
</ol>
<p>我们以<code>BitmapFactory#decodeFile</code>为例，简单看看bitmap创建过程。</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Bitmap</span><span class="w"> </span><span class="nf">decodeFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">pathName</span><span class="p">,</span><span class="w"> </span><span class="n">Options</span><span class="w"> </span><span class="n">opts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">            </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">pathName</span><span class="p">);</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">            </span><span class="n">bm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decodeStream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">);</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">            </span><span class="p">...</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bm</span><span class="p">;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Bitmap</span><span class="w"> </span><span class="nf">decodeStream</span><span class="p">(</span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">InputStream</span><span class="w"> </span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">Rect</span><span class="w"> </span><span class="n">outPadding</span><span class="p">,</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">            </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">Options</span><span class="w"> </span><span class="n">opts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">       </span><span class="p">...</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AssetManager</span><span class="p">.</span><span class="na">AssetInputStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">asset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">AssetManager</span><span class="p">.</span><span class="na">AssetInputStream</span><span class="p">)</span><span class="w"> </span><span class="n">is</span><span class="p">).</span><span class="na">getNativeAsset</span><span class="p">();</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">                </span><span class="n">bm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nativeDecodeAsset</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span><span class="w"> </span><span class="n">outPadding</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="n">Options</span><span class="p">.</span><span class="na">nativeInBitmap</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">                    </span><span class="n">Options</span><span class="p">.</span><span class="na">nativeColorSpace</span><span class="p">(</span><span class="n">opts</span><span class="p">));</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">             </span><span class="c1">// 假设是普通文件，调用到这里</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">                </span><span class="n">bm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decodeStreamInternal</span><span class="p">(</span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="n">outPadding</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">);</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bm</span><span class="p">;</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Bitmap</span><span class="w"> </span><span class="nf">decodeStreamInternal</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">InputStream</span><span class="w"> </span><span class="n">is</span><span class="p">,</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">            </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">Rect</span><span class="w"> </span><span class="n">outPadding</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">Options</span><span class="w"> </span><span class="n">opts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">        </span><span class="c1">// ASSERT(is != null);</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">        </span><span class="kt">byte</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="n">tempStorage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opts</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">tempStorage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opts</span><span class="p">.</span><span class="na">inTempStorage</span><span class="p">;</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tempStorage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">tempStorage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">DECODE_BUFFER_SIZE</span><span class="o">]</span><span class="p">;</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nativeDecodeStream</span><span class="p">(</span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="n">tempStorage</span><span class="p">,</span><span class="w"> </span><span class="n">outPadding</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">                </span><span class="n">Options</span><span class="p">.</span><span class="na">nativeInBitmap</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="w">                </span><span class="n">Options</span><span class="p">.</span><span class="na">nativeColorSpace</span><span class="p">(</span><span class="n">opts</span><span class="p">));</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/BitmapFactory.cpp#596">BitmapFactory.cpp</a>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="nf">nativeDecodeStream</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="n">jbyteArray</span><span class="w"> </span><span class="n">storage</span><span class="p">,</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">        </span><span class="n">jobject</span><span class="w"> </span><span class="n">padding</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="n">jobject</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="c1">// 1. 资源转换 Stream-&gt;SkStream-&gt;SkStreamRewindable</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SkStream</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">(</span><span class="n">CreateJavaInputStreamAdaptor</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="n">storage</span><span class="p">));</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SkStreamRewindable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bufferedStream</span><span class="p">(</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">                </span><span class="n">SkFrontBufferedStream</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span><span class="w"> </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">MinBufferedBytesNeeded</span><span class="p">()));</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span><span class="n">SkASSERT</span><span class="p">(</span><span class="n">bufferedStream</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">        </span><span class="n">bitmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doDecode</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">bufferedStream</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span><span class="w"> </span><span class="n">padding</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bitmap</span><span class="p">;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="p">}</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="k">static</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="nf">doDecode</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SkStreamRewindable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">                        </span><span class="n">jobject</span><span class="w"> </span><span class="n">padding</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">    </span><span class="p">...</span><span class="w">                    </span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">    </span><span class="c1">// 2.根据stream特点创建解码器</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">    </span><span class="n">NinePatchPeeker</span><span class="w"> </span><span class="n">peeker</span><span class="p">;</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SkAndroidCodec</span><span class="o">&gt;</span><span class="w"> </span><span class="n">codec</span><span class="p">;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">        </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">Result</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SkCodec</span><span class="o">&gt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">MakeFromStream</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">stream</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">                                                             </span><span class="o">&amp;</span><span class="n">peeker</span><span class="p">);</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="w">            </span><span class="n">SkString</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">            </span><span class="n">msg</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to create image decoder with message &#39;%s&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">                       </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">ResultToString</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">nullObjectReturn</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="w">        </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SkAndroidCodec</span><span class="o">::</span><span class="n">MakeFromCodec</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">nullObjectReturn</span><span class="p">(</span><span class="s">&quot;SkAndroidCodec::MakeFromCodec returned null&quot;</span><span class="p">);</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="w">     </span><span class="c1">// 3. 创建内存分配器</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="w">    </span><span class="n">HeapAllocator</span><span class="w"> </span><span class="n">defaultAllocator</span><span class="p">;</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a><span class="w">    </span><span class="n">RecyclingPixelAllocator</span><span class="w"> </span><span class="n">recyclingAllocator</span><span class="p">(</span><span class="n">reuseBitmap</span><span class="p">,</span><span class="w"> </span><span class="n">existingBufferSize</span><span class="p">);</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="w">    </span><span class="n">ScaleCheckingAllocator</span><span class="w"> </span><span class="n">scaleCheckingAllocator</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="w"> </span><span class="n">existingBufferSize</span><span class="p">);</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="w">    </span><span class="n">SkBitmap</span><span class="o">::</span><span class="n">HeapAllocator</span><span class="w"> </span><span class="n">heapAllocator</span><span class="p">;</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="w">    </span><span class="n">SkBitmap</span><span class="o">::</span><span class="n">Allocator</span><span class="o">*</span><span class="w"> </span><span class="n">decodeAllocator</span><span class="p">;</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">javaBitmap</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">willScale</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="w">        </span><span class="c1">// This will allocate pixels using a HeapAllocator, since there will be an extra</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="w">        </span><span class="c1">// scaling step that copies these pixels into Java memory.  This allocator</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a><span class="w">        </span><span class="c1">// also checks that the recycled javaBitmap is large enough.</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="w">        </span><span class="n">decodeAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">scaleCheckingAllocator</span><span class="p">;</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">javaBitmap</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="w">        </span><span class="n">decodeAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">recyclingAllocator</span><span class="p">;</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">willScale</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isHardware</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a><span class="w">        </span><span class="c1">// This will allocate pixels using a HeapAllocator,</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="w">        </span><span class="c1">// for scale case: there will be an extra scaling step.</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a><span class="w">        </span><span class="c1">// for hardware case: there will be extra swizzling &amp; upload to gralloc step.</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a><span class="w">        </span><span class="n">decodeAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">heapAllocator</span><span class="p">;</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a><span class="w">        </span><span class="n">decodeAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">defaultAllocator</span><span class="p">;</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a><span class="w">   </span><span class="p">...</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="w">    </span><span class="c1">// 4. 分配内存</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a><span class="w">    </span><span class="n">SkBitmap</span><span class="w"> </span><span class="n">decodingBitmap</span><span class="p">;</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">setInfo</span><span class="p">(</span><span class="n">bitmapInfo</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a><span class="w">            </span><span class="o">!</span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">tryAllocPixels</span><span class="p">(</span><span class="n">decodeAllocator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a><span class="w">   </span><span class="c1">// 5. 图片解码</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a><span class="w">    </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">getAndroidPixels</span><span class="p">(</span><span class="n">decodeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">getPixels</span><span class="p">(),</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="w">            </span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">rowBytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">codecOptions</span><span class="p">);</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SkCodec</span><span class="o">::</span><span class="no">kSuccess</span><span class="p">:</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SkCodec</span><span class="o">::</span><span class="no">kIncompleteInput</span><span class="p">:</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">nullObjectReturn</span><span class="p">(</span><span class="s">&quot;codec-&gt;getAndroidPixels() failed.&quot;</span><span class="p">);</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a><span class="w">   </span><span class="p">...</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a><span class="w">    </span><span class="c1">// 6. 创建java对象</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bitmap</span><span class="o">::</span><span class="n">createBitmap</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">defaultAllocator</span><span class="p">.</span><span class="n">getStorageObjAndReset</span><span class="p">(),</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a><span class="w">            </span><span class="n">bitmapCreateFlags</span><span class="p">,</span><span class="w"> </span><span class="n">ninePatchChunk</span><span class="p">,</span><span class="w"> </span><span class="n">ninePatchInsets</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>下面详细展开描述下</strong></p>
<h3 id="31">3.1. 资源转换<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<p>在 JNI 层将Java 层的待解码资源（包含<code>File</code>,<code>Resource</code>,<code>ByteArray</code>,<code>Stream</code>,<code>FileDescriptor</code>）重新划分成四种，包括：<code>DecodeFileDescriptor</code>,<code>DecodeStream</code>,<code>DecodeByteArray</code>,<code>DecodeAsset</code></p>
<p><code>BitmapFactory</code> 提供四个方法对资源进行转换，所有的资源都会转换成与 <code>SkStreamRewindable</code> 兼容的数据</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">nativeDecodeFileDescriptor</span><span class="p">()</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">nativeDecodeStream</span><span class="p">()</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">nativeDecodeByteArray</span><span class="p">()</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">nativeDecodeAsset</span><span class="p">()</span>
</code></pre></div>
<p><a class="glightbox" href="../assets/bitmap-creation-convert-resource.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/bitmap-creation-convert-resource.png" /></a></p>
<p>最后，<a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/BitmapFactory.cpp#233">BitmapFactory.doDecode()</a> 统一解码处理 <code>SkStreamRewindable</code>。</p>
<h3 id="32">3.2. 内存分配<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<p>解码前的第二项工作是内存分配。</p>
<p>首先是选择 <code>decodeAllocator</code> (见上文提到的 <code>BitmapFactory.doDecode()</code> 的第7步)。有以下几种 Allocator 可供选择：</p>
<p><a class="glightbox" href="../assets/bitmap-createion-allocator-classes.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/bitmap-createion-allocator-classes.png" /></a></p>
<p>选择 Allocator 时考虑的因素包括：是否复用已有 Bitmap，是否会缩放 Bitmap，是否是 Hardware Bitmap。选择策略总结如下：</p>
<table>
<thead>
<tr>
<th>是否复用已有 Bitmap</th>
<th>是否会缩放 Bitmap</th>
<th>是否是 Hardware Bitmap</th>
<th>Allocator类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>是</td>
<td>是</td>
<td>-</td>
<td><a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/BitmapFactory.cpp#144">ScaleCheckingAllocator</a></td>
</tr>
<tr>
<td>是</td>
<td>否</td>
<td>-</td>
<td><a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/GraphicsJNI.h#171">RecyclingPixelAllocator</a></td>
</tr>
<tr>
<td>否</td>
<td>是</td>
<td>是</td>
<td><a href="https://github.com/google/skia/blob/master/include/core/SkBitmap.h#L1119">SkBitmap::HeapAllocator</a></td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td><a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/GraphicsJNI.h#125">HeapAllocator</a> (缺省的Allocator)</td>
</tr>
</tbody>
</table>
<p>接下来，使用选定的 Allocator 分配内存。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>BitmapFactory.doDecode() -&gt;
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    SkBitmap.tryAllocPixels() -&gt;
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>            Allocator.allocPixelRef()
</code></pre></div>
<p>代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">// BitmapFactory.cpp</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">static</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="nf">doDecode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="n">SkBitmap</span><span class="w"> </span><span class="n">decodingBitmap</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">setInfo</span><span class="p">(</span><span class="n">bitmapInfo</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">            </span><span class="o">!</span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">tryAllocPixels</span><span class="p">(</span><span class="n">decodeAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">colorTable</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">        </span><span class="c1">// SkAndroidCodec should recommend a valid SkImageInfo, so setInfo()</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">        </span><span class="c1">// should only only fail if the calculated value for rowBytes is too</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">        </span><span class="c1">// large.</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">        </span><span class="c1">// tryAllocPixels() can fail due to OOM on the Java heap, OOM on the</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">        </span><span class="c1">// native heap, or the recycled javaBitmap being too small to reuse.</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="p">}</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="c1">// SkBitmap.cpp https://github.com/google/skia/blob/master/src/core/SkBitmap.cpp#L213</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">SkBitmap::tryAllocPixels</span><span class="p">(</span><span class="n">Allocator</span><span class="o">*</span><span class="w"> </span><span class="n">allocator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="n">HeapAllocator</span><span class="w"> </span><span class="n">stdalloc</span><span class="p">;</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">nullptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allocator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">        </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stdalloc</span><span class="p">;</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">allocator</span><span class="o">-&gt;</span><span class="n">allocPixelRef</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="p">}</span>
</code></pre></div>
<p>Allocator 的类型有四种，我们只看其中的两种。</p>
<ul>
<li>
<p><strong>先看 <code>SkBitmap::HeapAllocator</code> 作为 Allocator 进行内存分配的流程。</strong></p>
</li>
<li>
<p><a href="https://github.com/google/skia/blob/master/src/core/SkBitmap.cpp#L213">SkBitmap::tryAllocPixels</a></p>
</li>
<li><a href="https://github.com/google/skia/blob/master/src/core/SkBitmap.cpp#L368">SkBitmap::HeapAllocator::allocPixelRef</a></li>
<li><a href="https://github.com/google/skia/blob/master/src/core/SkMallocPixelRef.cpp#L57">SkMallocPixelRef::MakeAllocate</a></li>
<li><a href="https://github.com/google/skia/blob/master/include/private/SkMalloc.h#L66">sk_calloc_canfail</a></li>
<li><a href="https://github.com/google/skia/blob/master/src/ports/SkMemory_malloc.cpp#L66">sk_malloc_flags</a></li>
</ul>
<p>对应的代码如下(可以看到最终会调用 <code>malloc()</code> 分配指定大小的内存)：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// SkMallocPixelRef.cpp</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">SkPixelRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SkMallocPixelRef</span><span class="o">::</span><span class="n">MakeAllocate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">SkImageInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sk_calloc_canfail</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="p">}</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="c1">// SkMalloc.h</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">sk_calloc_canfail</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="cp">#if defined(IS_FUZZING_WITH_LIBFUZZER)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="c1">// The Libfuzzer environment is very susceptible to OOM, so to avoid those</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">    </span><span class="c1">// just pretend we can&#39;t allocate more than 200kb.</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">200000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="cp">#endif</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sk_malloc_flags</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">SK_MALLOC_ZERO_INITIALIZE</span><span class="p">);</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="p">}</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="c1">// SkMemory_malloc.cpp</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">sk_malloc_flags</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SK_MALLOC_ZERO_INITIALIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SK_MALLOC_THROW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">throw_on_failure</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="p">}</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a><span class="cm">/** We explicitly use the same allocator for our pixels that SkMask does,</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="cm"> so that we can freely assign memory allocated by one class to the other.</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="cm"> */</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="kt">bool</span><span class="w"> </span><span class="n">SkBitmap</span><span class="o">::</span><span class="n">HeapAllocator</span><span class="o">::</span><span class="n">allocPixelRef</span><span class="p">(</span><span class="n">SkBitmap</span><span class="o">*</span><span class="w"> </span><span class="n">dst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SkImageInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">();</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kUnknown_SkColorType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">colorType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="c1">//        SkDebugf(&quot;unsupported config for info %d\n&quot;, dst-&gt;config());</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="w">    </span><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">SkPixelRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SkMallocPixelRef</span><span class="o">::</span><span class="n">MakeAllocate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">rowBytes</span><span class="p">());</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="w">    </span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">setPixelRef</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">pr</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="w">    </span><span class="n">SkDEBUGCODE</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">validate</span><span class="p">();)</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="p">}</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="kt">void</span><span class="w"> </span><span class="n">SkBitmap</span><span class="o">::</span><span class="n">setPixelRef</span><span class="p">(</span><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">SkPixelRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a><span class="w">    </span><span class="n">fPixelRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kUnknown_SkColorType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">colorType</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">rowBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rowBytes</span><span class="p">();</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="w">    </span><span class="c1">// ignore dx,dy if there is no pixelref</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fPixelRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">        </span><span class="n">rowBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fPixelRef</span><span class="o">-&gt;</span><span class="n">rowBytes</span><span class="p">();</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="w">        </span><span class="c1">// TODO(reed):  Enforce that PixelRefs must have non-null pixels.</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fPixelRef</span><span class="o">-&gt;</span><span class="n">pixels</span><span class="p">();</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rowBytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">bytesPerPixel</span><span class="p">();</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a><span class="w">    </span><span class="n">SkPixmapPriv</span><span class="o">::</span><span class="n">ResetPixmapKeepInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fPixmap</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">);</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p><strong>再来看 <code>HeapAllocator</code> 作为 Allocator 进行内存分配的流程。</strong></p>
</li>
<li>
<p><a href="https://github.com/google/skia/blob/master/src/core/SkBitmap.cpp#L213">SkBitmap::tryAllocPixels</a></p>
</li>
<li><a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/Graphics.cpp#616">HeapAllocator::allocPixelRef</a></li>
<li><a href="https://android.googlesource.com/platform/frameworks/base/+/master/libs/hwui/hwui/Bitmap.cpp#79">android::Bitmap::allocateHeapBitmap</a></li>
</ul>
<p>对应的代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">// GraphicsJNI.h https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/GraphicsJNI.h#125</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">HeapAllocator</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">SkBRDAllocator</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">   </span><span class="n">HeapAllocator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="o">~</span><span class="n">HeapAllocator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">allocPixelRef</span><span class="p">(</span><span class="n">SkBitmap</span><span class="o">*</span><span class="w"> </span><span class="n">bitmap</span><span class="p">,</span><span class="w"> </span><span class="n">SkColorTable</span><span class="o">*</span><span class="w"> </span><span class="n">ctable</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="cm">     * Fetches the backing allocation object. Must be called!</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="cm">     */</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="n">android</span><span class="o">::</span><span class="n">Bitmap</span><span class="o">*</span><span class="w"> </span><span class="nf">getStorageObjAndReset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mStorage</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">ZeroInitialized</span><span class="w"> </span><span class="nf">zeroInit</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">kYes_ZeroInitialized</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="k">private</span><span class="o">:</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">    </span><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">android</span><span class="o">::</span><span class="n">Bitmap</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mStorage</span><span class="p">;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="p">};</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="c1">// Graphics.cpp https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/Graphics.cpp#616</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">HeapAllocator::allocPixelRef</span><span class="p">(</span><span class="n">SkBitmap</span><span class="o">*</span><span class="w"> </span><span class="n">bitmap</span><span class="p">,</span><span class="w"> </span><span class="n">SkColorTable</span><span class="o">*</span><span class="w"> </span><span class="n">ctable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">   </span><span class="c1">// 创建 Native Bitmap 对象，并将指针记录到 HeapAllocator#mStorage 字段中</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">    </span><span class="n">mStorage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="o">::</span><span class="n">Bitmap</span><span class="o">::</span><span class="n">allocateHeapBitmap</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span><span class="w"> </span><span class="n">ctable</span><span class="p">);</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">!!</span><span class="n">mStorage</span><span class="p">;</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="p">}</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="c1">// Bitmap.cpp https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/libs/hwui/hwui/Bitmap.cpp#86</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="k">static</span><span class="w"> </span><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allocateHeapBitmap</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">SkImageInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">   </span><span class="c1">// 使用库函数 calloc 分配 size*1 的连续空间</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">   </span><span class="c1">// 创建 Native Bitmap 对象</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Bitmap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">));</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="p">}</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="n">Bitmap</span><span class="o">::</span><span class="n">Bitmap</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">SkImageInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">,</span><span class="w"> </span><span class="n">SkColorTable</span><span class="o">*</span><span class="w"> </span><span class="n">ctable</span><span class="p">)</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="n">SkPixelRef</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="n">mPixelStorageType</span><span class="p">(</span><span class="n">PixelStorageType</span><span class="o">::</span><span class="n">Heap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">    </span><span class="c1">// 指向像素数据的内存指针</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">    </span><span class="n">mPixelStorage</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">    </span><span class="c1">// 像素数据大小</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">    </span><span class="n">mPixelStorage</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="w">    </span><span class="n">reconfigure</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">,</span><span class="w"> </span><span class="n">ctable</span><span class="p">);</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="p">}</span>
</code></pre></div>
<p>对于 <code>RecyclingPixelAllocator</code> 和 <code>ScaleCheckingAllocator</code> 的情况，读者可以自行分析。</p>
<p>无论哪种 Allocator，最终要么调用 <code>malloc()</code> 分配内存，要么复用之前分配的内存。分配/复用完成后，由 <code>SkBitmap</code> 来持有。</p>
<p>注：</p>
<ul>
<li>准确来说，<code>SkBitmap::HeapAllocator</code> 分配内存由 <a href="https://github.com/google/skia/blob/master/src/core/SkPixmap.cpp">SkBitmap 的 SkPixmap</a> 持有，而不是 SkBitmap 持有。忽略这个细节</li>
<li>准确来说，<code>HeapAllocator</code> 分配的内存是由 <code>android::Bitmap.mStorage</code> 持有，而不是 SkBitmap 持有。但 <code>android::Bitmap</code> 与 SkBitmap 有某种关联，所以可以忽略这个细节</li>
</ul>
<h3 id="33">3.3. 图片解码<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<p>在 Skia 中 <code>SkCodec</code> 代表解码器，解码器的类层次结构如下：</p>
<p><a class="glightbox" href="../assets/bitmap_codec.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/bitmap_codec.png" /></a></p>
<p>Skia 将实际的解码工作交由第三方库，不同图片格式有各自对应的解码器。比如 PNG 图片由 <code>SkPngCodec</code> 解码，而 <code>SkPngCodec</code> 实际上是对 libpng 的封装。</p>
<p>前面提到 <code>BitmapFactory.doDecode()</code> 的第2步是创建解码器，第10步是调用该解码器进行解码。</p>
<ul>
<li><a href="https://github.com/google/skia/blob/master/src/codec/SkCodec.cpp#L70">SkCodec::MakeFromStream()</a> 根据图片格式选择一个合适的 <code>SkCodec</code>，比如为 PNG 图片选择 <code>SkPngCodec</code></li>
<li><a href="https://github.com/google/skia/blob/master/src/codec/SkAndroidCodec.cpp#L78">SkAndroidCodec::MakeFromStream()</a> 创建 <code>SkAndroidCodec</code>， 它是上一步创建的 <code>SkCodec</code> 的代理。<code>SkAndroidCodec</code> 的具体类型跟图片格式有关。PNG，JPEG，GIF，BMP 等格式时其类型是 <code>SkSampledCodec</code>，WEBP 格式时是 <code>SkAndroidCodecAdapter</code></li>
<li>调用 <a href="https://github.com/google/skia/blob/master/src/codec/SkAndroidCodec.cpp#L357">SkAndroidCodec.getAndroidPixels()</a> 解码</li>
</ul>
<p>代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">static</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="nf">doDecode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">getAndroidPixels</span><span class="p">(</span><span class="n">decodeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">getPixels</span><span class="p">(),</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">            </span><span class="n">decodingBitmap</span><span class="p">.</span><span class="n">rowBytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">codecOptions</span><span class="p">);</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="p">}</span>
</code></pre></div>
<p>以 PNG 图片为例来分析。</p>
<p>首先，对于 PNG 图片 <code>codec</code> 是 <code>SkSampledCodec</code>， <code>SkSampledCodec</code> 使用的解码器是 <code>SkPngCodec</code> (见 <code>SkAndroidCodec.fCodec</code> 字段)。</p>
<p><a class="glightbox" href="../assets/bitmap-creation-decode.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/bitmap-creation-decode.png" /></a></p>
<p>第一步是调用 <code>codec-&gt;getAndroidPixels()</code> 方法。注意第二个参数正是上一步分配的内存地址。</p>
<p>接下来是一系列函数调用。注意传入的内存地址参数 <code>dst</code> 即可，其他细节忽略。</p>
<p>然后会执行到 <code>SkPngCodec.onGetPixels()</code> 方法。它使用 <a href="http://www.libpng.org/pub/png/libpng.html">libpng 库</a>解码 PNG 图片。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">SkCodec</span><span class="o">::</span><span class="n">Result</span><span class="w"> </span><span class="nf">SkPngCodec::onGetPixels</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">SkImageInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">dstInfo</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">                                        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Options</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">,</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">                                        </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">rowsDecoded</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="n">Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">initializeXforms</span><span class="p">(</span><span class="n">dstInfo</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kSuccess</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">fSubset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">kUnimplemented</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">allocateStorage</span><span class="p">(</span><span class="n">dstInfo</span><span class="p">);</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">initializeXformParams</span><span class="p">();</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">decodeAllRows</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">,</span><span class="w"> </span><span class="n">rowsDecoded</span><span class="p">);</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="p">}</span>
</code></pre></div>
<p>最终，解码结果保存在 <code>dst</code> 指针指向的内存。</p>
<h3 id="34-java">3.4. 创建Java对象<a class="headerlink" href="#34-java" title="Permanent link">&para;</a></h3>
<p>解码完成后得到 Native 层的 <code>SkBitmap</code> 对象，最后一步工作是将其封装成 Java 层可以使用的 <code>Bitmap</code> 对象。</p>
<p>这一步的过程相对简单，分为三步：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>BitmapFactory.doDecode() -&gt;
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    Bitmap.createBitmap() -&gt;
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>            Java Bitmap 的构造方法中保存 `mNativePtr` (像素数据内存块的地址)
</code></pre></div>
<p>对应的代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">// BitmapFactory.cpp</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">static</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="nf">doDecode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="n">SkBitmap</span><span class="w"> </span><span class="n">decodingBitmap</span><span class="p">;</span><span class="w">    </span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="n">SkCodec</span><span class="o">::</span><span class="n">Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="n">SkBitmap</span><span class="w"> </span><span class="n">outputBitmap</span><span class="p">;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="n">outputBitmap</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">decodingBitmap</span><span class="p">);</span><span class="w">                </span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="c1">// now create the java bitmap</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bitmap</span><span class="o">::</span><span class="n">createBitmap</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">defaultAllocator</span><span class="p">.</span><span class="n">getStorageObjAndReset</span><span class="p">(),</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">            </span><span class="n">bitmapCreateFlags</span><span class="p">,</span><span class="w"> </span><span class="n">ninePatchChunk</span><span class="p">,</span><span class="w"> </span><span class="n">ninePatchInsets</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span><span class="w">    </span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="p">}</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="c1">// Bitmap.cpp</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="n">jobject</span><span class="w"> </span><span class="nf">createBitmap</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">Bitmap</span><span class="o">*</span><span class="w"> </span><span class="n">bitmap</span><span class="p">,</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bitmapCreateFlags</span><span class="p">,</span><span class="w"> </span><span class="n">jbyteArray</span><span class="w"> </span><span class="n">ninePatchChunk</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">ninePatchInsets</span><span class="p">,</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">density</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isMutable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitmapCreateFlags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">kBitmapCreateFlag_Mutable</span><span class="p">;</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isPremultiplied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitmapCreateFlags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">kBitmapCreateFlag_Premultiplied</span><span class="p">;</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="c1">// The caller needs to have already set the alpha type properly, so the</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">    </span><span class="c1">// native SkBitmap stays in sync with the Java Bitmap.</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="n">assert_premultiplied</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(),</span><span class="w"> </span><span class="n">isPremultiplied</span><span class="p">);</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">    </span><span class="n">BitmapWrapper</span><span class="o">*</span><span class="w"> </span><span class="n">bitmapWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BitmapWrapper</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">    </span><span class="n">jobject</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">gBitmap_class</span><span class="p">,</span><span class="w"> </span><span class="n">gBitmap_constructorMethodID</span><span class="p">,</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">            </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bitmapWrapper</span><span class="p">),</span><span class="w"> </span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">(),</span><span class="w"> </span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">(),</span><span class="w"> </span><span class="n">density</span><span class="p">,</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">            </span><span class="n">isMutable</span><span class="p">,</span><span class="w"> </span><span class="n">isPremultiplied</span><span class="p">,</span><span class="w"> </span><span class="n">ninePatchChunk</span><span class="p">,</span><span class="w"> </span><span class="n">ninePatchInsets</span><span class="p">);</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">        </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;*** Uncaught exception returned from Java call!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">        </span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionDescribe</span><span class="p">();</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">// Bitmap.java</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Bitmap</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Parcelable</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="c1">// Convenience for JNI access</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mNativePtr</span><span class="p">;</span><span class="w">    </span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="cm">     * Private constructor that must received an already allocated native bitmap</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="cm">     * int (pointer).</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="cm">     */</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="c1">// called from JNI</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="n">Bitmap</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">nativeBitmap</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">density</span><span class="p">,</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isMutable</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">requestPremultiplied</span><span class="p">,</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ninePatchChunk</span><span class="p">,</span><span class="w"> </span><span class="n">NinePatch</span><span class="p">.</span><span class="na">InsetStruct</span><span class="w"> </span><span class="n">ninePatchInsets</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nativeBitmap</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;internal error: native bitmap is 0&quot;</span><span class="p">);</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">        </span><span class="n">mNativePtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nativeBitmap</span><span class="p">;</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">        </span><span class="p">...</span><span class="w">        </span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="p">}</span>
</code></pre></div>
<p>至此，Java 层的 <code>Bitmap</code> 对象创建完毕，它在内存中大致是这样的：</p>
<p><a class="glightbox" href="../assets/bitmap-creation-ref-relationship.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/bitmap-creation-ref-relationship.png" /></a></p>
<h2 id="4">4. 销毁<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>Java 层的 Bitmap 对象有点特别，特别之处在于其像素数据保存在 native heap。我们知道， native heap 并不被 JVM 管理，那如何保证 Bitmap 对象本身被 GC 后 native heap 中的内存也能正确回收呢？</p>
<h3 id="41-recycle">4.1. recycle<a class="headerlink" href="#41-recycle" title="Permanent link">&para;</a></h3>
<p>首先想到的是在代码主动调用 <a href="https://developer.android.com/reference/android/graphics/Bitmap.html">Bitmap.recycle()</a> 方法来释放 native 内存。</p>
<p>流程如下：</p>
<p><a class="glightbox" href="../assets/bitmap-creation-free-mem.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/bitmap-creation-free-mem.png" /></a></p>
<p>来看具体代码。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="cm">     * Free the native object associated with this bitmap, and clear the</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="cm">     * reference to the pixel data. This will not free the pixel data synchronously;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="cm">     * it simply allows it to be garbage collected if there are no other references.</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="cm">     * The bitmap is marked as &quot;dead&quot;, meaning it will throw an exception if</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="cm">     * getPixels() or setPixels() is called, and will draw nothing. This operation</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="cm">     * cannot be reversed, so it should only be called if you are sure there are no</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="cm">     * further uses for the bitmap. This is an advanced call, and normally need</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="cm">     * not be called, since the normal GC process will free up this memory when</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="cm">     * there are no more references to this bitmap.</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="cm">     */</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recycle</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mRecycled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mNativePtr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nativeRecycle</span><span class="p">(</span><span class="n">mNativePtr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">                </span><span class="c1">// return value indicates whether native pixel object was actually recycled.</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">                </span><span class="c1">// false indicates that it is still in use at the native level and these</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">                </span><span class="c1">// objects should not be collected now. They will be collected later when the</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">                </span><span class="c1">// Bitmap itself is collected.</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">                </span><span class="n">mNinePatchChunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">            </span><span class="n">mRecycled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">// Bitmap.cpp https://android.googlesource.com/platform/frameworks/base/+/refs/heads/oreo-release/core/jni/android/graphics/Bitmap.cpp#872</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">static</span><span class="w"> </span><span class="n">jboolean</span><span class="w"> </span><span class="nf">Bitmap_recycle</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="p">,</span><span class="w"> </span><span class="n">jlong</span><span class="w"> </span><span class="n">bitmapHandle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">LocalScopedBitmap</span><span class="w"> </span><span class="n">bitmap</span><span class="p">(</span><span class="n">bitmapHandle</span><span class="p">);</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">freePixels</span><span class="p">();</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">JNI_TRUE</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="p">}</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="c1">// Convenience class that does not take a global ref on the pixels, relying</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="c1">// on the caller already having a local JNI ref</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">LocalScopedBitmap</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">LocalScopedBitmap</span><span class="p">(</span><span class="n">jlong</span><span class="w"> </span><span class="n">bitmapHandle</span><span class="p">)</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="n">mBitmapWrapper</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">BitmapWrapper</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">bitmapHandle</span><span class="p">))</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">    </span><span class="n">BitmapWrapper</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mBitmapWrapper</span><span class="p">;</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pixels</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mBitmapWrapper</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">().</span><span class="n">pixels</span><span class="p">();</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">valid</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mBitmapWrapper</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mBitmapWrapper</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">();</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="k">private</span><span class="o">:</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">    </span><span class="n">BitmapWrapper</span><span class="o">*</span><span class="w"> </span><span class="n">mBitmapWrapper</span><span class="p">;</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="p">};</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">BitmapWrapper</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">    </span><span class="n">BitmapWrapper</span><span class="p">(</span><span class="n">Bitmap</span><span class="o">*</span><span class="w"> </span><span class="n">bitmap</span><span class="p">)</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">mBitmap</span><span class="p">(</span><span class="n">bitmap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">freePixels</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="w">        </span><span class="n">mInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBitmap</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">();</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="w">        </span><span class="n">mHasHardwareMipMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBitmap</span><span class="o">-&gt;</span><span class="n">hasHardwareMipMap</span><span class="p">();</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="w">        </span><span class="n">mAllocationSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBitmap</span><span class="o">-&gt;</span><span class="n">getAllocationByteCount</span><span class="p">();</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="w">        </span><span class="n">mRowBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBitmap</span><span class="o">-&gt;</span><span class="n">rowBytes</span><span class="p">();</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="w">        </span><span class="n">mGenerationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBitmap</span><span class="o">-&gt;</span><span class="n">getGenerationID</span><span class="p">();</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="w">        </span><span class="n">mIsHardware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBitmap</span><span class="o">-&gt;</span><span class="n">isHardware</span><span class="p">();</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">        </span><span class="n">mBitmap</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="w">    </span><span class="cm">/** Resets to its initial state; all fields are set to zero, as if SkBitmap had</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="cm">        been initialized by SkBitmap().</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="cm">        Sets width, height, row bytes to zero; pixel address to nullptr; SkColorType to</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="cm">        kUnknown_SkColorType; and SkAlphaType to kUnknown_SkAlphaType.</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="cm">        If SkPixelRef is allocated, its reference count is decreased by one, releasing</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="cm">        its memory if SkBitmap is the sole owner.</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="cm">    */</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">        </span><span class="n">fPixelRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w">  </span><span class="c1">// Free pixels.</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="n">fPixmap</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">        </span><span class="n">fFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">        </span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<ul>
<li>首先，App 主动调用 <code>Bitmap.recycle()</code> 方法</li>
<li>接下来，<code>Bitmap.recycle()</code> 调用对应的 native 方法 <code>Bitmap_recycle()</code></li>
<li>然后会进入到 <code>BitmapWrapper.freePixels()</code> 方法</li>
<li>最后，<a href="https://github.com/google/skia/blob/master/include/core/SkBitmap.h#L334">SkBitmap.reset()</a> 将 <code>fPixelRef</code> 置空。注：之前分配内存过程中可以看到 <code>fPixelRef</code> 是如何被赋值的</li>
</ul>
<p><code>fPixelRef</code> 原本指向一个 <code>SkMallocPixelRef</code> 对象。将 <code>fPixelRef</code> 置空后，该对象引用数变成0时，<code>~SkMallocPixelRef()</code> 析构方法被调用，并触发 <a href="https://github.com/google/skia/blob/master/src/core/SkMallocPixelRef.cpp#L33">sk_free_releaseproc()</a> 方法执行，回收内存。</p>
<p>注意这里的 <code>sk_free_releaseproc</code>。 它是方法地址，在之前的分配内存过程中作为 <code>SkMallocPixelRef()</code> 构造方法的 <code>SkMallocPixelRef::ReleaseProc</code> 参数被传进来的。<code>sk_free_releaseproc</code> 指向的方法负责最终的内存回收。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">// SkMemory_malloc.cpp https://github.com/google/skia/blob/master/src/ports/SkMemory_malloc.cpp#L66</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sk_free</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="p">}</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1">// SkMallocPixelRef.cpp https://github.com/google/skia/blob/master/src/core/SkMallocPixelRef.cpp#L33</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="c1">// assumes ptr was allocated via sk_malloc</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sk_free_releaseproc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="n">sk_free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="p">}</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="c1">// SkMallocPixelRef.cpp https://github.com/google/skia/blob/master/src/core/SkMallocPixelRef.cpp#L57</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">SkPixelRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SkMallocPixelRef</span><span class="o">::</span><span class="n">MakeAllocate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">SkImageInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sk_calloc_canfail</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">nullptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sk_sp</span><span class="o">&lt;</span><span class="n">SkPixelRef</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SkMallocPixelRef</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">rowBytes</span><span class="p">,</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">                                                  </span><span class="n">sk_free_releaseproc</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">));</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="p">}</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="c1">// SkMallocPixelRef.cpp https://github.com/google/skia/blob/master/src/core/SkMallocPixelRef.cpp#L133</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="n">SkMallocPixelRef</span><span class="o">::~</span><span class="n">SkMallocPixelRef</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fReleaseProc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">        </span><span class="n">fReleaseProc</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">pixels</span><span class="p">(),</span><span class="w"> </span><span class="n">fReleaseProcContext</span><span class="p">);</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="p">}</span>
</code></pre></div>
<h3 id="42">4.2. 自动释放<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<p>实际上现在的 Android 应用中多数场景代码不主动调用 <code>recycle()</code>， native 内存也能正确回收。这是为何？秘密在于 <a href="https://android.googlesource.com/platform/libcore/+/master/luni/src/main/java/libcore/util/NativeAllocationRegistry.java">NativeAllocationRegistry</a>。</p>
<blockquote>
<p>NativeAllocationRegistry 用于将 native 内存跟 Java 对象关联，并将它们注册到 Java 运行时。注册 Java 对象关联的 native 内存有几个好处：</p>
<ul>
<li>Java 运行时在 GC 调度时可考虑 native 内存状态</li>
<li>Java 运行时在 Java 对象变得不可达时可以使用用户提供的函数来自动清理 native 内存</li>
</ul>
</blockquote>
<p>来看代码。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="w">     </span><span class="c1">// Bitmap 对象无法直接 new, 其创建流程, 我们已经分析过了</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="n">Bitmap</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">nativeBitmap</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">density</span><span class="p">,</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isMutable</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">requestPremultiplied</span><span class="p">,</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ninePatchChunk</span><span class="p">,</span><span class="w"> </span><span class="n">NinePatch</span><span class="p">.</span><span class="na">InsetStruct</span><span class="w"> </span><span class="n">ninePatchInsets</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nativeBitmap</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;internal error: native bitmap is 0&quot;</span><span class="p">);</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">        </span><span class="n">mWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">;</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">        </span><span class="n">mHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">;</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">        </span><span class="n">mIsMutable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isMutable</span><span class="p">;</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">        </span><span class="n">mRequestPremultiplied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestPremultiplied</span><span class="p">;</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">        </span><span class="n">mNinePatchChunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ninePatchChunk</span><span class="p">;</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">        </span><span class="n">mNinePatchInsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ninePatchInsets</span><span class="p">;</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">density</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">            </span><span class="n">mDensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">density</span><span class="p">;</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">        </span><span class="c1">// 1. 保存 Native 层对应的 SkiaBitmap 的句柄值</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">        </span><span class="n">mNativePtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nativeBitmap</span><span class="p">;</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">nativeSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NATIVE_ALLOCATION_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">getAllocationByteCount</span><span class="p">();</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">        </span><span class="c1">// 2. nativeGetNativeFinalizer 获取 Native 的 Finalizer.</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">        </span><span class="c1">// 3. 创建 NativeAllocationRegistry 对象</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">        </span><span class="n">NativeAllocationRegistry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NativeAllocationRegistry</span><span class="p">(</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w">            </span><span class="n">Bitmap</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="n">nativeGetNativeFinalizer</span><span class="p">(),</span><span class="w"> </span><span class="n">nativeSize</span><span class="p">);</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w">        </span><span class="c1">// 4. 注册这个 java 对象和 native 对象</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">registerNativeAllocation</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">nativeBitmap</span><span class="p">);</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="w">        </span><span class="p">......</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="w">    </span><span class="c1">// 获取 Native 的 Finalizer</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">nativeGetNativeFinalizer</span><span class="p">();</span><span class="w">      </span>
</code></pre></div>
<p>Bitmap 创建之后, 其构造函数内部的操作如下</p>
<ul>
<li>nativeGetNativeFinalizer 获取 native 层的 Finalizer</li>
<li>实例化 NativeAllocationRegistry</li>
<li>通过 NativeAllocationRegistry.registerNativeAllocation 监听这个 Java 和 Native 对象</li>
</ul>
<p>当 Java 层 Bitmap 对象不可达后关联的 native 内存会由 <code>nativeGetNativeFinalizer()</code> 指定的方法来回收，流程如下：</p>
<p><a class="glightbox" href="https://blog-1251688504.cos.ap-shanghai.myqcloud.com/201906/bitmap-creation-free-native-mem.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://blog-1251688504.cos.ap-shanghai.myqcloud.com/201906/bitmap-creation-free-native-mem.png" /></a></p>
<ul>
<li><strong>获取 native 层的 Finalizer</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">android</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">bitmap</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">Bitmap_destruct</span><span class="p">(</span><span class="n">BitmapWrapper</span><span class="o">*</span><span class="w"> </span><span class="n">bitmap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">      </span><span class="k">delete</span><span class="w"> </span><span class="n">bitmap</span><span class="p">;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">  </span><span class="c1">// 这里把 Bitmap_destruct 函数地址转为 long 类型的句柄值返回给 Java 层</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">jlong</span><span class="w"> </span><span class="nf">Bitmap_getNativeFinalizer</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Bitmap_destruct</span><span class="p">));</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="p">}</span>
</code></pre></div>
<p>native 层的 Finalizer 即 Bitmap_destruct 函数, 有了这个函数, 我们便可以快速的回收 native 的 BitmapWrapper 内存了</p>
<ul>
<li><strong>NativeAllocationRegistry 的创建</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>public class NativeAllocationRegistry {
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    private final ClassLoader classLoader;
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    private final long freeFunction;
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    private final long size;
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    public NativeAllocationRegistry(ClassLoader classLoader, long freeFunction, long size) {
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>        if (size &lt; 0) {
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>            throw new IllegalArgumentException(&quot;Invalid native allocation size: &quot; + size);
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        }
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        this.classLoader = classLoader;
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>        this.freeFunction = freeFunction;
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>        this.size = size;
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    }
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>}
</code></pre></div>
<p>NativeAllocationRegistry 的构造函数, 即将形参保存到了成员变量, 并没有做多余的初始化操作, 下面看看它的 registerNativeAllocation 方法</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>public class NativeAllocationRegistry {
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>   public Runnable registerNativeAllocation(Object referent, long nativePtr) {
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>          ......
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>          CleanerThunk thunk;
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>          CleanerRunner result;
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>          try {
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>              // 1. 创建 native 内存块清理器 CleanerThunk
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>              thunk = new CleanerThunk();
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>              // 2. 创建清理者, 持有 Java 引用和 thunk
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>              Cleaner cleaner = Cleaner.create(referent, thunk);
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>              // 3 .创建 Runner 交由外界主动触发清理操作
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>              result = new CleanerRunner(cleaner);
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>              // 4.1 通知 Runtime 分配了 size 大小的内存空间
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>              registerNativeAllocation(this.size);
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>          } catch (VirtualMachineError vme /* probably OutOfMemoryError */) {
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>              // 4.2 注册失败, 释放 native 的内存
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>              applyFreeFunction(freeFunction, nativePtr);
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>              throw vme;
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>          } // Other exceptions are impossible.
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>          // 5. 让 ClearThunk 绑定 Native 的对象的句柄
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>          thunk.setNativePtr(nativePtr);
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>          return result;
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>      }
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>      private class CleanerThunk implements Runnable {
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>          private long nativePtr;
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>          public CleanerThunk() {
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>              this.nativePtr = 0;
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>          }
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>          public void run() {
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>              if (nativePtr != 0) {
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>                  // 释放 Native 对象
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>                  applyFreeFunction(freeFunction, nativePtr);
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>                  // 通知 Runtime 释放了 size 大小的 Native 内存
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>                  registerNativeFree(size);
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>              }
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>          }
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>          public void setNativePtr(long nativePtr) {
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>              this.nativePtr = nativePtr;
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>          }
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>      }
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>      private static class CleanerRunner implements Runnable {
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>          private final Cleaner cleaner;
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a>          public CleanerRunner(Cleaner cleaner) {
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a>              this.cleaner = cleaner;
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>          }
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a>
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a>          public void run() {
<a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a>              // 执行 cleaner 的 clean 操作
<a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>              cleaner.clean();
<a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a>          }
<a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a>      }
<a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a>
<a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a>      // 通知 Runtime 分配了 size 大小的 Native 内存
<a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>      private static void registerNativeAllocation(long size) {
<a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a>          VMRuntime.getRuntime().registerNativeAllocation((int)Math.min(size, Integer.MAX_VALUE));
<a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a>      }
<a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a>
<a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a>      // 通知 Runtime 释放了 size 大小的 Native 内存
<a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a>      private static void registerNativeFree(long size) {
<a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a>          VMRuntime.getRuntime().registerNativeFree((int)Math.min(size, Integer.MAX_VALUE));
<a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a>      }
<a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a>
<a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a>      // 通过构造时传入的 freeFunction 释放内存
<a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a>      public static native void applyFreeFunction(long freeFunction, long nativePtr);
<a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a>}
</code></pre></div>
<p>可以看到 registerNativeAllocation 方法中主要操作如下</p>
<ul>
<li>创建 Native 内存清理器 CleanerThunk</li>
<li>持有 native 对象指针和 freeFunction</li>
<li>创建清理者 Cleaner 它负责监听 Java 对象引用状态, 被 GC 时自动触发 CleanerThunk 的内存释放</li>
<li>有些类似于之前我们在对象的 finalize 中释放 Native 内存</li>
<li>创建成功, 调用 VMRuntime.registerNativeAllocation, 注册 Native 分配的内存大小</li>
<li>创建失败, 直接通过 applyFreeFunction 释放 Native 对象</li>
</ul>
<p>这里我们主要关注一下 Cleaner 是如何自动处理 Native 对象释放的, 以及 Runtime.registerNativeAllocation 的操作</p>
<ul>
<li><strong>Cleaner 的创建</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>  public class Cleaner
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>      extends PhantomReference&lt;Object&gt;
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>  {
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>      // 虚引用的引用队列无实际意义, 用于构造函数传入
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>      private static final ReferenceQueue&lt;Object&gt; dummyQueue = new ReferenceQueue&lt;&gt;();
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>      // 双向链表的头结点
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>      static private Cleaner first = null;
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>      // 前驱&amp;后继指针
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>      private Cleaner
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>          next = null,
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>          prev = null;
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>      //
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>      private static synchronized Cleaner add(Cleaner cl) {
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>          if (first != null) {
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>              cl.next = first;
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>              first.prev = cl;
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>          }
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>          first = cl;
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>          return cl;
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>      }
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>      private static synchronized boolean remove(Cleaner cl) {
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>          // If already removed, do nothing
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>          if (cl.next == cl)
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>              return false;
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>          // Update list
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>          if (first == cl) {
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>              if (cl.next != null)
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>                  first = cl.next;
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>              else
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>                  first = cl.prev;
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>          }          if (cl.next != null)
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>              cl.next.prev = cl.prev;
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>          if (cl.prev != null)
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>              cl.prev.next = cl.next;
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>          // Indicate removal by pointing the cleaner to itself
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>          cl.next = cl;
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>          cl.prev = cl;
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>          return true;
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>      }
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>      // 清理回调
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>      private final Runnable thunk;
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>      // 构造
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a>      private Cleaner(Object referent, Runnable thunk) {
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>          super(referent, dummyQueue);
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a>          this.thunk = thunk;
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>      }
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>      /**
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a>       * Creates a new cleaner.
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a>       *
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a>       * @param  ob the referent object to be cleaned
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a>       * @param  thunk
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>       *         The cleanup code to be run when the cleaner is invoked.  The
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a>       *         cleanup code is run directly from the reference-handler thread,
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>       *         so it should be as simple and straightforward as possible.
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a>       *
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a>       * @return  The new cleaner
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a>       */
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>      public static Cleaner create(Object ob, Runnable thunk) {
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a>          if (thunk == null)
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a>              return null;
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a>          return add(new Cleaner(ob, thunk));
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a>      }
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a>      /**
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a>       * Runs this cleaner, if it has not been run before.
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a>       */
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a>      public void clean() {
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>          if (!remove(this))
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a>              return;
<a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a>          try {
<a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a>              thunk.run();
<a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a>          } catch (final Throwable x) {
<a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a>              AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {
<a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a>                      public Void run() {
<a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a>                          if (System.err != null)
<a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a>                              new Error(&quot;Cleaner terminated abnormally&quot;, x)
<a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a>                                  .printStackTrace();
<a id="__codelineno-23-90" name="__codelineno-23-90" href="#__codelineno-23-90"></a>                          System.exit(1);
<a id="__codelineno-23-91" name="__codelineno-23-91" href="#__codelineno-23-91"></a>                          return null;
<a id="__codelineno-23-92" name="__codelineno-23-92" href="#__codelineno-23-92"></a>                      }});
<a id="__codelineno-23-93" name="__codelineno-23-93" href="#__codelineno-23-93"></a>          }
<a id="__codelineno-23-94" name="__codelineno-23-94" href="#__codelineno-23-94"></a>      }
<a id="__codelineno-23-95" name="__codelineno-23-95" href="#__codelineno-23-95"></a>
<a id="__codelineno-23-96" name="__codelineno-23-96" href="#__codelineno-23-96"></a>  }
</code></pre></div>
<p>Cleaner 对象是一个双向链表的结点, 最终在内存中组成一个 Cleaner 双向链表, 通过 Cleaner.clean 方法, 会触发 Cleaner 的 thunk.run 执行真正的清理操作</p>
<p>Cleaner 的构造函数中有如下的注释</p>
<p>The cleanup code is run directly from the reference-handler thread, so it should be as simple and straightforward as possible.</p>
<p>从注释中可以看出, 这个 Cleaner.clean 方法由 引用处理线程 直接回调的, 并且提示我们不要让 thunk.run 执行耗时操作</p>
<p><strong>看到这里我们大概就能够明白, 为什么 Bitmap 中找不到 finalize 方法, 也能释放 Native 内存了, 因为一个 Bitmap 对象会被包装成 Cleaner, 成为 Cleaner 链表中的一员, 它的清理操作由 引用处理线程 直接回调 Cleaner.clean 执行数据清理, 同样能够及时释放内存</strong></p>
<ul>
<li><strong>VMRuntime.registerNativeAllocation</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>public final class VMRuntime {
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>      /**
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>       * Holds the VMRuntime singleton.
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>       */
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>      private static final VMRuntime THE_ONE = new VMRuntime();
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>      /**
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>       * Returns the object that represents the VM instance&#39;s Dalvik-specific
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>       * runtime environment.
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>       *
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>       * @return the runtime object
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>       */
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>      public static VMRuntime getRuntime() {
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>          return THE_ONE;
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>      }
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>      /**
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>       * Registers a native allocation so that the heap knows about it and performs GC as required.
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>       * If the number of native allocated bytes exceeds the native allocation watermark, the
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>       * function requests a concurrent GC. If the native bytes allocated exceeds a second higher
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>       * watermark, it is determined that the application is registering native allocations at an
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>       * unusually high rate and a GC is performed inside of the function to prevent memory usage
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>       * from excessively increasing.
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>       */
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>      public native void registerNativeAllocation(int bytes);
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>}
</code></pre></div>
<p>这里的 registerNativeAllocation 是一个 native 方法, 它的实现定义在 dalvik_system_VMRuntime.cc 中下面我们看看它的实现</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">// android-9.0.0_r3/art/runtime/native/dalvik_system_VMRuntime.cc</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">art</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">  </span><span class="p">......</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">VMRuntime_registerNativeAllocation</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UNLIKELY</span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">      </span><span class="n">ScopedObjectAccess</span><span class="w"> </span><span class="nf">soa</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">      </span><span class="n">ThrowRuntimeException</span><span class="p">(</span><span class="s">&quot;allocation size negative %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="c1">// 将记录 Native 分配的内存的操作, 交由 ART 的 Heap 执行</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">    </span><span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetHeap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">RegisterNativeAllocation</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bytes</span><span class="p">));</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">  </span><span class="p">......</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="p">}</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="c1">// android-9.0.0_r3/art/runtime/gc/heap.cc</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">art</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">gc</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">  </span><span class="p">......</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">Heap</span><span class="o">::</span><span class="n">RegisterNativeAllocation</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">    </span><span class="c1">// 交由 new_native_bytes_allocated_ 原子类累加 Native 对象分配的内存</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">old_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_native_bytes_allocated_</span><span class="p">.</span><span class="n">FetchAndAddRelaxed</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">    </span><span class="c1">// 判断 Native 分配的内存是否触发了 GC 阈值, 超过了则进行 GC 操作释放 Java 和 Native 内存</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">NativeAllocationGcWatermark</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HeapGrowthMultiplier</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">               </span><span class="o">!</span><span class="n">IsGCRequestPending</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">      </span><span class="c1">// Trigger another GC because there have been enough native bytes</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">      </span><span class="c1">// allocated since the last GC.</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsGcConcurrent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="w">        </span><span class="n">RequestConcurrentGC</span><span class="p">(</span><span class="n">ThreadForEnv</span><span class="p">(</span><span class="n">env</span><span class="p">),</span><span class="w"> </span><span class="n">kGcCauseForNativeAlloc</span><span class="p">,</span><span class="w"> </span><span class="cm">/*force_full*/</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="w">        </span><span class="n">CollectGarbageInternal</span><span class="p">(</span><span class="n">NonStickyGcType</span><span class="p">(),</span><span class="w"> </span><span class="n">kGcCauseForNativeAlloc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a><span class="w">  </span><span class="p">......</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="p">}</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="p">}</span>
</code></pre></div>
<p>Native 层的实现比较简单, 它将 Native 分配的内存进行累加, 当 Java 对象持有的 Native 内存超过了阈值, 则进行 GC 操作</p>
<p>这里看到阈值的是由 <strong>NativeAllocationGcWatermark() * HeapGrowthMultiplier()</strong> 组成, 下面探究一下 Native 内存 GC 阈值的值</p>
<ul>
<li><strong>注册 Native 内存触发虚拟机 GC 的阈值计算</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1">// android-9.0.0_r3/art/runtime/gc/heap.h</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Heap</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w"> </span><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">  </span><span class="c1">// 计算 Native 分配内存的乘数</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">foreground_heap_growth_multiplier_</span><span class="p">;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">  </span><span class="c1">// 计算 Native 内存阈值</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">max_free_</span><span class="p">;</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">  </span><span class="n">ALWAYS_INLINE</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">NativeAllocationGcWatermark</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">max_free_</span><span class="p">;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="p">}</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="c1">// android-9.0.0_r3/art/runtime/gc/heap.cc</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="kt">double</span><span class="w"> </span><span class="n">Heap</span><span class="o">::</span><span class="n">HeapGrowthMultiplier</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">  </span><span class="c1">// 不考虑后台暂停时长, 乘数则直接返回 1.0, 这样 Native 触发 GC 的阈值较少, GC 会更频繁</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CareAboutPauseTimes</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">  </span><span class="c1">// 默认使用 foreground_heap_growth_multiplier_</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">foreground_heap_growth_multiplier_</span><span class="p">;</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="p">}</span>
</code></pre></div>
<p>这里并没有具体的赋值, Heap 的创建是在 Runtime::Init 中执行的, 我们看看这个两个数据注入的是多少</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1">// android-9.0.0_r3/art/runtime/runtime.cc</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">kExtraDefaultHeapGrowthMultiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kUseReadBarrier</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Runtime::Init</span><span class="p">(</span><span class="n">RuntimeArgumentMap</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">runtime_options_in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">  </span><span class="p">......</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">foreground_heap_growth_multiplier</span><span class="p">;</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_low_memory_mode_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">runtime_options</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">ForegroundHeapGrowthMultiplier</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">   </span><span class="c1">// 若为低内存设备, 乘数为 1.0</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">   </span><span class="n">foreground_heap_growth_multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">   </span><span class="c1">// 从 runtime_options 取值</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">   </span><span class="n">foreground_heap_growth_multiplier</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">       </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">ForegroundHeapGrowthMultiplier</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">           </span><span class="n">kExtraDefaultHeapGrowthMultiplier</span><span class="p">;</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">  </span><span class="n">heap_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">gc</span><span class="o">::</span><span class="n">Heap</span><span class="p">(</span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">MemoryInitialSize</span><span class="p">),</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">HeapGrowthLimit</span><span class="p">),</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">HeapMinFree</span><span class="p">),</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">                         </span><span class="c1">// 这里注入了 max_free_</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">HeapMaxFree</span><span class="p">),</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">HeapTargetUtilization</span><span class="p">),</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">                         </span><span class="c1">// 阈值乘数</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">                         </span><span class="n">foreground_heap_growth_multiplier</span><span class="p">,</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">MemoryMaximumSize</span><span class="p">),</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">NonMovingSpaceCapacity</span><span class="p">),</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">Image</span><span class="p">),</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">ImageInstructionSet</span><span class="p">),</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">                         </span><span class="c1">// Override the collector type to CC if the read barrier config.</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">                         </span><span class="n">kUseReadBarrier</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">gc</span><span class="o">::</span><span class="n">kCollectorTypeCC</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">collector_type_</span><span class="p">,</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w">                         </span><span class="n">kUseReadBarrier</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">BackgroundGcOption</span><span class="p">(</span><span class="n">gc</span><span class="o">::</span><span class="n">kCollectorTypeCCBackground</span><span class="p">)</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w">                                         </span><span class="o">:</span><span class="w"> </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">BackgroundGc</span><span class="p">),</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">LargeObjectSpace</span><span class="p">),</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">LargeObjectThreshold</span><span class="p">),</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">ParallelGCThreads</span><span class="p">),</span>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">ConcGCThreads</span><span class="p">),</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">LowMemoryMode</span><span class="p">),</span>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">LongPauseLogThreshold</span><span class="p">),</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">LongGCLogThreshold</span><span class="p">),</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">IgnoreMaxFootprint</span><span class="p">),</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">UseTLAB</span><span class="p">),</span>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">verify_pre_gc_heap_</span><span class="p">,</span>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">verify_pre_sweeping_heap_</span><span class="p">,</span>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">verify_post_gc_heap_</span><span class="p">,</span>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">verify_pre_gc_rosalloc_</span><span class="p">,</span>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">verify_pre_sweeping_rosalloc_</span><span class="p">,</span>
<a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">verify_post_gc_rosalloc_</span><span class="p">,</span>
<a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">gcstress_</span><span class="p">,</span>
<a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a><span class="w">                         </span><span class="n">xgc_option</span><span class="p">.</span><span class="n">measure_</span><span class="p">,</span>
<a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">EnableHSpaceCompactForOOM</span><span class="p">),</span>
<a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a><span class="w">                         </span><span class="n">runtime_options</span><span class="p">.</span><span class="n">GetOrDefault</span><span class="p">(</span><span class="n">Opt</span><span class="o">::</span><span class="n">HSpaceCompactForOOMMinIntervalsMs</span><span class="p">));</span>
<a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a><span class="w">  </span><span class="p">......</span>
<a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a><span class="p">}</span>
</code></pre></div>
<p>可以看到这里的参数是从 runtime_options 中取到的, 他们的定义如下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>// android-9.0.0_r3/art/runtime/runtime_options.def
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>RUNTIME_OPTIONS_KEY (MemoryKiB, HeapMaxFree, gc::Heap::kDefaultMaxFree)
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>RUNTIME_OPTIONS_KEY (double, ForegroundHeapGrowthMultiplier gc::Heap::kDefaultHeapGrowthMultiplier)
</code></pre></div>
<p>可以看到这里最终又会回到 heap.h 中, 下面看看这个 Native 内存阈值到底是多少</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>// android-9.0.0_r3/art/runtime/gc/heap.h
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>class Heap {
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a> public:
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>  // If true, measure the total allocation time.
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>  static constexpr size_t kDefaultMaxFree = 2 * MB;
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>  static constexpr double kDefaultHeapGrowthMultiplier = 2.0;
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>  ......
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>}
</code></pre></div>
<p>故 Native 内存分配超过 4MB, 便会尝试触发虚拟机 GC</p>
<p><strong>通过源码分析可以发现, 原来向 ART 虚拟机注册 Native 分配大小, 是为了让 Native 分配的内存也成为虚拟机 GC 的权重之一, 当 Java 对应的 Native 对象内存分配总和超过 4MB, 便会尝试触发虚拟机的 GC</strong></p>
<h2 id="5">5. 总结<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>通过一步步分析，最终不难发现 Bitmap 本质上就是内存中的一块数据。所谓创建 Bitmap，不过是调用 <code>malloc()</code> 分配一块内存。而回收 Bitmap，不过是调用 <code>free()</code> 将之前的内存释放掉。</p>
<p>为什么 2.3.3 ~ 7.0 要放到 Java 堆? 直接放到 Native 中, 然后在 Java 对象 finalize 调用的时候释放不行吗?</p>
<ul>
<li>Java 层的 Bitmap 对象是一个壳, 非常小, 因此有可能会出现 Native 堆快到了 3G, Java 堆才 10 MB, 10MB 是无法触发 Dalvik GC 的, 因此这个 java 对象的 finalize 并非那么容易调用, 因此可能会出现 Native 堆 OOM 的情况, 故需要我们手动 recycle</li>
<li>像素数据直接放置到 Java 堆, Java 堆就能直接统计到真正的内存数据, 能够根据内存使用情况准确触发 GC 回收数据</li>
<li>隐患便是 Java 堆内存空间比较小, 容器造成 Java 堆的 OOM</li>
</ul>
<p>为什么 8.0 又放置到了 Native 堆中?</p>
<ul>
<li>使用 NativeAllocationRegistry 解决了这个问题, 触发 ART 堆 GC 的条件不仅仅是堆占用不足, 通过 VMRuntime.registerNativeAllocation 注册的 Native 内存累计超过了阈值(4MB)之后时也会触发 GC</li>
<li>而且 ART 的 GC 性能比 Dalvik 好的多, 不会轻易造成主线程卡顿</li>
</ul>
<h2 id="6-80bitmap">6. 8.0之前Bitmap内存分配原理<a class="headerlink" href="#6-80bitmap" title="Permanent link">&para;</a></h2>
<p>Bitmap中有个byte[] mBuffer，其实就是用来存储像素数据的，很明显它位于java heap中</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Bitmap</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Parcelable</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bitmap&quot;</span><span class="p">;</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">mBuffer</span><span class="p">;</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>我们以<code>Bitmap#createBitmap</code>方法为例，整体流程如下：</p>
<p><a class="glightbox" href="../assets/16386754fcd33cd6_tplv-t2oaga2asx-zoom-in-crop-mark_3024_0_0_0.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="../assets/16386754fcd33cd6_tplv-t2oaga2asx-zoom-in-crop-mark_3024_0_0_0.webp" /></a></p>
<p>详细分析可参考<a href="https://juejin.cn/post/6844903608887017485">Android Bitmap变迁与原理解析</a></p>
<h2 id="_1">参考<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://sharrychoo.github.io/blog/android-source/bitmap-memory-evolution">Bitmap 位图内存的演进流程</a></li>
<li><a href="https://github.com/410063005/10years/blob/3ef9f15ca85154de2d701b159f5deadbaf5594c4/android/bitmap/bitmap-from-birth-to-death.md">Bitmap: 从出生到死亡</a></li>
</ul>


  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 - 2026 Adison
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/adisonhuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/adisonhyh" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:adison5321@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.tabs.link", "navigation.sections", "navigation.tabs", "navigation.top", "search.share", "search.suggest", "search.highlight", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>