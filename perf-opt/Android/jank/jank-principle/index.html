
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="网站描述">
      
      
        <meta name="author" content="Adison">
      
      
        <link rel="canonical" href="https://adisonhuang.github.io/perf-opt/Android/jank/jank-principle/">
      
      
        <link rel="prev" href="../../size/Android-so-opt/">
      
      
        <link rel="next" href="../jank-tool/">
      
      <link rel="icon" href="../../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>Android卡顿掉帧问题分析之原理篇 - Adison's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      
  
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');}</style>


    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-112420326-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");ga("send","event","feedback","click",t,e),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){ga("send","pageview",e.pathname)})});var e=document.createElement("script");e.async=!0,e.src="https://www.google-analytics.com/analytics.js",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#android" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="Adison&#39;s Blog" class="md-header__button md-logo" aria-label="Adison's Blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Adison's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Android卡顿掉帧问题分析之原理篇
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="black"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../front-end/" class="md-tabs__link">
        大前端
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../" class="md-tabs__link md-tabs__link--active">
        Android性能优化
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../native/" class="md-tabs__link">
        Native
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../design/" class="md-tabs__link">
        设计&架构
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../interview/" class="md-tabs__link">
        面试
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../basic/" class="md-tabs__link">
        计算机基础
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tools/" class="md-tabs__link">
        开发工具
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../back-end/" class="md-tabs__link">
        后端&运维
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../game/" class="md-tabs__link">
        游戏开发
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../read/" class="md-tabs__link">
        读书笔记
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Adison&#39;s Blog" class="md-nav__button md-logo" aria-label="Adison's Blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    Adison's Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
          大前端
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          大前端
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/" class="md-nav__link">
        大前端
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
          Android
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2">
          <span class="md-nav__icon md-icon"></span>
          Android
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_1" id="__nav_1_2_1_label" tabindex="0">
          必知必会
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_1">
          <span class="md-nav__icon md-icon"></span>
          必知必会
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/Android_animation/" class="md-nav__link">
        Android 动画原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/handler/" class="md-nav__link">
        Android消息机制-Handler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/binder/" class="md-nav__link">
        解析Binder框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/dialog_token/" class="md-nav__link">
        Dialog 对应的 Context 必须是 Activity吗？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/apk_analyze/" class="md-nav__link">
        APK文件分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/bootloader/" class="md-nav__link">
        Android 开机流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/android-transform/" class="md-nav__link">
        Android Transform
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/asm-basic/" class="md-nav__link">
        ASM 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/system/ASM-Core-Api/" class="md-nav__link">
        ASM Core Api 详解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_2" id="__nav_1_2_2_label" tabindex="0">
          Kotlin
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_2">
          <span class="md-nav__icon md-icon"></span>
          Kotlin
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/koltin/Kotlin_nline%2C%20noinline%2C%20crossinline/" class="md-nav__link">
        Kotlin中inline, noinline, crossinline的区别
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/koltin/Kotlin-takeIf-or-takeUnless/" class="md-nav__link">
        使用Kotlin takeIf（或takeUnless）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/koltin/Mastering%20Kotlin%20standard%20functions/" class="md-nav__link">
        掌握Kotlin标准函数：run, with, let, also and apply
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_3" id="__nav_1_2_3_label" tabindex="0">
          并发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_3">
          <span class="md-nav__icon md-icon"></span>
          并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/thread-lifecycle/" class="md-nav__link">
        线程的生命周期，真的没那么简单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/process%20and%20thread/" class="md-nav__link">
        进程与线程的一个简单解释
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/basic/" class="md-nav__link">
        并发基础总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/concurrency/thread-pool/" class="md-nav__link">
        线程池总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_4" id="__nav_1_2_4_label" tabindex="0">
          JVM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_4">
          <span class="md-nav__icon md-icon"></span>
          JVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/jvm/memory-area/" class="md-nav__link">
        Java 内存区域详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/jvm/jvm-garbage-collection/" class="md-nav__link">
        JVM 垃圾回收详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/Android_classloader/" class="md-nav__link">
        Android ClassLoader机制
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_1_2_5" id="__nav_1_2_5_label" tabindex="0">
          杂记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_2_5">
          <span class="md-nav__icon md-icon"></span>
          杂记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/android/daily/flask_android_8/" class="md-nav__link">
        Mac10.14编译Android 8.1源码及刷入nexus 6p
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
      
      
      
        <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
          Flutter
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_3">
          <span class="md-nav__icon md-icon"></span>
          Flutter
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/flutter/tools/fvm/" class="md-nav__link">
        使用fvm管理多个版本flutter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../front-end/flutter/learn/Dart/" class="md-nav__link">
        Dart 简介
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Android性能优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Android性能优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        性能优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          内存优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          内存优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_memory_manager/" class="md-nav__link">
        Android内存管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_memory_tools/" class="md-nav__link">
        Android 内存分析工具(命令行)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_memory_tools_gc/" class="md-nav__link">
        Android 内存分析工具(查看GC)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/MAT-Startup/" class="md-nav__link">
        Android 内存分析工具(MAT入门)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/MAT-Advanced/" class="md-nav__link">
        Android 内存分析工具(MAT进阶)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Android_fd_leak/" class="md-nav__link">
        Android句柄泄漏分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/native-backtrace/" class="md-nav__link">
        Android Native 栈回溯
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/android-memory-gov/" class="md-nav__link">
        Android内存综合治理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          崩溃优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          崩溃优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/crash_op/" class="md-nav__link">
        Android 崩溃优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/native-catch/" class="md-nav__link">
        Android 平台 Native 代码的崩溃捕获机制及实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/native-crash-signal/" class="md-nav__link">
        native 崩溃信号介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crash/KillApplicationHandler/" class="md-nav__link">
        为啥Android子线程抛出异常主线程会崩溃
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          启动优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          启动优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../launch/Android-launch-opt/" class="md-nav__link">
        Android启动优化
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          包体积优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          包体积优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../size/Android-apk-size-opt/" class="md-nav__link">
        Android 包体积优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../size/douyin/" class="md-nav__link">
        从 Class 字节码入手精简 DEX 体积
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../size/Android-so-opt/" class="md-nav__link">
        Android对so体积优化的探索与实践
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
          卡顿优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          卡顿优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Android卡顿掉帧问题分析之原理篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Android卡顿掉帧问题分析之原理篇
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-input" class="md-nav__link">
    1 Input事件处理机制
  </a>
  
    <nav class="md-nav" aria-label="1 Input事件处理机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1 系统机制分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-systrace" class="md-nav__link">
    1.2 结合Systrace分析
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-ui" class="md-nav__link">
    2 应用UI线程消息循环机制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-android" class="md-nav__link">
    3 Android屏幕刷新机制
  </a>
  
    <nav class="md-nav" aria-label="3 Android屏幕刷新机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-vsync" class="md-nav__link">
    3.1 双缓存+Vsync
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-drawing-with-vsync" class="md-nav__link">
    3.2 Drawing with Vsync
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-choreographer" class="md-nav__link">
    3.3 Choreographer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-ui" class="md-nav__link">
    4 UI 线程绘制流程
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-renderthread" class="md-nav__link">
    5 RenderThread 线程渲染流程
  </a>
  
    <nav class="md-nav" aria-label="5 RenderThread 线程渲染流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1 构建绘制命令树
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 执行渲染绘制任务
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-surfaceflinger" class="md-nav__link">
    6 SurfaceFlinger图形合成
  </a>
  
    <nav class="md-nav" aria-label="6 SurfaceFlinger图形合成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-bufferqueue" class="md-nav__link">
    6.1 BufferQueue机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-vsync" class="md-nav__link">
    6.2 Vsync同步机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    6.3 帧数据的提交消费过程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7 流程总结与卡顿定义
  </a>
  
    <nav class="md-nav" aria-label="7 流程总结与卡顿定义">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    7.1 应用绘制上帧流程总结
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    7.2 卡顿的定义
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8 参考
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jank-tool/" class="md-nav__link">
        Android卡顿掉帧问题分析之工具篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jank-shizhan/" class="md-nav__link">
        Android卡顿掉帧问题分析之实战篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jank-opt/" class="md-nav__link">
        Android卡顿优总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpu_use/" class="md-nav__link">
        Linux环境下进程的CPU占用率
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
          ANR优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          ANR优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/anr/" class="md-nav__link">
        ANR 原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/anr_monitor/" class="md-nav__link">
        ANR 监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/anr_trace/" class="md-nav__link">
        ANR 分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anr/sp/" class="md-nav__link">
        告别 SharedPreference 等待
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
      
      
      
        <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
          图片优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          图片优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bitmap/image/" class="md-nav__link">
        图片文件技术原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bitmap/imge-format/" class="md-nav__link">
        了解各种图形格式的编码方式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bitmap/bitmap-from-birth-to-death/" class="md-nav__link">
        Bitmap从出生到死亡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bitmap/bitmap-memory/" class="md-nav__link">
        Bitmap 内存占用分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bitmap/glide/" class="md-nav__link">
        Glide 核心知识
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
          网络优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          网络优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../net/net_opt/" class="md-nav__link">
        移动网络优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../net/okhttp/" class="md-nav__link">
        OKhttp 核心解析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
      
      
      
        <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
          基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/Native-Hook/" class="md-nav__link">
        native-hook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../command/dumpsys/" class="md-nav__link">
        dumpsys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../command/top/" class="md-nav__link">
        top命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../net/log/" class="md-nav__link">
        线上疑难问题该如何排查和跟踪？
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Native
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Native
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/" class="md-nav__link">
        C&C++
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          C/C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          C/C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cbasic/" class="md-nav__link">
        C基础知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/C%2B%2Bbasic/" class="md-nav__link">
        C++基础知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/compilation-principle/" class="md-nav__link">
        编译原理基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/pointer%281%29/" class="md-nav__link">
        深度长文教你彻底掌握C++/C指针(一):基石
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/pointer%282%29/" class="md-nav__link">
        深度长文教你彻底掌握C++/C指针(二):指针和数组与字符串
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_auto/" class="md-nav__link">
        C++ auto类型推导完全攻略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_decltype/" class="md-nav__link">
        C++ decltype类型推导完全攻略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_nullptr/" class="md-nav__link">
        C++11 nullptr：初始化空指针
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/Cplus_shared_ptr/" class="md-nav__link">
        C++11 shared_ptr智能指针
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
          JNI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          JNI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/JNI/JNI-op/" class="md-nav__link">
        JNI优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/JNI/Android-JNI/" class="md-nav__link">
        JNI使用总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          疑难问题
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          疑难问题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../native/basic/__emutls_get_address/" class="md-nav__link">
        dlopen时找不到__emutls_get_address符号
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          设计&架构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          设计&架构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/" class="md-nav__link">
        设计 & 架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/framework%20design/" class="md-nav__link">
        架构设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/Design%20Principles/" class="md-nav__link">
        六大设计原则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/design-patterns/" class="md-nav__link">
        设计模式概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
          设计模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          设计模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_1" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_1" id="__nav_4_5_1_label" tabindex="0">
          创建型模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_1">
          <span class="md-nav__icon md-icon"></span>
          创建型模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/index_creational/" class="md-nav__link">
        概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/singleton/" class="md-nav__link">
        单例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/factory/" class="md-nav__link">
        工厂模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/prototype/" class="md-nav__link">
        原型模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/builder/" class="md-nav__link">
        建造者模式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_2" id="__nav_4_5_2_label" tabindex="0">
          结构型模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_2">
          <span class="md-nav__icon md-icon"></span>
          结构型模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/index_structural/" class="md-nav__link">
        概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/adapter/" class="md-nav__link">
        适配器模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/proxy/" class="md-nav__link">
        代理模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/facade/" class="md-nav__link">
        外观模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/wrapper/" class="md-nav__link">
        装饰模式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_3" id="__nav_4_5_3_label" tabindex="0">
          行为模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_3">
          <span class="md-nav__icon md-icon"></span>
          行为模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/index_behavioral/" class="md-nav__link">
        概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/strategy/" class="md-nav__link">
        策略模式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/design-patterns/summary/" class="md-nav__link">
        总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" >
      
      
      
        <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
          其他
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          其他
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/other/fail-fast%26fail-safe/" class="md-nav__link">
        fail-fast&fail-safe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design/other/singleton_extra/" class="md-nav__link">
        各种单例写法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          面试
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          面试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/" class="md-nav__link">
        Android面试题题目
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
      
      
      
        <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
          Android
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Android
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_components/" class="md-nav__link">
        Android 四大组件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_screen/" class="md-nav__link">
        Android 屏幕适配
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_communication/" class="md-nav__link">
        Android 通信相关
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_view/" class="md-nav__link">
        Android 视图相关
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_event/" class="md-nav__link">
        Android 事件相关
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/android_sys/" class="md-nav__link">
        Android 系统原理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_basic/" class="md-nav__link">
        Java 基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_collection/" class="md-nav__link">
        Java 容器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_thread/" class="md-nav__link">
        Java 多线程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../interview/java_jvm/" class="md-nav__link">
        Java JVM
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          计算机基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          计算机基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/" class="md-nav__link">
        计算机基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
          操作系统
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          操作系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/system/shell/" class="md-nav__link">
        shell核心语法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
          网络
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          网络
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/net/net/" class="md-nav__link">
        基础知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/net/5g/" class="md-nav__link">
        讲清楚5G
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
          数据结构与算法
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          数据结构与算法
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_1" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_1" id="__nav_6_4_1_label" tabindex="0">
          数组
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_1">
          <span class="md-nav__icon md-icon"></span>
          数组
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/array_algo_1/" class="md-nav__link">
        实现一个支持动态扩容的数组
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/array_algo_2/" class="md-nav__link">
        实现一个大小固定的有序数组，支持动态增删改操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/array_algo_3/" class="md-nav__link">
        合并两个有序数组
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_2" id="__nav_6_4_2_label" tabindex="0">
          链表
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_2">
          <span class="md-nav__icon md-icon"></span>
          链表
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/linklist_1/" class="md-nav__link">
        实现单链表、循环链表、双向链表，支持增删操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/linklist_lru/" class="md-nav__link">
        实现LRU缓存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/linklist_2/" class="md-nav__link">
        常见链表操作
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_3" id="__nav_6_4_3_label" tabindex="0">
          栈
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_3">
          <span class="md-nav__icon md-icon"></span>
          栈
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/stack_1/" class="md-nav__link">
        顺序栈、链式栈
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/stack_2/" class="md-nav__link">
        常见栈操作
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_4" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_4" id="__nav_6_4_4_label" tabindex="0">
          队列
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_4">
          <span class="md-nav__icon md-icon"></span>
          队列
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/queue/" class="md-nav__link">
        常见队列实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_5" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_5" id="__nav_6_4_5_label" tabindex="0">
          递归
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_5">
          <span class="md-nav__icon md-icon"></span>
          递归
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/recursive/" class="md-nav__link">
        常见递归算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_6" id="__nav_6_4_6_label" tabindex="0">
          排序与二分查找
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_6">
          <span class="md-nav__icon md-icon"></span>
          排序与二分查找
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/sort/" class="md-nav__link">
        常见排序算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/bsearch/" class="md-nav__link">
        二分查找算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_7" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_7" id="__nav_6_4_7_label" tabindex="0">
          散列表
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_7">
          <span class="md-nav__icon md-icon"></span>
          散列表
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/hashTable/" class="md-nav__link">
        常见散列表实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_8" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_8" id="__nav_6_4_8_label" tabindex="0">
          二叉树
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_8">
          <span class="md-nav__icon md-icon"></span>
          二叉树
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/tree/" class="md-nav__link">
        二叉查找树
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_9" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4_9" id="__nav_6_4_9_label" tabindex="0">
          堆
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4_9">
          <span class="md-nav__icon md-icon"></span>
          堆
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/heap/" class="md-nav__link">
        小顶堆、大顶堆、优先级队列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../basic/algo/heap_1/" class="md-nav__link">
        常见堆算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          开发工具
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          开发工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/" class="md-nav__link">
        开发工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
      
      
      
        <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
          GIT
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_2">
          <span class="md-nav__icon md-icon"></span>
          GIT
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/git/git_submodule/" class="md-nav__link">
        Git submodule 子模块的管理和使用
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
      
      
      
        <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
          VIM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_3">
          <span class="md-nav__icon md-icon"></span>
          VIM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/vim/vim-common/" class="md-nav__link">
        Vim常用命令
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          后端&运维
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          后端&运维
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/" class="md-nav__link">
        后端&运维
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
      
        <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/python_func_time/" class="md-nav__link">
        python函数执行时间分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/centos_flask/" class="md-nav__link">
        CentOS部署flask项目
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/pycharm_remote_debug/" class="md-nav__link">
        Pycharm远程调试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../back-end/python/PyCharm_root_debug/" class="md-nav__link">
        以Root权限运行/调试 PyCharm
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          游戏开发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          游戏开发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/" class="md-nav__link">
        游戏开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/perf/tools/" class="md-nav__link">
        Unity3D性能优化——工具篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/perf/cpu/" class="md-nav__link">
        Unity3D性能优化——CPU篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../game/perf/render/" class="md-nav__link">
        Unity3D性能优化——渲染篇
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          读书笔记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          读书笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/" class="md-nav__link">
        开卷有益
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/jvm/jvm/" class="md-nav__link">
        《深入理解java虚拟机》阅读笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_3" >
      
      
      
        <label class="md-nav__link" for="__nav_10_3" id="__nav_10_3_label" tabindex="0">
          《数据结构与算法之美》笔记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10_3">
          <span class="md-nav__icon md-icon"></span>
          《数据结构与算法之美》笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/Complexity%20Analysis/" class="md-nav__link">
        复杂度分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/array/" class="md-nav__link">
        数组
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/linked-list/" class="md-nav__link">
        链表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/stack/" class="md-nav__link">
        栈
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/queue/" class="md-nav__link">
        队列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/recursion/" class="md-nav__link">
        递归
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/basic_sort/" class="md-nav__link">
        基础排序算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/sort-advance/" class="md-nav__link">
        高级排序算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/sort-op/" class="md-nav__link">
        排序优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/bsearch/" class="md-nav__link">
        二分查找
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/skip-list/" class="md-nav__link">
        跳表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/hashmap/" class="md-nav__link">
        散列表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/hashalgo.md" class="md-nav__link">
        哈希算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/binary-tree/" class="md-nav__link">
        二叉树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/Red-Black-Tree/" class="md-nav__link">
        红黑树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/digui-tree/" class="md-nav__link">
        递归树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../read/beautiful-algo/heap/" class="md-nav__link">
        堆
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-input" class="md-nav__link">
    1 Input事件处理机制
  </a>
  
    <nav class="md-nav" aria-label="1 Input事件处理机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1 系统机制分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-systrace" class="md-nav__link">
    1.2 结合Systrace分析
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-ui" class="md-nav__link">
    2 应用UI线程消息循环机制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-android" class="md-nav__link">
    3 Android屏幕刷新机制
  </a>
  
    <nav class="md-nav" aria-label="3 Android屏幕刷新机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-vsync" class="md-nav__link">
    3.1 双缓存+Vsync
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-drawing-with-vsync" class="md-nav__link">
    3.2 Drawing with Vsync
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-choreographer" class="md-nav__link">
    3.3 Choreographer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-ui" class="md-nav__link">
    4 UI 线程绘制流程
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-renderthread" class="md-nav__link">
    5 RenderThread 线程渲染流程
  </a>
  
    <nav class="md-nav" aria-label="5 RenderThread 线程渲染流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1 构建绘制命令树
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 执行渲染绘制任务
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-surfaceflinger" class="md-nav__link">
    6 SurfaceFlinger图形合成
  </a>
  
    <nav class="md-nav" aria-label="6 SurfaceFlinger图形合成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-bufferqueue" class="md-nav__link">
    6.1 BufferQueue机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-vsync" class="md-nav__link">
    6.2 Vsync同步机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    6.3 帧数据的提交消费过程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7 流程总结与卡顿定义
  </a>
  
    <nav class="md-nav" aria-label="7 流程总结与卡顿定义">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    7.1 应用绘制上帧流程总结
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    7.2 卡顿的定义
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8 参考
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="android">Android卡顿掉帧问题分析之原理篇<a class="headerlink" href="#android" title="Permanent link">&para;</a></h1>
<p>当用户抱怨手机在使用过程中存在卡顿问题的时候，会严重影响用户对手机品牌的好感和应用<code>APP</code>的体验，从而导致用户对手机品牌的忠诚度降低或应用<code>APP</code>的装机留存率下降。所以无论是手机设备厂商还是应用<code>APP</code>开发者，又或是<code>Android</code>系统的维护者<code>Google</code>都会对界面卡顿问题非常重视，会将界面的流畅度作为核心性能体验指标进行持续的优化。说到流畅度，本质上就是要解决用户操作手机过程中的界面丢帧问题，本来一秒钟屏幕上需要更新<code>60</code>帧画面，但是由于种种原因，这期间屏幕上只更新了<code>55</code>帧画面，这就是出现丢帧，在用户主观肉眼看来就是感知卡顿。那么当出现了丢帧卡顿的问题时，我们该如何着手去分析与优化解决呢？</p>
<p>在分析任何问题之前，我们都需要先弄清楚其基本原理，也就是要掌握了这个“道”，才能真正着手去分析问题，否者只能是弄得一头雾水，也没法真正的理解和解决问题。所以要想分析并解决界面掉帧卡顿问题，我们就先需要知道在<code>Android</code>系统上应用<code>UI</code>线程到底是如何完成一帧画面的上帧显示动作的。由于大部分应用界面的上帧更新画面动作都是由用户手指触摸屏幕而触发，所以本文以手指上下滑动应用界面的操作场景为例，结合<code>Systrace</code>分析一下<code>Android</code>应用上帧显示的原理。</p>
<h2 id="1-input">1 Input事件处理机制<a class="headerlink" href="#1-input" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 系统机制分析<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<p><code>Android</code> 系统是由事件驱动的，而 <code>Input</code> 是最常见的事件之一，用户的点击、滑动、长按等操作，都属于 <code>Input</code> 事件驱动，其中的核心就是 <code>InputReader</code> 和 <code>InputDispatcher</code>。<code>InputReader</code> 和 <code>InputDispatcher</code> 是跑在 <code>system_server</code>进程中的两个 <code>Native</code>循环线程，负责读取和分发 <code>Input</code> 事件。整个处理过程大致流程如下：</p>
<ol>
<li>触摸屏会按照屏幕硬件的触控采样率周期，每隔几毫秒扫描一次，如果有触控事件就会上报到对应的设备驱动；系统封装了一个叫<code>EventHub</code>的对象，它利用<code>inotify</code>和<code>epoll</code>机制监听<code>/dev/input</code>目录下的<code>input</code>设备驱动节点，通过<code>EventHub</code>的<code>getEvents</code>接口就可以监听并获取到<code>Input</code>事件；</li>
<li><code>InputReader</code>负责从<code>EventHub</code>里面把<code>Input</code>事件读取出来，然后交给 <code>InputDispatcher</code> 进行事件分发；</li>
<li><code>InputDispatcher</code>在拿到 <code>InputReader</code>获取的事件之后，对事件进行包装后，寻找并分发到目标窗口;</li>
<li><code>InboundQueue</code>队列（<code>“iq”</code>）中放着<code>InputDispatcher</code>从<code>InputReader</code>中拿到的<code>input</code>事件；</li>
<li><code>OutboundQueue</code>（<code>“oq”</code>）队列里面放的是即将要被派发给各个目标窗口<code>App</code>的事件；</li>
<li><code>WaitQueue</code>队列里面记录的是已经派发给 <code>App</code>（<code>“wq”</code>），但是 <code>App</code>还在处理没有返回处理成功的事件；</li>
<li><code>PendingInputEventQueue</code>队列（“aq”）中记录的是应用需要处理的<code>Input</code>事件，这里可以看到<code>input</code>事件已经传递到了应用进程；</li>
<li><code>deliverInputEvent</code> 标识 <code>App</code>  <code>UI Thread</code> 被 <code>Input</code> 事件唤醒；</li>
<li><code>InputResponse</code> 标识 <code>Input</code> 事件区域，这里可以看到一个 <code>Input_Down</code> 事件 + 若干个 <code>Input_Move</code> 事件 + 一个 <code>Input_Up</code> 事件的处理阶段都被算到了这里；</li>
<li><code>App</code> 响应处理<code>Input</code> 事件，内部会在其界面<code>View</code>树中逐层分发和处理。</li>
</ol>
<p>用一张图描述整个过程大致如下（关于这部分详细的<code>Android</code>系统源码实现流程可以参考这篇文章<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fjuejin.cn%2Fpost%2F6956500920108580878">https://juejin.cn/post/6956500920108580878</a>）：</p>
<p><a class="glightbox" href="../assets/26874665-ab756e88f0bb89c2.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-ab756e88f0bb89c2.webp" /></a></p>
<h3 id="12-systrace">1.2 结合Systrace分析<a class="headerlink" href="#12-systrace" title="Permanent link">&para;</a></h3>
<p>从上面的系统机制的分析可以看出，整个<code>Input</code>触控事件的分发与处理主要涉及到两个进程：一个是<code>system_server</code>系统进程，另一个是当前焦点窗口所属的<code>Setting</code>应用进程。</p>
<p>一、<strong><code>system_server</code>进程的处理过程</strong>：</p>
<ol>
<li>
<p>当用户手指在<code>Setting</code>应用界面滑动时，系统<code>system_server</code>进程中的<code>native</code>线程<code>InputReader</code>会从<code>EventHub</code>中读取其利用<code>linux</code>的<code>epoll</code>机制监听到的屏幕驱动上报的<code>Input</code>触控事件，然后唤醒另外一条native线程<code>InputDispatcher</code>负责进行事件的进一步分发处理。</p>
</li>
<li>
<p><code>InputDispatcher</code>被唤醒后会先将事件放到<code>InboundQueue</code>队列（也就是<code>Systrace</code>上看到的“<code>iq”</code>队列）中，然后找到具体处理此<code>input</code>事件的应用目标窗口，并将<code>Input</code>事件放入对应的应用目标窗口的<code>OutboundQueue</code>队列（也就是<code>Systrace</code>上看到的<code>“oq”</code>队列）中，等待进一步通过<code>SocketPair</code>双工信道发送<code>input</code>事件到应用目标窗口中；</p>
</li>
<li>
<p>最后当事件发送给具体的应用目标窗口后，会将事件移动到<code>WaitQueue</code>队列中（也就是<code>Systrace</code>上看到的<code>“wq”</code>队列）并一直等待收到到目标应用处理<code>Input</code>事件完成后的反馈后再从队列中移除，<strong>如果5秒内没有收到目标应用窗口处理完成此次<code>Input</code>事件的反馈，就会报该应用ANR异常事件</strong>。以上整个过程在<code>Android</code>系统<code>AOSP</code>源码中都加有相应的<code>Systrace tag</code>，如下<code>Systrace</code>截图所示：</p>
</li>
</ol>
<p><a class="glightbox" href="../assets/26874665-26d272761a9069fa.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-26d272761a9069fa.webp" /></a></p>
<p>二、<strong>应用进程的处理过程</strong>：当<code>Input</code>触控事件通过<code>socket</code>传递到<code>Settings</code>应用进程这边后，会唤醒应用的<code>UI</code>线程在<code>ViewRootImpl#deliverInputEvent</code>的流程中进行<code>Input</code>事件的具体分发与处理。具体的处理流程：</p>
<ol>
<li>
<p>先交给之前在添加应用<code>PhoneWindow</code>窗口时的<code>ViewRootImpl#setView</code>流程中创建的多个不同类型的<code>InputUsage</code>中依次进行处理（比如对输入法处理逻辑的封装<code>ImeInputUsage</code>，某些<code>key</code>类型的<code>Input</code>事件会由它先交给输入法进程处理完后再交给应用窗口的<code>InputUsage</code>处理），<strong>整个处理流程是按照责任链的设计模式进行</strong>；</p>
</li>
<li>
<p>最后会交给负责应用窗口<code>Input</code>事件分发处理的<code>ViewPostImeInputUsage</code>中具体处理，这里面会从<code>View</code>布局树的根节点<code>DecorView</code>开始遍历整个<code>View</code>树上的每一个子<code>View</code>或<code>ViewGroup</code>控件执行事件的分发、拦截、处理的逻辑；</p>
</li>
<li>
<p>最后触控事件处理完成后会调用<code>finishInputEvent</code>结束应用对触控事件处理逻辑，<strong>这里面会通过<code>JNI</code>调用到<code>native</code>层<code>InputConsumer</code>的<code>sendFinishedSignal</code>函数中通过socket消息通知系统框架中的<code>InputDispatcher</code>该<code>Input</code>事件处理完成</strong>，触发从<code>"wq"</code>队列中及时移除待处理事件以免报<code>ANR</code>异常。</p>
</li>
<li>
<p><strong>一次滑动过程的触控交互的<code>InputResponse</code>区域中一般会包含一个<code>Input</code>的<code>ACTION_DOWN</code>事件+多个<code>ACTION_MOVE</code>事件+一个<code>ACTION_UP</code>事件</strong>，<code>Settings</code>应用界面中的相关<code>View</code>控件在收到多个<code>ACTION_MOVE</code>触控事件后，经过判断为用户手指滑动行为，<strong>一般会调用<code>View#invalidate</code>等相关接口触发<code>UI</code>线程的绘制上帧更新画面的操作</strong>，具体流程后文会继续详细分析。以上过程如下<code>Systrace</code>截图所示：</p>
</li>
</ol>
<p><a class="glightbox" href="../assets/26874665-f7b8127610f84a36.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-f7b8127610f84a36.webp" /></a></p>
<h2 id="2-ui">2 应用UI线程消息循环机制<a class="headerlink" href="#2-ui" title="Permanent link">&para;</a></h2>
<p><code>App</code>应用启动时，在<code>Fork</code>创建进程后会通过反射创建代表应用主线程的<code>ActivityThread</code>对象并执行其<code>main</code>函数，进行<code>UI</code>主线程的初始化工作：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="cm">/*frameworks/base/core/java/android/app/ActivityThread.java*/</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">     </span><span class="c1">// 1.创建Looper、MessageQueue</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">     </span><span class="n">Looper</span><span class="p">.</span><span class="na">prepareMainLooper</span><span class="p">();</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">     </span><span class="c1">// 2.启动loop消息循环，开始准备接收消息</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">     </span><span class="n">Looper</span><span class="p">.</span><span class="na">loop</span><span class="p">();</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1">// 3.创建主线程Handler对象</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="kd">final</span><span class="w"> </span><span class="n">H</span><span class="w"> </span><span class="n">mH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">H</span><span class="p">();</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="kd">class</span> <span class="nc">H</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="p">}</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="cm">/*frameworks/base/core/java/android/os/Looper.java*/</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prepareMainLooper</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">     </span><span class="c1">// 准备主线程的Looper</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">     </span><span class="n">prepare</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">     </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">Looper</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sMainLooper</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">              </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;The main Looper has already been prepared.&quot;</span><span class="p">);</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">          </span><span class="n">sMainLooper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLooper</span><span class="p">();</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="p">}</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">quitAllowed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Only one Looper may be created per thread&quot;</span><span class="p">);</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="w">      </span><span class="c1">// 创建主线程的Looper对象，并通过ThreadLocal机制实现与主线程的一对一绑定</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">      </span><span class="n">sThreadLocal</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Looper</span><span class="p">(</span><span class="n">quitAllowed</span><span class="p">));</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="p">}</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="kd">private</span><span class="w"> </span><span class="nf">Looper</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">quitAllowed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">      </span><span class="c1">// 创建MessageQueue消息队列</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="w">      </span><span class="n">mQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MessageQueue</span><span class="p">(</span><span class="n">quitAllowed</span><span class="p">);</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="w">      </span><span class="n">mThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">();</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="p">}</span>
</code></pre></div>
<p>主线程初始化完成后，<strong>主线程就有了完整的 <code>Looper</code>、<code>MessageQueue</code>、<code>Handler</code>，此时 <code>ActivityThread</code> 的 <code>Handler</code> 就可以开始处理 <code>Message</code>，包括 <code>Application</code>、<code>Activity</code>、<code>ContentProvider</code>、<code>Service</code>、<code>Broadcast</code> 等组件的生命周期函数，都会以 <code>Message</code> 的形式，在主线程按照顺序处理</strong>，这就是 <code>App</code> 主线程的初始化和运行原理，部分处理的 <code>Message</code> 如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="cm">/*frameworks/base/core/java/android/app/ActivityThread.java*/</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kd">class</span> <span class="nc">H</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">BIND_APPLICATION</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">110</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">        </span><span class="nd">@UnsupportedAppUsage</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RECEIVER</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="mi">113</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">        </span><span class="nd">@UnsupportedAppUsage</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CREATE_SERVICE</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mi">114</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="nd">@UnsupportedAppUsage</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">BIND_SERVICE</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">121</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">BIND_APPLICATION</span><span class="p">:</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">                    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bindApplication&quot;</span><span class="p">);</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">                    </span><span class="n">AppBindData</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AppBindData</span><span class="p">)</span><span class="n">msg</span><span class="p">.</span><span class="na">obj</span><span class="p">;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">                    </span><span class="n">handleBindApplication</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">                    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">                    </span><span class="p">...</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">         </span><span class="p">}</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="p">}</span>
</code></pre></div>
<p>主线程初始化完成后，主线程就进入阻塞状态（进入<code>epoll_wait</code>状态，并释放<code>CPU</code>运行资源），等待 <code>Message</code>，一旦有 <code>Message</code> 发过来，主线程就会被唤醒，处理 <code>Message</code>，处理完成之后，如果没有其他的 <code>Message</code> 需要处理，那么主线程就会进入休眠阻塞状态继续等待。<strong>可以说<code>Android</code>系统的运行是受消息机制驱动的</strong>，而整个消息机制是由上面所说的四个关键角色相互配合实现的（<strong><code>Handler</code></strong>、<strong><code>Looper</code></strong>、<strong><code>MessageQueue</code></strong>、<strong><code>Message</code></strong>），其运行原理如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-1c9a83dc71d8d91a.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-1c9a83dc71d8d91a.webp" /></a></p>
<h2 id="3-android">3 Android屏幕刷新机制<a class="headerlink" href="#3-android" title="Permanent link">&para;</a></h2>
<h3 id="31-vsync">3.1 双缓存+Vsync<a class="headerlink" href="#31-vsync" title="Permanent link">&para;</a></h3>
<p>在一个典型的显示系统中，一般包括<code>CPU</code>、<code>GPU</code>、<code>Display</code>三个部分：<strong><code>CPU</code>负责计算帧数据，把计算好的数据交给<code>GPU</code>，<code>GPU</code>会对图形数据进行渲染，渲染好后放到<code>buffer</code>(图像缓冲区)里存起来，然后<code>Display</code>（屏幕或显示器）负责把<code>Buffer</code>里的数据呈现到屏幕上</strong>。屏幕上显示的内容，是从<code>Buffer</code>图像帧缓冲区中读取的，大致读取过程为：从<code>Buffer</code>的起始地址开始，从上往下，从左往右扫描整个<code>Buffer</code>，将内容映射到显示屏上。如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-1c01a8e3a68137d5.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-1c01a8e3a68137d5.webp" /></a></p>
<p>当然，屏幕上显示的内容需要不断的更新，如果在同一个<code>Buffer</code>进行读取和写入操作，将会导致屏幕显示多帧内容而出现显示错乱。所以硬件层除了提供一个<code>Buffer</code>用于屏幕显示，还会提供了一个<code>Buffer</code>用于后台的<code>CPU/GPU</code>图形绘制与合成，也就是我们常说的 <strong>双缓冲</strong>：让绘制和显示器拥有各自的<code>Buffer：CPU/GPU</code> 始终将完成的一帧图像数据写入到 后缓存区（<code>Back Buffer</code>），而显示器使用前缓存区（ <code>Front Buffer</code>），当屏幕刷新时，<code>Front Buffer</code> 并不会发生变化，当<code>Back Buffer</code>准备就绪后，它们才进行交换。如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-f41a4955d482cfdc.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-f41a4955d482cfdc.webp" /></a></p>
<p>理想情况下假设前一帧显示完成，后一帧数据就准备好了，屏幕开始读取下一帧内容进行显示，也就是开始读取上图中的后缓冲区的内容：</p>
<p><a class="glightbox" href="../assets/26874665-4f3e2ff95b14368f.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-4f3e2ff95b14368f.webp" /></a></p>
<p>此时，前后缓冲区进行一次角色交换，之前的后缓冲区变为前缓冲区，进行图形的显示，之前的前缓冲区则变为后缓冲区，进行图形的绘制合成。然而，理想很丰满，现实很骨感，上面假设“当前一帧显示完毕，后一帧准备好了”的情况，在现实中这两个事件并非同时完成。那么，屏幕读取缓冲区的速度和系统绘制合成帧的速度之间有什么关系呢，带着这个疑惑我们看看下面两个基本概念：</p>
<ol>
<li><strong>屏幕刷新率（<code>Screen Refresh Rate</code>）</strong>: 屏幕刷新率是一个硬件的概念，单位是<code>Hz</code>（赫兹），是说屏幕这个硬件刷新画面的频率：举例来说，<code>60Hz</code> 刷新率意思是：这个屏幕在 1 秒内，会刷新显示内容60 次；那么对应的，<code>90Hz</code> 是说在 1 秒内刷新显示内容 90 次。</li>
<li><strong>帧率（<code>Frame Rate</code>）</strong>: 与屏幕刷新率对应的，帧率是一个软件的概念，单位是<code>FPS</code>（<code>Frame Per Second</code> ），表示 <strong><code>CPU/GPU</code> 在一秒内绘制合成产生的帧数</strong>，意思是每秒产生画面的个数，<code>FPS</code> 的值是由软件系统决定的。举例来说，<code>60FPS</code> 指的是每秒产生 60 个画面；<code>90FPS</code> 指的是每秒产生 90 个画面。</li>
</ol>
<p>我们用以下两个假设来分析两者的关系：</p>
<ol>
<li>
<p>屏幕刷新率比系统帧率快：
    此时，在前缓冲区内容全部映射到屏幕上之后，后缓冲区尚未准备好下一帧，屏幕将无法读取下一帧，所以只能继续显示当前一帧的图形，造成一帧显示多次，也就是 <strong>卡顿</strong>。</p>
</li>
<li>
<p>系统帧率比屏幕刷新率快：
    此时，屏幕未完全把前缓冲区的一帧映射到屏幕，而系统已经在后缓冲区准备好了下一帧，并要求读取下一帧到屏幕，将会导致屏幕上半部分是上一帧的图形，而下半部分是下一帧的图形，造成屏幕上显示多帧，也就是 <strong>屏幕撕裂</strong> 现象，如下图所示：
   <a class="glightbox" href="../assets/26874665-53bc711026d2e290.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-53bc711026d2e290.webp" /></a></p>
</li>
</ol>
<p>所以上面两种情况，都会导致问题，根本原因就是两个缓冲区的操作速率不一致。解决办法就是：<strong>让屏幕控制前后缓冲区的切换时机，让系统帧速率配合屏幕刷新率的节奏</strong>。那么屏幕是如何控制这个节奏的呢？</p>
<p>答案就是 <strong>垂直同步（VSync）</strong>：当屏幕从缓冲区扫描完一帧到屏幕上之后，开始扫描下一帧之前，中间会有一个时间间隙，称为<code>Vetrical Blanking Interval (VBI)</code>，这个时间点其实就是进行前后缓存区交换的最佳时机，此时屏幕并没有在刷新，也就避免了屏幕撕裂现象的产生，所以在此时发出的一个同步<code>Vsync</code>信号，该信号用来切换前缓冲区和后缓冲区(本质就是内存地址的交换，瞬间即可完成)，即可达到最佳效果。</p>
<p>通过上面的分析可以看出：<strong>屏幕的显示节奏是由屏幕刷新率的硬件参数决定且固定的，软件操作系统需要配合屏幕的显示，在固定的时间内准备好下一帧，以供屏幕进行显示，两者通过<code>VSync</code>信号来实现同步</strong>（<code>VSync</code>这个概念并不是<code>Google</code>首创的，它在早年的<code>PC</code>机领域就已经出现了）。</p>
<h3 id="32-drawing-with-vsync">3.2 Drawing with Vsync<a class="headerlink" href="#32-drawing-with-vsync" title="Permanent link">&para;</a></h3>
<p>在<code>Android 4.1</code>之前，屏幕刷新也遵循上面介绍的 <strong>双缓存+<code>VSync</code></strong> 机制，整个流程与架构借用<code>2012</code>年<code>Google I/O</code>大会上展示的一张图如下所示：</p>
<p><a class="glightbox" href="../assets/26874665-7fa5328dcd02825b.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-7fa5328dcd02825b.webp" /></a></p>
<p>上图中：
 一、纵轴表示<code>Buffer</code>的使用者，由如下三个角色构成：</p>
<ol>
<li><strong><code>CPU</code></strong> : 代表利用<code>CPU</code>对界面<code>View</code>的<code>Measure</code>尺寸测量、<code>Layout</code>位置布局、<code>Draw</code>绘制并最终生成纹理的操作；</li>
<li><strong><code>GPU</code></strong>：代表使用<code>OpenGl</code>库指令操作<code>GPU</code>硬件对<code>CPU</code>生成的纹理数据进行渲染和栅格化以及合成等操作；</li>
<li><strong><code>Display</code></strong>：代表底层的显示屏幕；</li>
</ol>
<p>二、横轴表示时间，每个长方形表示<code>Buffer</code>的使用，长方形的宽度代表使用时长，<code>VSync</code>代表垂直同步信号。</p>
<p>我们以时间为顺序来看看这种设计存在的潜在缺陷：</p>
<ol>
<li><code>Display</code>上显示第<code>0</code>帧数据，此时<code>CPU</code>和<code>GPU</code>正在处理准备第<code>1</code>帧的画面，且在<code>Display</code>显示下一帧前完成；</li>
<li>因为<code>CPU</code>和<code>GPU</code>的处理及时，<code>Display</code>在第<code>0</code>帧显示完成后，也就是第<code>1</code>个<code>VSync</code>后，缓存进行交换，然后正常显示第<code>1</code>帧；</li>
<li>接着第<code>2</code>帧开始处理，但是<code>CPU</code>并没有立刻开始准备第<code>2</code>帧的数据，而是直到第<code>2</code>个<code>VSync</code>快来前才开始处理的；</li>
<li>第<code>2</code>个<code>VSync</code>来时，由于第<code>2</code>帧数据还没有准备就绪，缓存没有交换，屏幕显示的还是第<code>1</code>帧画面，即产生了丢帧卡顿问题；</li>
<li>当第<code>2</code>帧数据准备完成后，它并不能立马被显示，而是要等到下一个<code>VSync</code> 带来后，进行前后缓存交换才能显示到屏幕上。</li>
</ol>
<p>出现此掉帧卡顿问题的根本原因是：<strong>上层的<code>CPU</code>和<code>GPU</code>并不知道<code>Vsync</code>信号的到来，所以在底层屏幕的<code>Vsync</code>信号发出后并没有及时收到并开始下一帧画面的操作处理</strong>。根据前面的分析我们知道：双缓存的交换是在<code>Vsyn</code>信号到来时进行，交换后屏幕会读取<code>Front Buffer</code>内的新数据更新显示到屏幕上，而此时的<code>Back Buffer</code> 就可以供<code>GPU</code>准备下一帧数据了。如果 <code>Vsyn</code>到来时  <code>CPU/GPU</code>就开始操作的话，是有完整的<code>Vsync</code>周期时长来处理一帧数据，以避免卡顿的出现。那如何让 <code>CPU/GPU</code>的处理在 <code>Vsyn</code>信号到来时就开始进行呢？</p>
<p>为了优化系统显示性能，<code>Google</code>在<code>Android 4.1</code>系统中对<code>Android Display</code>系统进行了重构，引入了<code>Project Butter</code>（黄油计划），其中很重要的一点修改就是实现了：<strong>在系统收到<code>VSync</code>信号后，上层<code>CPU</code>和<code>GPU</code>马上开始进行下一帧画面数据的处理，完成后及时将数据写入到<code>Buffer</code>中，<code>Google</code>称之为<code>Drawing with Vsync</code></strong>。如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-0311c942520a58cf.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-0311c942520a58cf.webp" /></a></p>
<h3 id="33-choreographer">3.3 Choreographer<a class="headerlink" href="#33-choreographer" title="Permanent link">&para;</a></h3>
<p>上一节中讲到的，为了优化显示系统性能，<code>Google</code>在<code>Android 4.1</code>系统中对<code>Android Display</code>系统进行了重构，引入了<code>Project Butter</code>（黄油计划），其中很重要的一点修改就是实现了：<strong>在系统收到<code>VSync</code>信号后，上层<code>CPU</code>和<code>GPU</code>马上开始进行下一帧画面数据的处理，完成后及时将数据写入到<code>Buffer</code>中</strong>。为了实现这个效果，控制上层<code>CPU</code>和<code>GPU</code>在收到<code>Vsync</code>信号后马上开始一帧数据的处理，谷歌为此专门设计了一个名为<code>Choreographer</code>（中文翻译为“编舞者”）的类，来控制上层绘制的节奏。</p>
<p><code>Choreographer</code> 的引入，主要是为了配合系统<code>Vsync</code>垂直同步机制，给上层 App 的渲染提供一个稳定的 <code>Message</code> 处理的时机，也就是 <code>Vsync</code> 到来的时候 ，系统通过对 <code>Vsync</code> 信号周期的调整，来控制每一帧绘制操作的时机。<strong><code>Choreographer</code> 扮演 Android 渲染链路中承上启下的角色</strong>：</p>
<ol>
<li><strong>承上</strong>：负责接收和处理 <code>App</code> 的各种更新消息和回调，等到 <code>Vsync</code> 到来的时候统一处理。比如集中处理 <code>Input</code>(主要是 <code>Input</code> 事件的处理) 、<code>Animation</code>(动画相关)、<code>Traversal</code>(包括 <code>measure、layout、draw</code> 等操作) ，判断卡顿掉帧情况，记录 <code>CallBack</code> 耗时等；</li>
<li><strong>启下</strong>：负责请求和接收 <code>Vsync</code> 信号。接收 <code>Vsync</code> 信号到来的事件后回调(通过 <code>FrameDisplayEventReceiver</code>.<code>onVsync</code> )，并请求 <code>Vsync</code>(<code>FrameDisplayEventReceiver</code>.<code>scheduleVsync</code>) 。</li>
</ol>
<p><strong>一般应用<code>App</code>有界面<code>UI</code>的变化时，最终都会调用走到<code>ViewRootImpl#scheduleTraversals()</code>方法中</strong>，该方法中会往<code>Choreographer</code>中放入一个<code>CALLBACK_TRAVERSAL</code>类型的绘制任务，如下代码所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="cm">/*frameworks/base/core/java/android/view/ViewRootImpl.java*/</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nd">@UnsupportedAppUsage</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleTraversals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mTraversalScheduled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">         </span><span class="c1">// 通过Choreographer往主线程消息队列添加CALLBACK_TRAVERSAL绘制类型的待执行消息，用于触发后续UI线程真正实现绘制动作</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">         </span><span class="n">mChoreographer</span><span class="p">.</span><span class="na">postCallback</span><span class="p">(</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">                    </span><span class="n">Choreographer</span><span class="p">.</span><span class="na">CALLBACK_TRAVERSAL</span><span class="p">,</span><span class="w"> </span><span class="n">mTraversalRunnable</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="p">}</span>
</code></pre></div>
<p><code>Choreographer</code>在收到的绘制任务后，其内部的工作流程如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-6f851c8e1d5bfcdf.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-6f851c8e1d5bfcdf.webp" /></a></p>
<p><strong>从以上流程图可以看出上层一般<code>App</code>应用<code>UI</code>中<code>View</code>的绘制流程（包含SurfaceView的游戏应用的绘制流程会有一些差异，篇幅有限此处不再展开分析）</strong>：</p>
<ol>
<li><code>View#invalidate</code>触发更新视图请求，此动作会调用<code>ViewRootImpl#scheduleTraversals</code>函数；</li>
<li><code>ViewRootImpl#scheduleTraversals</code>中会向<code>Choreographer</code>中<code>postCallback</code>放入一个<code>CALLBACK_TRAVERSAL</code>类型绘制待执行任务；</li>
<li><code>Choreographer</code>通过<code>DisplayEventReceiver</code>向系统<code>SurfaceFlinger</code>注册下一个<code>VSync</code>信号;</li>
<li>当底层产生下一个<code>VSync</code>消息时，将该信号发送给<code>DisplayEventReceiver</code>，最后传递给<code>Choreographer</code>；</li>
<li><code>Choreographer</code>收到<code>VSync</code>信号之后，向主线程<code>MessageQueue</code>发送了一个异步消息；</li>
<li>最后，异步消息的执行者是跑在主线程中的<code>ViewRootImpl#doTraversal</code>，也就是真正开始绘制一帧的操作（包含<code>measure、layout、draw</code>三个过程）；</li>
</ol>
<p>至此，底层的<code>VSync</code>控制上层绘制的逻辑就解释完了。</p>
<h2 id="4-ui">4 UI 线程绘制流程<a class="headerlink" href="#4-ui" title="Permanent link">&para;</a></h2>
<p>在前几节中分析了应用<code>UI</code>线程的消息循环机制和<code>Android</code>屏幕刷新机制之后，我们接着<code>1</code>小节中关于<code>Input</code>触控事件的处理流程继续往下分析。在<code>1</code>小节的分析中我们了解到：用户手指在应用界面上下滑动时，应用的<code>UI</code>线程中会收到<code>system_server</code>系统进程发送来的一系列<code>Input</code>事件（包含一个<code>ACTION_DOWN</code>、多个<code>ACTION_MOVE</code>和一个<code>ACTION_UP</code>事件），应用界面布局中的相关<code>View</code>控件在收到多个<code>ACTION_MOVE</code>触控事件后，判断为用户手指的滑动行为后，一般会调用<code>View#invalidate</code>等接口触发<code>UI</code>线程的绘制上帧更新画面的操作。</p>
<p>在开始分析之前，我们先来看看<code>Android</code>系统的<code>GUI</code>显示系统在<code>APP</code>应用进程侧的核心架构，其整体架构如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-51a975ff2b3a2186.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-51a975ff2b3a2186.webp" /></a></p>
<ul>
<li><code>Window</code>是一个抽象类，<strong>通过控制<code>DecorView</code>提供了一些标准的UI方案，比如<code>背景、标题、虚拟按键等</code></strong>，而<code>PhoneWindow</code>是<code>Window</code>的唯一实现类，在<code>Activity</code>创建后的attach流程中创建，应用启动显示的内容装载到其内部的<code>mDecor</code>（<code>DecorView</code>）；</li>
<li><code>DecorView</code>是整个界面布局View控件树的根节点，通过它可以遍历访问到整个<code>View</code>控件树上的任意节点；</li>
<li><code>WindowManager</code>是一个接口，继承自<code>ViewManager</code>接口，提供了<code>View</code>的基本操作方法；<code>WindowManagerImp</code>实现了<code>WindowManager</code>接口，内部通过<code>组合</code>方式持有<code>WindowManagerGlobal</code>，用来操作<code>View</code>；<strong><code>WindowManagerGlobal</code>是一个全局单例，内部通过<code>ViewRootImpl</code>将<code>View</code>添加至窗口中</strong>；</li>
<li><strong><code>ViewRootImpl</code>是所有<code>View</code>的<code>Parent</code>，用来总体管理<code>View</code>的绘制以及与系统<code>WMS</code>窗口管理服务的<code>IPC</code>交互从而实现窗口的开辟</strong>；<code>ViewRootImpl</code>是应用进程运转的发动机，可以看到<code>ViewRootImpl</code>内部包含<code>mView</code>（就是<code>DecorView</code>）、<code>mSurface</code>、<code>Choregrapher</code>：<code>mView</code>代表整个控件树，<code>mSurfacce</code>代表画布，应用的UI渲染会直接放到<code>mSurface</code>中，<code>Choregorapher</code>使得应用请求<code>vsync</code>信号，接收信号后开始绘制流程。</li>
</ul>
<p>我们从<code>ViewRootImpl</code>的<code>invalidate</code>流程继续往下分析：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="cm">/*frameworks/base/core/java/android/view/ViewRootImpl.java*/</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nd">@UnsupportedAppUsage</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">invalidate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="n">mDirty</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">mWidth</span><span class="p">,</span><span class="n">mHeight</span><span class="p">);</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mWillDrawSoon</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">         </span><span class="c1">// 调用scheduleTraversals函数触发绘制操作</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">         </span><span class="n">scheduleTraversals</span><span class="p">();</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">}</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="nd">@UnsupportedAppUsage</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleTraversals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mTraversalScheduled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">         </span><span class="c1">// 通过Choreographer往主线程消息队列添加CALLBACK_TRAVERSAL绘制类型的待执行消息，用于触发后续UI线程真正实现绘制动作</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">         </span><span class="n">mChoreographer</span><span class="p">.</span><span class="na">postCallback</span><span class="p">(</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">                    </span><span class="n">Choreographer</span><span class="p">.</span><span class="na">CALLBACK_TRAVERSAL</span><span class="p">,</span><span class="w"> </span><span class="n">mTraversalRunnable</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="p">}</span>
</code></pre></div>
<p>从以上分析可以看出，应用UI线程的绘制最终是通过往<code>Choreographer</code>中放入一个<code>CALLBACK_TRAVERSAL</code>类型的绘制任务而触发，下面的流程就和<code>3.3.3</code>小节中的分析的一致，<code>Choreographer</code>会先向系统申请<code>Vsync</code>信号，待<code>Vsync</code>信号到来后，向应用主线程<code>MessageQueue</code>发送一个异步消息，触发在主线程中执行<code>ViewRootImpl#doTraversal</code>绘制任务动作。我们接着看看<code>ViewRootImpl</code>的<code>doTraversal</code>函数执行绘制流程的简化代码流程：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="cm">/*frameworks/base/core/java/android/view/ViewRootImpl.java*/</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">doTraversal</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mTraversalScheduled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">         </span><span class="n">mTraversalScheduled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">         </span><span class="c1">// 调用removeSyncBarrier及时移除主线程MessageQueue中的Barrier同步栏删，以避免主线程发生“假死”</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">         </span><span class="n">mHandler</span><span class="p">.</span><span class="na">getLooper</span><span class="p">().</span><span class="na">getQueue</span><span class="p">().</span><span class="na">removeSyncBarrier</span><span class="p">(</span><span class="n">mTraversalBarrier</span><span class="p">);</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">         </span><span class="c1">// 执行具体的绘制任务</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">         </span><span class="n">performTraversals</span><span class="p">();</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="p">}</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performTraversals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">     </span><span class="c1">// 1.从DecorView根节点出发，遍历整个View控件树，完成整个View控件树的measure测量操作</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">     </span><span class="n">windowSizeMayChange</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">measureHierarchy</span><span class="p">(...);</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mFirst</span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">    </span><span class="c1">// 2.第一次执行traversals绘制任务时，Binder调用访问系统窗口管理服务WMS的relayoutWindow接口，实现WMS计算应用窗口尺寸并向系统surfaceflinger正式申请Surface“画布”操作</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">         </span><span class="n">relayoutResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">relayoutWindow</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">viewVisibility</span><span class="p">,</span><span class="w"> </span><span class="n">insetsPending</span><span class="p">);</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">     </span><span class="c1">// 3.从DecorView根节点出发，遍历整个View控件树，完成整个View控件树的layout测量操作</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">     </span><span class="n">performLayout</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">mWidth</span><span class="p">,</span><span class="w"> </span><span class="n">mHeight</span><span class="p">);</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">     </span><span class="c1">// 4.从DecorView根节点出发，遍历整个View控件树，完成整个View控件树的draw测量操作</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="w">     </span><span class="n">performDraw</span><span class="p">();</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="p">}</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performMeasure</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">childWidthMeasureSpec</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">childHeightMeasureSpec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="w">        </span><span class="c1">// 原生标识View树的measure测量过程的trace tag</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_VIEW</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;measure&quot;</span><span class="p">);</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="w">            </span><span class="c1">// 从mView指向的View控件树的根节点DecorView出发，遍历访问整个View树，并完成整个布局View树的测量工作</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="w">            </span><span class="n">mView</span><span class="p">.</span><span class="na">measure</span><span class="p">(</span><span class="n">childWidthMeasureSpec</span><span class="p">,</span><span class="w"> </span><span class="n">childHeightMeasureSpec</span><span class="p">);</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_VIEW</span><span class="p">);</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="p">}</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performDraw</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="w">     </span><span class="kt">boolean</span><span class="w"> </span><span class="n">canUseAsync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">draw</span><span class="p">(</span><span class="n">fullRedrawNeeded</span><span class="p">);</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="p">}</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">fullRedrawNeeded</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mAttachInfo</span><span class="p">.</span><span class="na">mThreadedRenderer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mAttachInfo</span><span class="p">.</span><span class="na">mThreadedRenderer</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="w">        </span><span class="c1">// 如果开启并支持硬件绘制加速，则走硬件绘制的流程（从Android 4.+开始，默认情况下都是支持跟开启了硬件加速的）</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a><span class="w">        </span><span class="n">mAttachInfo</span><span class="p">.</span><span class="na">mThreadedRenderer</span><span class="p">.</span><span class="na">draw</span><span class="p">(</span><span class="n">mView</span><span class="p">,</span><span class="w"> </span><span class="n">mAttachInfo</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a><span class="w">        </span><span class="c1">// 否则走drawSoftware软件绘制的流程</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">drawSoftware</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="n">mAttachInfo</span><span class="p">,</span><span class="w"> </span><span class="n">xOffset</span><span class="p">,</span><span class="w"> </span><span class="n">yOffset</span><span class="p">,</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a><span class="w">                        </span><span class="n">scalingRequired</span><span class="p">,</span><span class="w"> </span><span class="n">dirty</span><span class="p">,</span><span class="w"> </span><span class="n">surfaceInsets</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a><span class="w">         </span><span class="p">}</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="p">}</span>
</code></pre></div>
<p>从上面的代码流程可以看出，<strong><code>ViewRootImpl</code>中负责的整个应用界面绘制的主要流程如下</strong>：</p>
<ol>
<li>从界面View控件树的根节点<code>DecorView</code>出发，递归遍历整个<code>View</code>控件树，完成对整个 <strong><code>View</code>控件树的<code>measure</code>测量操作</strong>，由于篇幅所限，本文就不展开分析这块的详细流程；</li>
<li>界面第一次执行绘制任务时，会通过<code>Binder</code> <code>IPC</code>访问系统窗口管理服务WMS的relayout接口，实现窗口尺寸的计算并向系统申请用于本地绘制渲染的<code>Surface</code>“画布”的操作（具体由<code>SurfaceFlinger</code>负责创建应用界面对应的<code>Layer</code>对象，并通过内存共享的方式通过<code>Binder</code>将地址引用透过WMS回传给应用进程这边）；</li>
<li>从界面View控件树的根节点<code>DecorView</code>出发，递归遍历整个<code>View</code>控件树，完成对整个 <strong><code>View</code>控件树的<code>layout</code>布局操作</strong>；</li>
<li>从界面View控件树的根节点<code>DecorView</code>出发，递归遍历整个<code>View</code>控件树，完成对整个 <strong><code>View</code>控件树的<code>draw</code>绘制操作</strong>，如果开启并支持硬件绘制加速（从Android 4.X开始谷歌已经默认开启硬件加速），则走<code>GPU</code>硬件绘制的流程，否则走<code>CPU</code>软件绘制的流程；</li>
</ol>
<p>以上绘制过程从<code>systrace</code>上看如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-bc0bedd86a62d3a1.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-bc0bedd86a62d3a1.webp" /></a></p>
<h2 id="5-renderthread">5 RenderThread 线程渲染流程<a class="headerlink" href="#5-renderthread" title="Permanent link">&para;</a></h2>
<p>截止到目前，在<code>ViewRootImpl</code>中完成了对界面的<code>measure</code>、<code>layout</code>和<code>draw</code>等绘制流程后，用户依然还是看不到屏幕上显示的应用界面内容，因为整个<code>Android</code>系统的显示流程除了前面讲到的UI线程的绘制外，界面还需要经过<code>RenderThread</code>线程的渲染处理，渲染完成后，还需要通过<code>Binder</code>调用“上帧”交给<code>surfaceflinger</code>进程中进行合成后送显才能最终显示到屏幕上。本小节中，我们将接上一节中<code>ViewRootImpl</code>中最后draw的流程继续往下分析开启硬件加速情况下，<code>RenderThread</code>渲染线程的工作流程。由于目前Android 4.X之后系统默认界面是开启硬件加速的，所以本文我们重点分析硬件加速条件下的界面渲染流程，我们先分析一下简化的代码流程：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="cm">/*frameworks/base/core/java/android/view/ViewRootImpl.java*/</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">fullRedrawNeeded</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mAttachInfo</span><span class="p">.</span><span class="na">mThreadedRenderer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mAttachInfo</span><span class="p">.</span><span class="na">mThreadedRenderer</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">        </span><span class="c1">// 硬件加速条件下的界面渲染流程</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">        </span><span class="n">mAttachInfo</span><span class="p">.</span><span class="na">mThreadedRenderer</span><span class="p">.</span><span class="na">draw</span><span class="p">(</span><span class="n">mView</span><span class="p">,</span><span class="w"> </span><span class="n">mAttachInfo</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="p">}</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="cm">/*frameworks/base/core/java/android/view/ThreadedRenderer.java*/</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">View</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">AttachInfo</span><span class="w"> </span><span class="n">attachInfo</span><span class="p">,</span><span class="w"> </span><span class="n">DrawCallbacks</span><span class="w"> </span><span class="n">callbacks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="c1">// 1.从DecorView根节点出发，递归遍历View控件树，记录每个View节点的绘制操作命令，完成绘制操作命令树的构建</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">    </span><span class="n">updateRootDisplayList</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">callbacks</span><span class="p">);</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">    </span><span class="c1">// 2.JNI调用同步Java层构建的绘制命令树到Native层的RenderThread渲染线程，并唤醒渲染线程利用OpenGL执行渲染任务；</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">syncResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syncAndDrawFrame</span><span class="p">(</span><span class="n">choreographer</span><span class="p">.</span><span class="na">mFrameInfo</span><span class="p">);</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="p">}</span>
</code></pre></div>
<p>从上面的代码可以看出，<strong>硬件加速绘制主要包括两个阶段</strong>：</p>
<ol>
<li>从<code>DecorView</code>根节点出发，递归遍历<code>View</code>控件树，记录每个<code>View</code>节点的<code>drawOp</code>绘制操作命令，完成绘制操作命令树的构建；</li>
<li><code>JNI</code>调用同步<code>Java</code>层构建的绘制命令树到<code>Native</code>层的<code>RenderThread</code>渲染线程，并唤醒渲染线程利用<code>OpenGL</code>执行渲染任务；</li>
</ol>
<h3 id="51">5.1 构建绘制命令树<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<p>我们先来看看第一阶段构建绘制命令树的代码简化流程：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="cm">/*frameworks/base/core/java/android/view/ThreadedRenderer.java*/</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateRootDisplayList</span><span class="p">(</span><span class="n">View</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">DrawCallbacks</span><span class="w"> </span><span class="n">callbacks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">        </span><span class="c1">// 原生标记构建View绘制操作命令树过程的systrace tag</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_VIEW</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Record View#draw()&quot;</span><span class="p">);</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="c1">// 递归子View的updateDisplayListIfDirty实现构建DisplayListOp</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">        </span><span class="n">updateViewTreeDisplayList</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mRootNodeNeedsUpdate</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">mRootNode</span><span class="p">.</span><span class="na">hasDisplayList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">            </span><span class="c1">// 获取根View的SkiaRecordingCanvas</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">            </span><span class="n">RecordingCanvas</span><span class="w"> </span><span class="n">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mRootNode</span><span class="p">.</span><span class="na">beginRecording</span><span class="p">(</span><span class="n">mSurfaceWidth</span><span class="p">,</span><span class="w"> </span><span class="n">mSurfaceHeight</span><span class="p">);</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">                </span><span class="p">...</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">                </span><span class="c1">// 利用canvas缓存DisplayListOp绘制命令</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">                </span><span class="n">canvas</span><span class="p">.</span><span class="na">drawRenderNode</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="na">updateDisplayListIfDirty</span><span class="p">());</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">                </span><span class="p">...</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">                </span><span class="c1">// 将所有DisplayListOp绘制命令填充到RootRenderNode中</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">                </span><span class="n">mRootNode</span><span class="p">.</span><span class="na">endRecording</span><span class="p">();</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_VIEW</span><span class="p">);</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="p">}</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateViewTreeDisplayList</span><span class="p">(</span><span class="n">View</span><span class="w"> </span><span class="n">view</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">        </span><span class="c1">// 从DecorView根节点出发，开始递归调用每个View树节点的updateDisplayListIfDirty函数</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="w">        </span><span class="n">view</span><span class="p">.</span><span class="na">updateDisplayListIfDirty</span><span class="p">();</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="p">}</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="cm">/*frameworks/base/core/java/android/view/View.java*/</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="kd">public</span><span class="w"> </span><span class="n">RenderNode</span><span class="w"> </span><span class="nf">updateDisplayListIfDirty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">     </span><span class="c1">// 1.利用`View`对象构造时创建的`RenderNode`获取一个`SkiaRecordingCanvas`“画布”；</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">     </span><span class="kd">final</span><span class="w"> </span><span class="n">RecordingCanvas</span><span class="w"> </span><span class="n">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">renderNode</span><span class="p">.</span><span class="na">beginRecording</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">     </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mPrivateFlags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PFLAG_SKIP_DRAW</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PFLAG_SKIP_DRAW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">              </span><span class="c1">// 如果仅仅是ViewGroup，并且自身不用绘制，直接递归子View</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="w">              </span><span class="n">dispatchDraw</span><span class="p">(</span><span class="n">canvas</span><span class="p">);</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">              </span><span class="p">...</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">              </span><span class="c1">// 2.利用SkiaRecordingCanvas，在每个子View控件的onDraw绘制函数中调用drawLine、drawRect等绘制操作时，创建对应的DisplayListOp绘制命令，并缓存记录到其内部的SkiaDisplayList持有的DisplayListData中；</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="w">              </span><span class="n">draw</span><span class="p">(</span><span class="n">canvas</span><span class="p">);</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">         </span><span class="p">}</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">         </span><span class="c1">// 3.将包含有`DisplayListOp`绘制命令缓存的`SkiaDisplayList`对象设置填充到`RenderNode`中；</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="w">         </span><span class="n">renderNode</span><span class="p">.</span><span class="na">endRecording</span><span class="p">();</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="w">         </span><span class="p">...</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a><span class="p">}</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">Canvas</span><span class="w"> </span><span class="n">canvas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="w">    </span><span class="c1">// draw the content(View自己实现的onDraw绘制，由应用开发者自己实现)</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a><span class="w">    </span><span class="n">onDraw</span><span class="p">(</span><span class="n">canvas</span><span class="p">);</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="w">    </span><span class="c1">// draw the children</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="w">    </span><span class="n">dispatchDraw</span><span class="p">(</span><span class="n">canvas</span><span class="p">);</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="p">}</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="cm">/*frameworks/base/graphics/java/android/graphics/RenderNode.java*/</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">endRecording</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="w">        </span><span class="c1">// 从SkiaRecordingCanvas中获取SkiaDisplayList对象</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">displayList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">canvas</span><span class="p">.</span><span class="na">finishRecording</span><span class="p">();</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="w">        </span><span class="c1">// 将SkiaDisplayList对象填充到RenderNode中</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a><span class="w">        </span><span class="n">nSetDisplayList</span><span class="p">(</span><span class="n">mNativeRenderNode</span><span class="p">,</span><span class="w"> </span><span class="n">displayList</span><span class="p">);</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a><span class="w">        </span><span class="n">canvas</span><span class="p">.</span><span class="na">recycle</span><span class="p">();</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a><span class="p">}</span>
</code></pre></div>
<p>从以上代码可以看出，<strong>构建绘制命令树的过程是从<code>View</code>控件树的根节点<code>DecorView</code>触发，递归调用每个子<code>View</code>节点的<code>updateDisplayListIfDirty</code>函数，最终完成绘制树的创建，简述流程如下</strong>：</p>
<ol>
<li>利用<code>View</code>对象构造时创建的<code>RenderNode</code>获取一个<code>SkiaRecordingCanvas</code>“画布”；</li>
<li>利用<code>SkiaRecordingCanvas</code>，<strong>在每个子<code>View</code>控件的<code>onDraw</code>绘制函数中调用<code>drawLine</code>、<code>drawRect</code>等绘制操作时，创建对应的<code>DisplayListOp</code>绘制命令，并缓存记录到其内部的<code>SkiaDisplayList</code>持有的<code>DisplayListData</code>中</strong>；</li>
<li>将包含有<code>DisplayListOp</code>绘制命令缓存的<code>SkiaDisplayList</code>对象设置填充到<code>RenderNode</code>中；</li>
<li>最后将根<code>View</code>的缓存<code>DisplayListOp</code>设置到<code>RootRenderNode</code>中，完成构建。</li>
</ol>
<p>以上整个构建绘制命令树的过程可以用如下流程图表示：</p>
<p><a class="glightbox" href="../assets/26874665-20529fa058c44a07.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-20529fa058c44a07.webp" /></a></p>
<p>硬件加速下的整个界面的<code>View</code>树的结构如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-6f1b95b11f3fe294.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-6f1b95b11f3fe294.webp" /></a></p>
<p>最后从<code>Systrace</code>上看这个过程如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-b94a5aeb293a3dad.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-b94a5aeb293a3dad.webp" /></a></p>
<h3 id="52">5.2 执行渲染绘制任务<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<p>经过上一小节中的分析，应用在<code>UI</code>线程中从根节点<code>DecorView</code>出发，递归遍历每个子<code>View</code>节点，搜集其<code>drawXXX</code>绘制动作并转换成<code>DisplayListOp</code>命令，将其记录到<code>DisplayListData</code>并填充到<code>RenderNode</code>中，最终完成整个<code>View</code>绘制命令树的构建。从此UI线程的绘制任务就完成了。下一步<code>UI</code>线程将唤醒<code>RenderThread</code>渲染线程，触发其利用<code>OpenGL</code>执行界面的渲染任务，本小节中我们将重点分析这个流程。我们还是先看看这块代码的简化流程：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cm">/*frameworks/base/graphics/java/android/graphics/HardwareRenderer.java*/</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">syncAndDrawFrame</span><span class="p">(</span><span class="err">@</span><span class="n">NonNull</span><span class="w"> </span><span class="n">FrameInfo</span><span class="w"> </span><span class="n">frameInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="c1">// JNI调用native层的相关函数</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nSyncAndDrawFrame</span><span class="p">(</span><span class="n">mNativeProxy</span><span class="p">,</span><span class="w"> </span><span class="n">frameInfo</span><span class="p">.</span><span class="n">frameInfo</span><span class="p">,</span><span class="w"> </span><span class="n">frameInfo</span><span class="p">.</span><span class="n">frameInfo</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="p">}</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="cm">/*frameworks/base/libs/hwui/jni/android_graphics_HardwareRenderer.cpp*/</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">android_view_ThreadedRenderer_syncAndDrawFrame</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">        </span><span class="n">jlong</span><span class="w"> </span><span class="n">proxyPtr</span><span class="p">,</span><span class="w"> </span><span class="n">jlongArray</span><span class="w"> </span><span class="n">frameInfo</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">frameInfoSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="n">RenderProxy</span><span class="o">*</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">RenderProxy</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">proxyPtr</span><span class="p">);</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetLongArrayRegion</span><span class="p">(</span><span class="n">frameInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">frameInfoSize</span><span class="p">,</span><span class="w"> </span><span class="n">proxy</span><span class="o">-&gt;</span><span class="n">frameInfo</span><span class="p">());</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">proxy</span><span class="o">-&gt;</span><span class="n">syncAndDrawFrame</span><span class="p">();</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="p">}</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="cm">/*frameworks/base/libs/hwui/renderthread/RenderProxy.cpp*/</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">RenderProxy::syncAndDrawFrame</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="c1">// 唤醒RenderThread渲染线程，执行DrawFrame绘制任务</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mDrawFrameTask</span><span class="p">.</span><span class="n">drawFrame</span><span class="p">();</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="p">}</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="cm">/*frameworks/base/libs/hwui/renderthread/DrawFrameTask.cpp*/</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="kt">int</span><span class="w"> </span><span class="nf">DrawFrameTask::drawFrame</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">    </span><span class="n">postAndWait</span><span class="p">();</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="p">}</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="kt">void</span><span class="w"> </span><span class="nf">DrawFrameTask::postAndWait</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">    </span><span class="n">AutoMutex</span><span class="w"> </span><span class="n">_lock</span><span class="p">(</span><span class="n">mLock</span><span class="p">);</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">    </span><span class="c1">// 向RenderThread渲染线程的MessageQueue消息队列放入一个待执行任务，以将其唤醒执行run函数</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">    </span><span class="n">mRenderThread</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">().</span><span class="n">post</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="p">();</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">    </span><span class="c1">// UI线程暂时进入wait等待状态</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">    </span><span class="n">mSignal</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">mLock</span><span class="p">);</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="p">}</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a><span class="kt">void</span><span class="w"> </span><span class="nf">DrawFrameTask::run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a><span class="w">    </span><span class="c1">// 原生标识一帧渲染绘制任务的systrace tag</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span class="w">    </span><span class="n">ATRACE_NAME</span><span class="p">(</span><span class="s">&quot;DrawFrame&quot;</span><span class="p">);</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a><span class="w">        </span><span class="n">TreeInfo</span><span class="w"> </span><span class="n">info</span><span class="p">(</span><span class="n">TreeInfo</span><span class="o">::</span><span class="n">MODE_FULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mContext</span><span class="p">);</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span class="w">        </span><span class="c1">//1.将UI线程构建的DisplayListOp绘制命令树同步到RenderThread渲染线程</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a><span class="w">        </span><span class="n">canUnblockUiThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syncFrameState</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a><span class="w">    </span><span class="c1">// 同步完成后则可以唤醒UI线程</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">canUnblockUiThread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a><span class="w">        </span><span class="n">unblockUiThread</span><span class="p">();</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CC_LIKELY</span><span class="p">(</span><span class="n">canDrawThisFrame</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a><span class="w">        </span><span class="c1">// 2.执行draw渲染绘制动作</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a><span class="w">        </span><span class="n">context</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">();</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a><span class="p">}</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">DrawFrameTask::syncFrameState</span><span class="p">(</span><span class="n">TreeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span class="w">    </span><span class="c1">// 调用CanvasContext的prepareTree函数实现绘制命令树同步的流程</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a><span class="w">    </span><span class="n">mContext</span><span class="o">-&gt;</span><span class="n">prepareTree</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">mFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="n">mSyncQueued</span><span class="p">,</span><span class="w"> </span><span class="n">mTargetNode</span><span class="p">);</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a><span class="p">}</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a><span class="cm">/*frameworks/base/libs/hwui/renderthread/CanvasContext.cpp*/</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a><span class="kt">void</span><span class="w"> </span><span class="nf">CanvasContext::prepareTree</span><span class="p">(</span><span class="n">TreeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="o">*</span><span class="w"> </span><span class="n">uiFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">syncQueued</span><span class="p">,</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a><span class="w">                                </span><span class="n">RenderNode</span><span class="o">*</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a><span class="w">     </span><span class="p">...</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">RenderNode</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mRenderNodes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a><span class="w">        </span><span class="c1">// 递归调用各个子View对应的RenderNode执行prepareTree动作</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a><span class="w">        </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">prepareTree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a><span class="p">}</span>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a><span class="cm">/*frameworks/base/libs/hwui/RenderNode.cpp*/</span>
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a><span class="kt">void</span><span class="w"> </span><span class="nf">RenderNode::prepareTree</span><span class="p">(</span><span class="n">TreeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a><span class="w">    </span><span class="n">prepareTreeImpl</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a><span class="p">}</span>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a><span class="kt">void</span><span class="w"> </span><span class="nf">RenderNode::prepareTreeImpl</span><span class="p">(</span><span class="n">TreeObserver</span><span class="o">&amp;</span><span class="w"> </span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">TreeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">functorsNeedLayer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TreeInfo</span><span class="o">::</span><span class="n">MODE_FULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a><span class="w">        </span><span class="c1">// 同步绘制命令树</span>
<a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a><span class="w">        </span><span class="n">pushStagingDisplayListChanges</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mDisplayList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a><span class="w">        </span><span class="c1">// 遍历调用各个子View对应的RenderNode的prepareTreeImpl</span>
<a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">isDirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">prepareListAndChildren</span><span class="p">(</span>
<a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a><span class="w">                </span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">childFunctorsNeedLayer</span><span class="p">,</span>
<a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a><span class="w">                </span><span class="p">[](</span><span class="n">RenderNode</span><span class="o">*</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">TreeObserver</span><span class="o">&amp;</span><span class="w"> </span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">TreeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span>
<a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a><span class="w">                   </span><span class="kt">bool</span><span class="w"> </span><span class="n">functorsNeedLayer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a><span class="w">                    </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">prepareTreeImpl</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">functorsNeedLayer</span><span class="p">);</span>
<a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a><span class="w">                </span><span class="p">});</span>
<a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a><span class="p">}</span>
<a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>
<a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a><span class="kt">void</span><span class="w"> </span><span class="nf">RenderNode::pushStagingDisplayListChanges</span><span class="p">(</span><span class="n">TreeObserver</span><span class="o">&amp;</span><span class="w"> </span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">TreeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a><span class="w">    </span><span class="n">syncDisplayList</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a><span class="p">}</span>
<a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>
<a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a><span class="kt">void</span><span class="w"> </span><span class="nf">RenderNode::syncDisplayList</span><span class="p">(</span><span class="n">TreeObserver</span><span class="o">&amp;</span><span class="w"> </span><span class="n">observer</span><span class="p">,</span><span class="w"> </span><span class="n">TreeInfo</span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a><span class="w">    </span><span class="c1">// 完成赋值同步DisplayList对象</span>
<a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a><span class="w">    </span><span class="n">mDisplayList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStagingDisplayList</span><span class="p">;</span>
<a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a><span class="w">    </span><span class="n">mStagingDisplayList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a><span class="p">}</span>
<a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>
<a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a><span class="kt">void</span><span class="w"> </span><span class="nf">CanvasContext::draw</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a><span class="w">    </span><span class="c1">// 1.调用OpenGL库使用GPU，按照构建好的绘制命令完成界面的渲染</span>
<a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">drew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mRenderPipeline</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">windowDirty</span><span class="p">,</span><span class="w"> </span><span class="n">dirty</span><span class="p">,</span><span class="w"> </span><span class="n">mLightGeometry</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mLayerUpdateQueue</span><span class="p">,</span>
<a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a><span class="w">                                      </span><span class="n">mContentDrawBounds</span><span class="p">,</span><span class="w"> </span><span class="n">mOpaque</span><span class="p">,</span><span class="w"> </span><span class="n">mLightInfo</span><span class="p">,</span><span class="w"> </span><span class="n">mRenderNodes</span><span class="p">,</span>
<a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a><span class="w">                                      </span><span class="o">&amp;</span><span class="p">(</span><span class="n">profiler</span><span class="p">()));</span>
<a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a><span class="w">    </span><span class="c1">// 2.将前面已经绘制渲染好的图形缓冲区Binder上帧给SurfaceFlinger合成和显示</span>
<a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">didSwap</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a><span class="w">            </span><span class="n">mRenderPipeline</span><span class="o">-&gt;</span><span class="n">swapBuffers</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">drew</span><span class="p">,</span><span class="w"> </span><span class="n">windowDirty</span><span class="p">,</span><span class="w"> </span><span class="n">mCurrentFrameInfo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">requireSwap</span><span class="p">);</span>
<a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a><span class="p">}</span>
</code></pre></div>
<p>从以上代码可以看出：<code>UI</code>线程利用<code>RenderProxy</code>向<code>RenderThread</code>线程发送一个<code>DrawFrameTask</code>任务请求，<strong><code>RenderThread</code>被唤醒，开始渲染，大致流程如下</strong>：</p>
<ol>
<li><code>syncFrameState</code>中遍历<code>View</code>树上每一个<code>RenderNode</code>，执行<code>prepareTreeImpl</code>函数，实现同步绘制命令树的操作；</li>
<li>调用<code>OpenGL</code>库<code>API</code>使用<code>GPU</code>硬件，按照构建好的绘制命令完成界面的渲染（具体过程，由于本文篇幅所限，暂不展开分析）；</li>
<li>将前面已经绘制渲染好的图形缓冲区<code>Binder</code>上帧给<code>SurfaceFlinger</code>合成和显示；</li>
</ol>
<p>整个过程可以用如下流程图表示：</p>
<p><a class="glightbox" href="../assets/26874665-a849cafb9e09dc39.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-a849cafb9e09dc39.webp" /></a></p>
<p>从<code>Systrace</code>上这个过程如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-f4ce565d0be1d9da.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-f4ce565d0be1d9da.webp" /></a></p>
<h2 id="6-surfaceflinger">6 SurfaceFlinger图形合成<a class="headerlink" href="#6-surfaceflinger" title="Permanent link">&para;</a></h2>
<p><code>SurfaceFlinger</code>合成显示部分属于<code>Android</code>系统<code>GUI</code>中图形显示的内容，简单的说<code>SurfaceFlinger</code>作为系统中独立运行的一个<code>Native</code>进程，<strong>借用<code>Android</code>官网的描述，其职责就是负责接受来自多个来源的数据缓冲区，对它们进行合成，然后发送到显示设备</strong>。如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-e7f57fd02b8effb1.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-e7f57fd02b8effb1.webp" /></a></p>
<p>从上图可以看出，其实<code>SurfaceFlinger</code>在<code>Android</code>系统的整个图形显示系统中是起到一个 <strong>承上启下的作用</strong>：</p>
<ul>
<li><strong>对上</strong>：通过<code>Surface</code>与不同的应用进程建立联系，接收它们写入<code>Surface</code>中的绘制缓冲数据，对它们进行统一合成。</li>
<li><strong>对下</strong>：通过屏幕的后缓存区与屏幕建立联系，发送合成好的数据到屏幕显示设备。</li>
</ul>
<p>图形的传递是通过<code>Buffer</code>作为载体，<code>Surface</code>是对<code>Buffer</code>的进一步封装，也就是说<code>Surface</code>内部具有多个<code>Buffer</code>供上层使用，如何管理这些<code>Buffer</code>呢？答案就是<code>BufferQueue</code> ，下面我们来看看<code>BufferQueue</code>的工作原理：</p>
<h3 id="61-bufferqueue">6.1 BufferQueue机制<a class="headerlink" href="#61-bufferqueue" title="Permanent link">&para;</a></h3>
<p>借用一张经典的图来描述<code>BufferQueue</code>的工作原理：</p>
<p><a class="glightbox" href="../assets/26874665-23d55ad35fecf5dd.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-23d55ad35fecf5dd.webp" /></a></p>
<p>BufferQueue状态转换图.jpg</p>
<p><code>BufferQueue</code>是一个典型的 <strong>生产者-消费者模型</strong> 中的数据结构。在<code>Android</code>应用的渲染流程中，应用扮演的就是“生产者”的角色，而<code>SurfaceFlinger</code>扮演的则是“消费者”的角色，<strong>其配合工作的流程如下</strong>：</p>
<ol>
<li>应用进程中在开始界面的绘制渲染之前，需要通过<code>Binder</code>调用<code>dequeueBuffer</code>接口从<code>SurfaceFlinger</code>进程中管理的<code>BufferQueue</code> 中申请一张处于<code>free</code>状态的可用<code>Buffer</code>，如果此时没有可用<code>Buffer</code>则阻塞等待；</li>
<li>应用进程中拿到这张可用的<code>Buffer</code>之后，选择使用<code>CPU</code>软件绘制渲染或<code>GPU</code>硬件加速绘制渲染，渲染完成后再通过<code>Binder</code>调用<code>queueBuffer</code>接口将缓存数据返回给应用进程对应的<code>BufferQueue</code>（如果是 <code>GPU</code> 渲染的话，这里还有个 <code>GPU</code>处理的过程，所以这个 <code>Buffer</code> 不会马上可用，需要等 <code>GPU</code> 渲染完成的<code>Fence</code>信号），并申请<code>sf</code>类型的<code>Vsync</code>以便唤醒“消费者”<code>SurfaceFlinger</code>进行消费；</li>
<li><code>SurfaceFlinger</code> 在收到 <code>Vsync</code> 信号之后，开始准备合成，使用 <code>acquireBuffer</code>获取应用对应的 <code>BufferQueue</code> 中的 <code>Buffer</code> 并进行合成操作；</li>
<li>合成结束后，<code>SurfaceFlinger</code> 将通过调用 <code>releaseBuffer</code>将 <code>Buffer</code> 置为可用的<code>free</code>状态，返回到应用对应的 <code>BufferQueue</code>中。</li>
</ol>
<h3 id="62-vsync">6.2 Vsync同步机制<a class="headerlink" href="#62-vsync" title="Permanent link">&para;</a></h3>
<p>在之前<code>3.3</code>小节关于<code>Android</code>系统屏幕刷新机制中我们分析了<code>Vsync</code>机制的来龙去脉。其实<code>Android</code>系统中的<code>Vsync</code>信号的产生与管理都是由<code>SurfaceFlinger</code>模块统一负责的，<code>Vysnc</code>信号一般分为两种类型：</p>
<ol>
<li><code>app</code>类型的<code>Vsync</code>：<strong><code>app</code>类型的<code>Vysnc</code>信号由上层应用中的<code>Choreographer</code>根据绘制需求进行注册和接收，用于控制应用UI绘制上帧的生产节奏</strong>。根据<code>3.4</code>小结中的分析：应用在UI线程中调用<code>invalidate</code>刷新界面绘制时，需要先透过<code>Choreographer</code>向系统申请注册<code>app</code>类型的<code>Vsync</code>信号，待<code>Vsync</code>信号到来后，才能往主线程的消息队列放入待绘制任务进行真正<code>UI</code>的绘制动作；</li>
<li><code>sf</code>类型的<code>Vsync</code>:<strong><code>sf</code>类型的<code>Vsync</code>是用于控制<code>SurfaceFlinger</code>的合成消费节奏</strong>。应用完成界面的绘制渲染后，通过<code>Binder</code>调用<code>queueBuffer</code>接口将缓存数据返还给应用对应的<code>BufferQueue</code>时，会申请<code>sf</code>类型的<code>Vsync</code>，待<code>SurfaceFlinger</code> 在其UI线程中收到 <code>Vsync</code> 信号之后，便开始进行界面的合成操作。</li>
</ol>
<p><strong><code>Vsync</code>信号的生成是参考屏幕硬件的刷新周期的</strong>，其架构如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-04b831a664ca42a5.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-04b831a664ca42a5.webp" /></a></p>
<h3 id="63">6.3 帧数据的提交消费过程<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<p>我们接着<code>3.5.2</code>小节中的分析，应用进程的<code>RenderThread</code>渲染线程在执行完一帧画面的渲染操作的最后，会通过<code>Binder</code>调用<code>queueBuffer</code>接口将一帧数据提交给<code>SurfaceFlinger</code>进程进行消费合成显示。我们结合相关简化的源码流程（这里基于<code>Android 11</code>源代码分析）来看看<code>SurfaceFlinger</code>中是如何处理应用的请求的。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cm">/*frameworks/native/libs/gui/BufferQueueProducer.cpp*/</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">status_t</span><span class="w"> </span><span class="nf">BufferQueueProducer::queueBuffer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">QueueBufferInput</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">QueueBufferOutput</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frameAvailableListener</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="n">frameAvailableListener</span><span class="o">-&gt;</span><span class="n">onFrameAvailable</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="p">}</span>
</code></pre></div>
<p>上面的<code>frameAvailableListener</code>是<code>BufferQueueLayer</code>：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="cm">/*frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp*/</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BufferQueueLayer::onFrameAvailable</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">BufferItem</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">     </span><span class="n">mFlinger</span><span class="o">-&gt;</span><span class="n">signalLayerUpdate</span><span class="p">();</span><span class="c1">//这里触发申请一下个Vsync-sf信号</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="p">}</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="cm">/*frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp*/</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">SurfaceFlinger::signalLayerUpdate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="n">mEventQueue</span><span class="o">-&gt;</span><span class="n">invalidate</span><span class="p">();</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="p">}</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="cm">/*frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp*/</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MessageQueue::invalidate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">    </span><span class="n">mEvents</span><span class="o">-&gt;</span><span class="n">requestNextVsync</span><span class="p">();</span><span class="c1">// 申请一下个Vsync-sf信号</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="p">}</span>
</code></pre></div>
<p>以上过程从<code>Systrace</code>上看如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-f6784d876edd3964.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-f6784d876edd3964.webp" /></a></p>
<p><a class="glightbox" href="../assets/26874665-db743387780c416e.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-db743387780c416e.webp" /></a></p>
<p>由上面分析可知，只要有<code>layer</code>上帧，那么就会申请下一次的<code>Vsync-sf</code>信号， 当<code>Vsync-sf</code>信号来时会调用<code>onMessageReceived</code>函数来处理帧数据：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="cm">/*frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp*/</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">SurfaceFlinger::onMessageInvalidate</span><span class="p">(</span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">expectedVSyncTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">refreshNeeded</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">handleMessageInvalidate</span><span class="p">();</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="n">signalRefresh</span><span class="p">();</span><span class="c1">//再次向消息队列发送一个消息，消息到达时会调用onMessageRefresh</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="p">}</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">SurfaceFlinger::handleMessageInvalidate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">refreshNeeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handlePageFlip</span><span class="p">();</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="p">}</span>
</code></pre></div>
<p>在<code>handleMessageInvalidate</code>里一个比较重要的函数是<code>handlePageFlip</code>():</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="cm">/*frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp*/</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kt">bool</span><span class="w"> </span><span class="n">SurfaceFlinger</span>::<span class="n">handlePageFlip</span><span class="p">()</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="p">{</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="o">......</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="n">mDrawingState</span><span class="p">.</span><span class="n">traverse</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Layer</span><span class="o">*</span><span class="w"> </span><span class="n">layer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span>-&gt;<span class="nc">hasReadyFrame</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">            </span><span class="n">frameQueued</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span>-&gt;<span class="nc">shouldPresentNow</span><span class="p">(</span><span class="n">expectedPresentTime</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">                </span><span class="n">mLayersWithQueuedFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">layer</span><span class="p">);</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">            </span><span class="o">......</span><span class="p">.</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">        </span><span class="o">......</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">    </span><span class="o">......</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span>: <span class="nc">mLayersWithQueuedFrames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span>-&gt;<span class="nc">latchBuffer</span><span class="p">(</span><span class="n">visibleRegions</span><span class="p">,</span><span class="w"> </span><span class="n">latchTime</span><span class="p">,</span><span class="w"> </span><span class="n">expectedPresentTime</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">                </span><span class="n">mLayersPendingRefresh</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">layer</span><span class="p">);</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">            </span><span class="o">......</span><span class="p">.</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">     </span><span class="o">......</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="p">}</span>
</code></pre></div>
<p>这里可以看出来，<code>handlePageFlip</code>里一个重要的工作是检查所有的<code>Layer</code>是否有新<code>Buffer</code>提交，如果有则调用其<code>latchBuffer</code>来处理：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="cm">/*frameworks/native/services/surfaceflinger/BufferLayer.cpp*/</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">BufferLayer::latchBuffer</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">recomputeVisibleRegions</span><span class="p">,</span><span class="w"> </span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">latchTime</span><span class="p">,</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">                              </span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">expectedPresentTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="n">status_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateTexImage</span><span class="p">(</span><span class="n">recomputeVisibleRegions</span><span class="p">,</span><span class="w"> </span><span class="n">latchTime</span><span class="p">,</span><span class="w"> </span><span class="n">expectedPresentTime</span><span class="p">);</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">}</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="cm">/*frameworks/native/services/surfaceflinger/BufferQueuedLayer.cpp*/</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="n">status_t</span><span class="w"> </span><span class="nf">BufferQueueLayer::updateTexImage</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">recomputeVisibleRegions</span><span class="p">,</span><span class="w"> </span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">latchTime</span><span class="p">,</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">                                          </span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">expectedPresentTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">     </span><span class="p">......</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">     </span><span class="n">status_t</span><span class="w"> </span><span class="n">updateResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mConsumer</span><span class="o">-&gt;</span><span class="n">updateTexImage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">expectedPresentTime</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mAutoRefresh</span><span class="p">,</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">                                                      </span><span class="o">&amp;</span><span class="n">queuedBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">maxFrameNumberToAcquire</span><span class="p">);</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">     </span><span class="p">......</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="p">}</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="cm">/*frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp*/</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="n">status_t</span><span class="w"> </span><span class="nf">BufferLayerConsumer::updateTexImage</span><span class="p">(</span><span class="n">BufferRejecter</span><span class="o">*</span><span class="w"> </span><span class="n">rejecter</span><span class="p">,</span><span class="w"> </span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">expectedPresentTime</span><span class="p">,</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">                                             </span><span class="kt">bool</span><span class="o">*</span><span class="w"> </span><span class="n">autoRefresh</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">*</span><span class="w"> </span><span class="n">queuedBuffer</span><span class="p">,</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">                                             </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">maxFrameNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">    </span><span class="n">status_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acquireBufferLocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">expectedPresentTime</span><span class="p">,</span><span class="w"> </span><span class="n">maxFrameNumber</span><span class="p">);</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="p">}</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="n">status_t</span><span class="w"> </span><span class="nf">ConsumerBase::acquireBufferLocked</span><span class="p">(</span><span class="n">BufferItem</span><span class="w"> </span><span class="o">*</span><span class="n">item</span><span class="p">,</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">        </span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">presentWhen</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">maxFrameNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w">    </span><span class="n">status_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mConsumer</span><span class="o">-&gt;</span><span class="n">acquireBuffer</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">presentWhen</span><span class="p">,</span><span class="w"> </span><span class="n">maxFrameNumber</span><span class="p">);</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="p">}</span>
</code></pre></div>
<p>这里调用到了<code>BufferLayerConsumer</code>的基类<code>ConsumerBase</code>里：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="cm">/*frameworks/native/libs/gui/ConsumerBase.cpp*/</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">status_t</span><span class="w"> </span><span class="nf">ConsumerBase::acquireBufferLocked</span><span class="p">(</span><span class="n">BufferItem</span><span class="w"> </span><span class="o">*</span><span class="n">item</span><span class="p">,</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">        </span><span class="n">nsecs_t</span><span class="w"> </span><span class="n">presentWhen</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">maxFrameNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="n">status_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mConsumer</span><span class="o">-&gt;</span><span class="n">acquireBuffer</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">presentWhen</span><span class="p">,</span><span class="w"> </span><span class="n">maxFrameNumber</span><span class="p">);</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="p">}</span>
</code></pre></div>
<p>到这里<code>onMessageInvalidate</code>中的主要工作结束，在这个函数的处理中：<strong><code>SurfaceFlinger</code>主要是检查每个<code>Layer</code>是否有新提交的<code>Buffer</code>， 如果有则调用<code>latchBuffer</code>将每个<code>BufferQueue</code>中的<code>Slot</code> 通过<code>acquireBuffer</code>拿走</strong>。此过程从<code>Systrace</code>上看如下图有所示：</p>
<p><a class="glightbox" href="../assets/26874665-5ae751371232e148.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-5ae751371232e148.webp" /></a></p>
<p>之后<code>acquireBuffer</code>拿走的<code>Buffer</code>(<code>Slot</code>对应的状态是<code>ACQUIRED</code>状态)会被交由<code>HWC``Service</code>处理，这部分是在<code>onMessageRefresh</code>中处理的：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cm">/*frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp*/</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">SurfaceFlinger::onMessageRefresh</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="n">mCompositionEngine</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">(</span><span class="n">refreshArgs</span><span class="p">);</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="err">｝</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="cm">/*frameworks/native/services/surfaceflinger/CompositionEngine/src/CompositionEngine.cpp*/</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="kt">void</span><span class="w"> </span><span class="n">CompositionEngine</span><span class="o">::</span><span class="n">present</span><span class="p">(</span><span class="n">CompositionRefreshArgs</span><span class="o">&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">outputs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">        </span><span class="n">output</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="p">}</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="cm">/*frameworks/native/services/surfaceflinger/CompositionEngine/src/Output.cpp*/</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="kt">void</span><span class="w"> </span><span class="n">Output</span><span class="o">::</span><span class="n">present</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">compositionengine</span><span class="o">::</span><span class="n">CompositionRefreshArgs</span><span class="o">&amp;</span><span class="w"> </span><span class="n">refreshArgs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">    </span><span class="n">updateAndWriteCompositionState</span><span class="p">(</span><span class="n">refreshArgs</span><span class="p">);</span><span class="c1">//告知HWC service有哪些layer要参与合成</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">    </span><span class="n">beginFrame</span><span class="p">();</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">    </span><span class="n">prepareFrame</span><span class="p">();</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">    </span><span class="n">finishFrame</span><span class="p">(</span><span class="n">refreshArgs</span><span class="p">);</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">    </span><span class="n">postFramebuffer</span><span class="p">();</span><span class="c1">//这里会调用到HWC service的接口去present display合成画面</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="p">}</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="kt">void</span><span class="w"> </span><span class="n">Output</span><span class="o">::</span><span class="n">postFramebuffer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">presentAndGetFrameFences</span><span class="p">();</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="p">}</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="cm">/*frameworks/native/services/surfaceflinger/displayhardware/HWComposer.cpp*/</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a><span class="n">status_t</span><span class="w"> </span><span class="n">HWComposer</span><span class="o">::</span><span class="n">presentAndGetReleaseFences</span><span class="p">(</span><span class="n">DisplayId</span><span class="w"> </span><span class="n">displayId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a><span class="w">    </span><span class="n">ATRACE_CALL</span><span class="p">();</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwcDisplay</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">(</span><span class="o">&amp;</span><span class="n">displayData</span><span class="p">.</span><span class="n">lastPresentFence</span><span class="p">);</span><span class="c1">//送去HWC service合成</span>
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">HWC2</span><span class="o">::</span><span class="n">Layer</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">Fence</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">releaseFences</span><span class="p">;</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a><span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwcDisplay</span><span class="o">-&gt;</span><span class="n">getReleaseFences</span><span class="p">(</span><span class="o">&amp;</span><span class="n">releaseFences</span><span class="p">);</span>
<a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a><span class="w">    </span><span class="n">RETURN_IF_HWC_ERROR_FOR</span><span class="p">(</span><span class="s">&quot;getReleaseFences&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">displayId</span><span class="p">,</span><span class="w"> </span><span class="n">UNKNOWN_ERROR</span><span class="p">);</span>
<a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a>
<a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a><span class="w">    </span><span class="n">displayData</span><span class="p">.</span><span class="n">releaseFences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">releaseFences</span><span class="p">);</span><span class="c1">//获取releaseFence, 以便通知到各个Slot, buffer被release后会通过dequeueBuffer给到应用，应用在绘图前会等待releaseFence</span>
<a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a><span class="w">    </span><span class="p">......</span>
<a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a><span class="p">}</span>
</code></pre></div>
<p>以上过程从<code>systrace</code>上看如下图所示：</p>
<p><a class="glightbox" href="../assets/26874665-2644e13bdbda7cb0.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-2644e13bdbda7cb0.webp" /></a></p>
<p>最后总结一下应用调用<code>queueBuffer</code>将一帧<code>Buffer</code>数据提到<code>SurfaceFlinger</code>后<code>SurfaceFlinger</code>的主要处理流程，：</p>
<ol>
<li>首先<code>Binder</code>线程会通过<code>BufferQueue</code>机制把应用上帧的<code>Slot</code>状态改为<code>QUEUED</code>, 然后把这个<code>Slot</code>放入<code>mQueue</code>队列， 然后通过<code>onFrameAvailable</code>回调通知到<code>BufferQueueLayer</code>, 在处理函数里会请求下一次的<code>Vsync-sf</code>信号；</li>
<li>在<code>Vsync-sf</code>信号到来后，<code>SurfaceFlinger</code>主线程要执行两次<code>onMessageReceived</code>, 第一次要检查所有的<code>Layer</code>看是否有上帧， 如果有<code>Layer</code>上帧就调用它的<code>latchBuffer</code>把它的<code>Buffer</code>  <code>acquireBuffer</code>取走；并发送一个消息到主消息队列，让主线程再次走进<code>onMessageReceived</code>,；</li>
<li>第二次走进来时，主要执行<code>present</code>方法，在这些方法里会和<code>HWC service</code>沟通，调用它的跨进程接口通知它去做图层的合成后送显示器显示。</li>
</ol>
<p>后续<code>HWC service</code>的合成以及屏幕的详细显示原理由于篇幅有限就不展开说明，感兴趣的读者可以参考系列文章https://<a href="http://www.jianshu.com/p/df46e4b39428">www.jianshu.com/p/df46e4b39428</a>。</p>
<h2 id="7">7 流程总结与卡顿定义<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 应用绘制上帧流程总结<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<p>在本节中我们以用户手指上下滑动应用界面的操作场景为例，结合系统源码和<code>Systrace</code>工具，按照执行顺序分析了<code>Android</code>应用绘制上帧显示的系统运行机制与总体流程，我们以一张图描述如下：</p>
<p><a class="glightbox" href="../assets/26874665-7d1cb09267361b98.webp" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="img" src="../assets/26874665-7d1cb09267361b98.webp" /></a></p>
<p><strong>最后总结整个流程大致如下</strong>：</p>
<ol>
<li>用户手指触摸屏幕后，屏幕驱动产生<code>Input</code>触控事件；框架<code>system_server</code>进程中的<code>EventHub</code>通过<code>epoll</code>机制监听到驱动产生的<code>Input</code>触控事件上报，由<code>InputReader</code>读取到<code>Input</code>事件后，唤醒<code>InputDispatcher</code>找到当前触控焦点应用窗口，并通过事先建立的<code>socket</code>通道发送<code>Input</code>事件到对应的应用进程；</li>
<li>应用进程收到<code>Input</code>触控事件后<code>UI</code>线程被唤醒进行事件的分发，相关<code>View</code>控件中根据多个<code>ACTION_MOVE</code>类型的<code>Input</code>事件判断为用户手指滑动行为后，通过<code>Choreographer</code>向系统注册申请<code>app</code>类型的<code>Vsync</code>信号，并等待<code>Vsync</code>信号到来后触发绘制操作；</li>
<li><code>app</code>类型的<code>Vsync</code>信号到来后，唤醒应用<code>UI</code>线程并向其消息队列中放入一个待执行的绘制任务，在<code>UI</code>线程中先后遍历执行<code>View</code>控件树的测量、布局和绘制（硬件加速默认开启的状态下会遍历并记录每个<code>View</code>的<code>draw</code>操作生成对应的绘制命令树）操作；</li>
<li><code>View</code>控件树的绘制任务执行完成后会唤醒应用的<code>RenderThread</code>渲染线程执行界面渲染任务；整个渲染任务中会先同步<code>UI</code>线程中构建好的绘制命令树，然后通过<code>dequeueBuffer</code>申请一张处于<code>free</code>状态的可用<code>Buffer</code>，然后调用<code>SkiaOpenGLPipeline</code>渲染管道中使用<code>GPU</code>进行渲染操作，渲染完成后<code>swapBuffer</code>触发<code>queueBuffer</code>动作进行上帧；</li>
<li>应用渲染线程最后的<code>queueBuffer</code>上帧动作，会唤醒对端<code>SurfaceFlinger</code>进程中的<code>Binder</code>处理线程，其中将对应用<code>BufferQuque</code>中的<code>Buffer</code>标记为<code>Queued</code>状态，然后注册申请<code>sf</code>类型的<code>Vsync</code>信号；</li>
<li>待<code>sf</code>类型的<code>Vsync</code>信号到来后会唤醒<code>SurfaceFlinger</code>的主线程执行一帧的合成任务，其中会先通过<code>handlePageFlip</code>操作遍历所有的应用<code>Layer</code>找到有上帧操作的处于<code>Queued</code>状态的<code>Buffer</code>进行<code>AcquireBuffer</code>获取标记锁定，然后执行<code>persent</code>动作调用唤醒<code>HWC service</code>进程的工作线程执行具体的图层的合成送显操作；</li>
<li><code>HWC service</code>中最终会收到<code>SurfaceFlinger</code>的请求后，进行图层合成操作，最终通过调用<code>libDrm</code>库相关接口<code>Commit</code>提交<code>Buffer</code>数据到Kernel内核中的屏幕驱动，并最终送到屏幕硬件上显示。</li>
</ol>
<h3 id="72">7.2 卡顿的定义<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<p>根据本节中我们对<code>Android</code>应用上帧显示的原理分析，我们初步可以判断：如果在一个<code>Vsync</code>周期内（<code>60HZ</code>的屏幕上就是<code>16.6ms</code>），按照整个上帧显示的执行的顺序来看，应用<code>UI</code>线程的绘制、<code>RenderThread</code>线程的渲染、<code>SurfaceFlinger/HWC</code>的图层合成以及最终屏幕上的显示这些动作没有全部都执行完成的话，屏幕上就会显示上一帧画面的内容，也就是掉帧，而人的肉眼就可能会感觉到画面卡顿（由于 <code>Triple Buffer</code> 的存在，这里也有可能不掉帧）。</p>
<p>这里借用高爷的一段经典描述从三个方面定义卡顿：</p>
<ol>
<li>从现象上来说，在 <code>App</code> 连续的动画播放或者手指滑动列表时（关键是连续），如果连续 <code>2</code> 帧或者 <code>2</code> 帧以上，应用的画面都没有变化，那么我们认为这里发生了卡顿；</li>
<li>从 <code>SurfaceFlinger</code> 的角度来说，在 <code>App</code> 连续的动画播放或者手指滑动列表时（关键是连续），如果有一个 <code>Vsync</code> 到来的时候 ，<code>App</code> 没有可以用来合成的 <code>Buffer</code>，那么这个 <code>Vsync</code> 周期 <code>SurfaceFlinger</code> 就不会走合成的逻辑（或者是去合成其他的 <code>Layer</code>），那么这一帧就会显示 <code>App</code> 的上一帧的画面，我们认为这里发生了卡顿；</li>
<li>从 <code>App</code> 的角度来看，如果渲染线程在一个 <code>Vsync</code> 周期内没有 <code>queueBuffer</code> 到 <code>SurfaceFlinger</code> 中 <code>App</code> 对应的 <code>BufferQueue</code> 中，那么我们认为这里发生了卡顿。</li>
</ol>
<h2 id="8">8 参考<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>摘自 <a href="https://www.jianshu.com/p/386bbb5fa29a">https://www.jianshu.com/p/386bbb5fa29a</a></p>


  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 - 2026 Adison
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/adisonhuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/adisonhyh" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:adison5321@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.tabs.link", "navigation.sections", "navigation.tabs", "navigation.top", "search.share", "search.suggest", "search.highlight", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>