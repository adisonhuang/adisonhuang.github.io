# 网络优化
## 1. 何为网络优化

一个数据包从手机出发要经过无线网络、核心网络以及外部网络（互联网），才能到达我们的服务器。

![](./assets/3b27d9692bfc276aa16ac2e4c6effede.webp)

那整个网络请求的速度会跟哪些因素有关呢？

![](./assets/d39734690f1241262b0a289acdecbf4d.webp)

从上面这张图上看，客户端网络库实现、服务器性能以及网络链路的质量都是影响网络请求速度的因素。

如果说速度是关键，那对网络传输速度有决定性影响的主要有以下两个方面：

* **延迟**：数据从信息源发送到目的地所需的时间。
* **带宽**：逻辑或物理通信路径最大的吞吐量。

那延迟和带宽又跟什么因素有关呢？这里面涉及的因素也非常多，例如信号的强度、附近有没有基站、距离有多远等；还跟使用的网络制式，正在使用 3G、4G 还是 5G 网络有关，并且网络的拥塞情况也会产生影响，比如是不是在几万人聚集的大型活动场所等。

下面是不同网络制式的带宽和延迟的一般参考值。

![](./assets/368f97424661e9ee3295b8c610fb9b83.webp)

当出现上面说到的那些因素时，网络访问的带宽要大打折扣，延迟会加倍放大。而高延迟、低带宽的网络场景也就是我们常说的“弱网络”，它主要特点有：

![](./assets/773fa40290c39c0f7e402414273c8fd8.webp)

另外一个方面，不同的应用对延迟和带宽的侧重点可能不太一样。对于直播类应用或者“王者荣耀”来说，延迟会更重要一些；对腾讯视频、爱奇艺这种点播的应用来说，带宽会更加重要一些。**网络优化需要结合自己应用的实际情况来综合考虑。**

所谓的网络优化，究竟指的是什么？在我看来，核心内容有以下三个：

* **速度**。在网络正常或者良好的时候，怎样更好地利用带宽，进一步提升网络请求速度。
* **弱网络**。移动端网络复杂多变，在出现网络连接不稳定的时候，怎样最大程度保证网络的连通性。
* **安全**。网络安全不容忽视，怎样有效防止被第三方劫持、窃听甚至篡改。

那对于速度、弱网络以及安全的优化，又该从哪些方面入手呢？首先你需要先搞清楚一个网络请求的整个过程。

![](./assets/8d6e833f2a6c6d1e8beeb92d4579c38b.webp)

从图上看到，整个网络请求主要分为几个步骤，而整个请求的耗时可以细分到每一个步骤里面。

* **DNS 解析**。通过 DNS 服务器，拿到对应域名的 IP 地址。在这个步骤，我们比较关注 DNS 解析耗时情况、运营商 LocalDNS 的劫持、DNS 调度这些问题。
* **创建连接**。跟服务器建立连接，这里包括 TCP 三次握手、TLS 密钥协商等工作。多个 IP/ 端口该如何选择、是否要使用 HTTPS、能否可以减少甚至省下创建连接的时间，这些问题都是我们优化的关键。
* **发送 / 接收数据**。在成功建立连接之后，就可以愉快地跟服务器交互，进行组装数据、发送数据、接收数据、解析数据。我们关注的是，如何根据网络状况将带宽利用好，怎么样快速地侦测到网络延时，在弱网络下如何调整包大小等问题。
* **关闭连接**。连接的关闭看起来非常简单，其实这里的水也很深。这里主要关注主动关闭和被动关闭两种情况，一般我们都希望客户端可以主动关闭连接。

所谓的网络优化，就是围绕速度、弱网络、安全这三个核心内容，减少每一个步骤的耗时，打造快速、稳定且安全的高质量网络。

## 2. 网络性能测量
对于网络来说，我们关心的是下面这些指标：
* **吞吐量**：网络接口接收和传输的每秒字节数。
* **延迟**：系统调用发送 / 接收延时、连接延迟、首包延迟、网络往返时间等。
* **连接数**：每秒的连接数。
* **错误**：丢包计数、超时等。

### 2.1 命令工具

####  **ping**

`ping`命令主要用于测试网络连通性

执行 `ping` 指令会使用 `ICMP` 传输协议，发出要求回应的信息，若远端主机的网络功能没有问题，就会回应该信息，因而得知该主机运作正常。

!!! notes "什么是ICMP"

    因特网控制报文协议`ICMP`（`Internet Control Message Protocol`）是一个差错报告机制，是`TCP/IP`协议簇中的一个重要子协议，通常被IP层或更高层协议（TCP或UDP）使用，属于网络层协议，主要用于在IP主机和路由器之间传递控制消息，用于报告主机是否可达、路由是否可用等。这些控制消息虽然并不传输用户数据，但是对于收集各种网络信息、诊断和排除各种网络故障以及用户数据的传递具有至关重要的作用。
    

**ping 使用**

```bash
ping -c 4 www.baidu.com
```

`-c` 参数指定发送的数据包数量，`4` 表示发送 4 个数据包。

**ping 输出**

```bash
PING www.a.shifen.com (163.177.151.110): 56 data bytes
64 bytes from 163.177.151.110: icmp_seq=0 ttl=53 time=4.636 ms
64 bytes from 163.177.151.110: icmp_seq=1 ttl=53 time=5.344 ms
64 bytes from 163.177.151.110: icmp_seq=2 ttl=53 time=4.884 ms
64 bytes from 163.177.151.110: icmp_seq=3 ttl=53 time=4.810 ms

--- www.a.shifen.com ping statistics ---
4 packets transmitted, 4 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 4.636/4.918/5.344/0.262 ms
```
* bytes值：数据包大小，也就是字节。
* time值：响应时间，这个时间越小，说明你连接这个地址速度越快。
* ttl值：Time To Live,表示DNS记录在DNS服务器上存在的时间，它是IP协议包的一个值，告诉路由器该数据包何时需要被丢弃。

> 更多关于 `ping` 的内容，可以参考 [ping命令](https://www.runoob.com/linux/linux-comm-ping.html)

####  **traceroute**

`traceroute`命令 用于追踪数据包在网络上的传输时的全部路径，它默认发送的数据包大小是40字节。

通过traceroute我们可以知道信息从你的计算机到互联网另一端的主机是走的什么路径。当然每次数据包由某一同样的出发点（source）到达某一同样的目的地(destination)走的路径可能会不一样，但基本上来说大部分时候所走的路由是相同的。

traceroute通过发送小的数据包到目的设备直到其返回，来测量其需要多长时间。一条路径上的每个设备traceroute要测3次。输出结果中包括每次测试的时间(ms)和设备的名称（如有的话）及其ip地址。

**traceroute 使用**

```bash
traceroute www.58.com
traceroute to www.58.com (211.151.111.30), 30 hops max, 40 byte packets
 1  unknown (192.168.2.1)  3.453 ms  3.801 ms  3.937 ms
 2  221.6.45.33 (221.6.45.33)  7.768 ms  7.816 ms  7.840 ms
 3  221.6.0.233 (221.6.0.233)  13.784 ms  13.827 ms 221.6.9.81 (221.6.9.81)  9.758 ms
 4  221.6.2.169 (221.6.2.169)  11.777 ms 122.96.66.13 (122.96.66.13)  34.952 ms 221.6.2.53 (221.6.2.53)  41.372 ms
 5  219.158.96.149 (219.158.96.149)  39.167 ms  39.210 ms  39.238 ms
 6  123.126.0.194 (123.126.0.194)  37.270 ms 123.126.0.66 (123.126.0.66)  37.163 ms  37.441 ms
 7  124.65.57.26 (124.65.57.26)  42.787 ms  42.799 ms  42.809 ms
 8  61.148.146.210 (61.148.146.210)  30.176 ms 61.148.154.98 (61.148.154.98)  32.613 ms  32.675 ms
 9  202.106.42.102 (202.106.42.102)  44.563 ms  44.600 ms  44.627 ms
10  210.77.139.150 (210.77.139.150)  53.302 ms  53.233 ms  53.032 ms
11  211.151.104.6 (211.151.104.6)  39.585 ms  39.502 ms  39.598 ms
12  211.151.111.30 (211.151.111.30)  35.161 ms  35.938 ms  36.005 ms
```

记录按序列号从1开始，每个纪录就是一跳 ，每跳表示一个网关，我们看到每行有三个时间，单位是ms, 是探测数据包向每个网关发送三个数据包后，网关响应后返回的时间；

有时我们traceroute一台主机时，会看到有一些行是以星号表示的。出现这样的情况，可能是防火墙封掉了ICMP的返回信息，所以我们得不到什么相关的数据包返回数据。

有时我们在某一网关处延时比较长，有可能是某台网关比较阻塞，也可能是物理设备本身的原因。当然如果某台DNS出现问题时，不能解析主机名、域名时，也会 有延时长的现象；您可以加-n参数来避免DNS解析，以IP格式输出数据。

#### **tcpdump**

`tcpdump`是一个网络数据包嗅探器，用于抓取网络数据包，可以抓取网络数据包的源地址、目的地址、协议类型、数据包长度等信息。

**tcpdump 使用**

Android没有内置`tcpdump`，需要自己安装，同时要求手机root权限。

1. 下载 [tcpdump](https://www.tcpdump.org/linktypes.html)
2. 将 tcpdump 放入手机： `adb push ~/tcpdump /data/local/tcpdump`
3. 将 tcpdump 的权限变为可执行：`chmod +x tcpdump`
4. 开始抓包： 譬如 `/data/local/tcpdump -vv -s 0 -w /mnt/sdcard/pcapture.pcap`。其中 `"-s 0"` 表示每个包都抓取全部长度，而不是部分长度；`"-w /mnt/sdcard/pcapture.pcap"` 表示抓取的包写入指定文件；`"-vv"` 表示显示多一些信息，如果要显示更多信息可以用 `"-vvv"`
5. 按下 `"contrl+c"` 结束抓包。
6. 将`"/mnt/sdcard/pcapture.pcap"`  拉取到电脑上： `adb pull /mnt/sdcard/pcapture.pcap <指定目录>`
7. 通过 `Wireshark` 或者 `charles`进行分析。

上面是步骤比较繁琐，每次都需要抓包后都需要拉取到电脑上，有没有办法直接在电脑上抓去手机的包呢？答案是有的，我们可以使用 `adb forward` 命令将手机的端口转发到电脑上。基本思路如下图

![](./assets/1625938-59c2d00b9c46c609.webp)

1. 手机开始抓包:在 adb shell 中运行 `/data/local/tcpdump -n -s 0 -w - | nc -l -p 12345`
2. 将手机抓的包传送到电脑的 Wireshark 中: 另开一个终端运行 `adb forward tcp:12345 tcp:12345 && nc 127.0.0.1 12345 | /Applications/Wireshark.app/Contents/MacOS/wireshark -k -S -i -`

这样就可以实时抓取手机的包了。

> 更多关于`tcpdump`的使用，可以参考 [tcpdump 使用指南](https://juejin.cn/post/6844904084168769549)




# 参考
[深入探索 Android 网络优化](https://juejin.cn/post/6844904182822993933)
[Android开发高手课](https://time.geekbang.org/column/article/77990)