# 网络优化
## 1. 何为网络优化

一个数据包从手机出发要经过无线网络、核心网络以及外部网络（互联网），才能到达我们的服务器。

![](./assets/3b27d9692bfc276aa16ac2e4c6effede.webp)

那整个网络请求的速度会跟哪些因素有关呢？

![](./assets/d39734690f1241262b0a289acdecbf4d.webp)

从上面这张图上看，客户端网络库实现、服务器性能以及网络链路的质量都是影响网络请求速度的因素。

如果说速度是关键，那对网络传输速度有决定性影响的主要有以下两个方面：

* **延迟**：数据从信息源发送到目的地所需的时间。
* **带宽**：逻辑或物理通信路径最大的吞吐量。

那延迟和带宽又跟什么因素有关呢？这里面涉及的因素也非常多，例如信号的强度、附近有没有基站、距离有多远等；还跟使用的网络制式，正在使用 3G、4G 还是 5G 网络有关，并且网络的拥塞情况也会产生影响，比如是不是在几万人聚集的大型活动场所等。

下面是不同网络制式的带宽和延迟的一般参考值。

![](./assets/368f97424661e9ee3295b8c610fb9b83.webp)

当出现上面说到的那些因素时，网络访问的带宽要大打折扣，延迟会加倍放大。而高延迟、低带宽的网络场景也就是我们常说的“弱网络”，它主要特点有：

![](./assets/773fa40290c39c0f7e402414273c8fd8.webp)

另外一个方面，不同的应用对延迟和带宽的侧重点可能不太一样。对于直播类应用或者“王者荣耀”来说，延迟会更重要一些；对腾讯视频、爱奇艺这种点播的应用来说，带宽会更加重要一些。**网络优化需要结合自己应用的实际情况来综合考虑。**

所谓的网络优化，究竟指的是什么？在我看来，核心内容有以下三个：

* **速度**。在网络正常或者良好的时候，怎样更好地利用带宽，进一步提升网络请求速度。
* **弱网络**。移动端网络复杂多变，在出现网络连接不稳定的时候，怎样最大程度保证网络的连通性。
* **安全**。网络安全不容忽视，怎样有效防止被第三方劫持、窃听甚至篡改。

那对于速度、弱网络以及安全的优化，又该从哪些方面入手呢？首先你需要先搞清楚一个网络请求的整个过程。

![](./assets/8d6e833f2a6c6d1e8beeb92d4579c38b.webp)

从图上看到，整个网络请求主要分为几个步骤，而整个请求的耗时可以细分到每一个步骤里面。

* **DNS 解析**。通过 DNS 服务器，拿到对应域名的 IP 地址。在这个步骤，我们比较关注 DNS 解析耗时情况、运营商 LocalDNS 的劫持、DNS 调度这些问题。
* **创建连接**。跟服务器建立连接，这里包括 TCP 三次握手、TLS 密钥协商等工作。多个 IP/ 端口该如何选择、是否要使用 HTTPS、能否可以减少甚至省下创建连接的时间，这些问题都是我们优化的关键。
* **发送 / 接收数据**。在成功建立连接之后，就可以愉快地跟服务器交互，进行组装数据、发送数据、接收数据、解析数据。我们关注的是，如何根据网络状况将带宽利用好，怎么样快速地侦测到网络延时，在弱网络下如何调整包大小等问题。
* **关闭连接**。连接的关闭看起来非常简单，其实这里的水也很深。这里主要关注主动关闭和被动关闭两种情况，一般我们都希望客户端可以主动关闭连接。

所谓的网络优化，就是围绕速度、弱网络、安全这三个核心内容，减少每一个步骤的耗时，打造快速、稳定且安全的高质量网络。

## 2. 网络性能测量
对于网络来说，我们关心的是下面这些指标：
* **吞吐量**：网络接口接收和传输的每秒字节数。
* **延迟**：系统调用发送 / 接收延时、连接延迟、首包延迟、网络往返时间等。
* **连接数**：每秒的连接数。
* **错误**：丢包计数、超时等。


# 参考
[深入探索 Android 网络优化](https://juejin.cn/post/6844904182822993933)
[Android开发高手课](https://time.geekbang.org/column/article/77990)